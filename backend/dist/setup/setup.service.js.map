{"version":3,"sources":["../../src/setup/setup.service.ts"],"sourcesContent":["import { Injectable, BadRequestException, Inject } from '@nestjs/common';\nimport { NodePgDatabase } from 'drizzle-orm/node-postgres';\nimport { eq } from 'drizzle-orm';\nimport * as bcrypt from 'bcryptjs';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { users } from '../database/schema/users';\n\n@Injectable()\nexport class SetupService {\n  constructor(\n    @Inject(DATABASE_CONNECTION)\n    private readonly db: NodePgDatabase<any>,\n  ) {}\n\n  async quickSetup() {\n    // Only allow in development\n    if (process.env.NODE_ENV === 'production') {\n      throw new BadRequestException('Quick setup is disabled in production');\n    }\n\n    const defaultAccounts = [\n      {\n        email: 'admin@howitworks.app',\n        password: 'Admin@123',\n        firstName: 'Admin',\n        lastName: 'User',\n        role: 'admin' as const,\n        phoneNumber: '+2348012345678',\n      },\n      {\n        email: 'facilitator@howitworks.app',\n        password: 'Facilitator@123',\n        firstName: 'John',\n        lastName: 'Facilitator',\n        role: 'facilitator' as const,\n        phoneNumber: '+2348087654321',\n      },\n    ];\n\n    const createdAccounts: Array<{\n      role: 'admin' | 'facilitator';\n      email: string;\n      password: string;\n      status: string;\n    }> = [];\n    \n    const existingAccounts: Array<{\n      role: 'admin' | 'facilitator';\n      email: string;\n      status: string;\n    }> = [];\n\n    for (const account of defaultAccounts) {\n      // Check if user already exists\n      const [existingUser] = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.email, account.email))\n        .limit(1);\n\n      if (existingUser) {\n        existingAccounts.push({\n          role: account.role,\n          email: account.email,\n          status: 'already_exists',\n        });\n        continue;\n      }\n\n      // Hash password\n      const hashedPassword = await bcrypt.hash(account.password, 12);\n\n      // Create user\n      const [newUser] = await this.db\n        .insert(users)\n        .values({\n          email: account.email,\n          password: hashedPassword,\n          firstName: account.firstName,\n          lastName: account.lastName,\n          role: account.role,\n          phoneNumber: account.phoneNumber,\n          isActive: true,\n          isEmailVerified: true,\n        })\n        .returning();\n\n      createdAccounts.push({\n        role: account.role,\n        email: account.email,\n        password: account.password,\n        status: 'created',\n      });\n    }\n\n    return {\n      success: true,\n      message: 'Quick setup completed',\n      created: createdAccounts,\n      existing: existingAccounts,\n      warning: 'Change these passwords immediately in production!',\n    };\n  }\n\n  async createAccount(accountData: {\n    firstName: string;\n    lastName: string;\n    email: string;\n    password: string;\n    phoneNumber: string;\n    role: 'admin' | 'facilitator';\n  }) {\n    // Validate role\n    if (!['admin', 'facilitator'].includes(accountData.role)) {\n      throw new BadRequestException('Role must be either admin or facilitator');\n    }\n\n    // Check if user already exists\n    const [existingUser] = await this.db\n      .select()\n      .from(users)\n      .where(eq(users.email, accountData.email))\n      .limit(1);\n\n    if (existingUser) {\n      throw new BadRequestException('User with this email already exists');\n    }\n\n    // Validate password length\n    if (accountData.password.length < 6) {\n      throw new BadRequestException('Password must be at least 6 characters');\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(accountData.password, 12);\n\n    // Create user\n    const [newUser] = await this.db\n      .insert(users)\n      .values({\n        email: accountData.email,\n        password: hashedPassword,\n        firstName: accountData.firstName,\n        lastName: accountData.lastName,\n        role: accountData.role,\n        phoneNumber: accountData.phoneNumber,\n        isActive: true,\n        isEmailVerified: true,\n      })\n      .returning();\n\n    return {\n      success: true,\n      message: `${accountData.role.charAt(0).toUpperCase() + accountData.role.slice(1)} account created successfully`,\n      account: {\n        id: newUser.id,\n        email: newUser.email,\n        firstName: newUser.firstName,\n        lastName: newUser.lastName,\n        role: newUser.role,\n        phoneNumber: newUser.phoneNumber,\n      },\n    };\n  }\n}\n"],"names":["SetupService","quickSetup","process","env","NODE_ENV","BadRequestException","defaultAccounts","email","password","firstName","lastName","role","phoneNumber","createdAccounts","existingAccounts","account","existingUser","db","select","from","users","where","eq","limit","push","status","hashedPassword","bcrypt","hash","newUser","insert","values","isActive","isEmailVerified","returning","success","message","created","existing","warning","createAccount","accountData","includes","length","charAt","toUpperCase","slice","id"],"mappings":"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"}