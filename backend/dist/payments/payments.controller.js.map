{"version":3,"sources":["../../src/payments/payments.controller.ts"],"sourcesContent":["import { Controller, Get, Post, Param, Body, UseGuards, Request } from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { PaymentsService } from './payments.service';\nimport { PaystackService } from './paystack.service';\nimport { InitializePaymentDto, VerifyPaymentDto, PaymentWebhookDto } from './dto/payment.dto';\n\n@ApiTags('payments')\n@Controller('payments')\n@UseGuards(JwtAuthGuard)\n@ApiBearerAuth()\nexport class PaymentsController {\n    constructor(\n        private readonly paymentsService: PaymentsService,\n        private readonly paystackService: PaystackService\n    ) {}\n\n    @Get('my-payments')\n    @ApiOperation({ summary: 'Get current user payments (tenant)' })\n    @ApiResponse({ status: 200, description: 'Payments retrieved successfully' })\n    async getMyPayments(@Request() req: any) {\n        const payments = await this.paymentsService.getTenantPayments(req.user.id);\n\n        return {\n            success: true,\n            data: payments,\n        };\n    }\n\n    @Get('landlord-payments')\n    @ApiOperation({ summary: 'Get all payments for landlord' })\n    @ApiResponse({ status: 200, description: 'Payments retrieved successfully' })\n    async getLandlordPayments(@Request() req: any) {\n        const payments = await this.paymentsService.getLandlordPayments(req.user.id);\n\n        return {\n            success: true,\n            data: payments,\n        };\n    }\n\n    @Get('upcoming')\n    @ApiOperation({ summary: 'Get upcoming payments for landlord' })\n    @ApiResponse({ status: 200, description: 'Upcoming payments retrieved successfully' })\n    async getUpcomingPayments(@Request() req: any) {\n        const payments = await this.paymentsService.getUpcomingPayments(req.user.id);\n\n        return {\n            success: true,\n            data: payments,\n        };\n    }\n\n    @Get('overdue')\n    @ApiOperation({ summary: 'Get overdue payments for landlord' })\n    @ApiResponse({ status: 200, description: 'Overdue payments retrieved successfully' })\n    async getOverduePayments(@Request() req: any) {\n        const payments = await this.paymentsService.getOverduePayments(req.user.id);\n\n        return {\n            success: true,\n            data: payments,\n        };\n    }\n\n    @Post(':id/process')\n    @ApiOperation({ summary: 'Process a payment' })\n    @ApiResponse({ status: 200, description: 'Payment processed successfully' })\n    async processPayment(\n        @Param('id') paymentId: string,\n        @Body() paymentData: {\n            amount: number;\n            paymentMethod?: string;\n            notes?: string;\n        },\n        @Request() req: any\n    ) {\n        const result = await this.paymentsService.processPayment(\n            paymentId,\n            paymentData.amount,\n            paymentData.paymentMethod,\n            paymentData.notes\n        );\n\n        return {\n            success: true,\n            data: result,\n        };\n    }\n\n    @Post('update-overdue')\n    @ApiOperation({ summary: 'Update overdue payments status' })\n    @ApiResponse({ status: 200, description: 'Overdue payments updated successfully' })\n    async updateOverduePayments() {\n        const result = await this.paymentsService.updateOverduePayments();\n\n        return {\n            success: true,\n            data: result,\n        };\n    }\n\n    // Paystack Integration Endpoints\n\n    @Post('paystack/initialize')\n    @ApiOperation({ summary: 'Initialize Paystack payment' })\n    @ApiResponse({ status: 200, description: 'Payment initialized successfully' })\n    async initializePayment(@Body() initializePaymentDto: InitializePaymentDto, @Request() req: any) {\n        const reference = this.paystackService.generateReference();\n        \n        const result = await this.paystackService.initializeTransaction({\n            email: initializePaymentDto.email,\n            amount: initializePaymentDto.amount,\n            currency: initializePaymentDto.currency,\n            reference: reference,\n            metadata: {\n                userId: req.user.id,\n                userRole: req.user.role,\n                description: initializePaymentDto.description,\n                ...initializePaymentDto.metadata,\n            },\n        });\n\n        return result;\n    }\n\n    @Post('paystack/verify')\n    @ApiOperation({ summary: 'Verify Paystack payment' })\n    @ApiResponse({ status: 200, description: 'Payment verified successfully' })\n    async verifyPayment(@Body() verifyPaymentDto: VerifyPaymentDto, @Request() req: any) {\n        const result = await this.paystackService.verifyTransaction(verifyPaymentDto.reference);\n\n        if (result.status && result.data && result.data.status === 'success') {\n            // Save payment to database\n            try {\n                await this.paymentsService.recordPayment({\n                    tenantId: req.user.id,\n                    amount: result.data.amount,\n                    reference: result.data.reference,\n                    paymentMethod: 'paystack',\n                    status: 'paid',\n                    paidAt: new Date(result.data.paid_at),\n                    metadata: result.data,\n                });\n            } catch (error) {\n                console.error('Error recording payment:', error);\n            }\n        }\n\n        return result;\n    }\n\n    @Post('paystack/webhook')\n    @ApiOperation({ summary: 'Paystack webhook endpoint' })\n    @ApiResponse({ status: 200, description: 'Webhook processed successfully' })\n    async handleWebhook(@Body() webhookData: PaymentWebhookDto) {\n        console.log('Paystack webhook received:', webhookData.event);\n\n        if (webhookData.event === 'charge.success' && webhookData.data) {\n            const paymentData = webhookData.data;\n\n            try {\n                // Record successful payment\n                if (paymentData.metadata?.userId && paymentData.reference) {\n                    await this.paymentsService.recordPayment({\n                        tenantId: paymentData.metadata.userId,\n                        amount: paymentData.amount / 100, // Convert from kobo\n                        reference: paymentData.reference,\n                        paymentMethod: 'paystack',\n                        status: 'paid',\n                        paidAt: new Date(paymentData.paid_at),\n                        metadata: paymentData,\n                    });\n\n                    console.log('Payment recorded successfully:', paymentData.reference);\n                } else {\n                    console.error('Invalid webhook data: missing userId or reference');\n                }\n            } catch (error) {\n                console.error('Error processing webhook:', error);\n            }\n        }\n\n        return { status: 'success' };\n    }\n}"],"names":["PaymentsController","getMyPayments","req","payments","paymentsService","getTenantPayments","user","id","success","data","getLandlordPayments","getUpcomingPayments","getOverduePayments","processPayment","paymentId","paymentData","result","amount","paymentMethod","notes","updateOverduePayments","initializePayment","initializePaymentDto","reference","paystackService","generateReference","initializeTransaction","email","currency","metadata","userId","userRole","role","description","verifyPayment","verifyPaymentDto","verifyTransaction","status","recordPayment","tenantId","paidAt","Date","paid_at","error","console","handleWebhook","webhookData","log","event","summary"],"mappings":"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"}