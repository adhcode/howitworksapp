{"version":3,"sources":["../../src/payments/paystack.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\n\nconst paystack = require('paystack')(process.env.PAYSTACK_SECRET_KEY);\n\n@Injectable()\nexport class PaystackService {\n  private paystack: any;\n\n  constructor(private configService: ConfigService) {\n    const secretKey = this.configService.get<string>('PAYSTACK_SECRET_KEY');\n    if (secretKey) {\n      this.paystack = require('paystack')(secretKey);\n    }\n  }\n\n  async initializeTransaction(data: {\n    email: string;\n    amount: number; // Amount in kobo (multiply by 100)\n    currency?: string;\n    reference?: string;\n    callback_url?: string;\n    metadata?: any;\n  }) {\n    try {\n      const response = await this.paystack.transaction.initialize({\n        email: data.email,\n        amount: Math.round(data.amount * 100), // Convert to kobo\n        currency: data.currency || 'NGN',\n        reference: data.reference,\n        callback_url: data.callback_url,\n        metadata: data.metadata,\n      });\n\n      return {\n        status: true,\n        data: {\n          authorization_url: response.data.authorization_url,\n          access_code: response.data.access_code,\n          reference: response.data.reference,\n        },\n      };\n    } catch (error) {\n      console.error('Paystack initialization error:', error);\n      return {\n        status: false,\n        message: error.message || 'Failed to initialize payment',\n      };\n    }\n  }\n\n  async verifyTransaction(reference: string) {\n    try {\n      const response = await this.paystack.transaction.verify(reference);\n      \n      return {\n        status: response.status,\n        data: {\n          id: response.data.id,\n          domain: response.data.domain,\n          status: response.data.status,\n          reference: response.data.reference,\n          amount: response.data.amount / 100, // Convert back from kobo\n          gateway_response: response.data.gateway_response,\n          paid_at: response.data.paid_at,\n          created_at: response.data.created_at,\n          channel: response.data.channel,\n          currency: response.data.currency,\n          customer: response.data.customer,\n          metadata: response.data.metadata,\n        },\n      };\n    } catch (error) {\n      console.error('Paystack verification error:', error);\n      return {\n        status: false,\n        message: error.message || 'Failed to verify payment',\n      };\n    }\n  }\n\n  async createCustomer(data: {\n    email: string;\n    first_name: string;\n    last_name: string;\n    phone?: string;\n    metadata?: any;\n  }) {\n    try {\n      const response = await this.paystack.customer.create({\n        email: data.email,\n        first_name: data.first_name,\n        last_name: data.last_name,\n        phone: data.phone,\n        metadata: data.metadata,\n      });\n\n      return {\n        status: true,\n        data: {\n          id: response.data.id,\n          customer_code: response.data.customer_code,\n          email: response.data.email,\n        },\n      };\n    } catch (error) {\n      console.error('Paystack customer creation error:', error);\n      return {\n        status: false,\n        message: error.message || 'Failed to create customer',\n      };\n    }\n  }\n\n  async listTransactions(params?: {\n    perPage?: number;\n    page?: number;\n    customer?: string;\n    status?: 'failed' | 'success' | 'abandoned';\n    from?: string;\n    to?: string;\n  }) {\n    try {\n      const response = await this.paystack.transaction.list(params);\n      \n      return {\n        status: true,\n        data: response.data.map((transaction: any) => ({\n          id: transaction.id,\n          reference: transaction.reference,\n          amount: transaction.amount / 100,\n          status: transaction.status,\n          gateway_response: transaction.gateway_response,\n          paid_at: transaction.paid_at,\n          created_at: transaction.created_at,\n          customer: transaction.customer,\n          metadata: transaction.metadata,\n        })),\n        meta: response.meta,\n      };\n    } catch (error) {\n      console.error('Paystack list transactions error:', error);\n      return {\n        status: false,\n        message: error.message || 'Failed to fetch transactions',\n      };\n    }\n  }\n\n  generateReference(): string {\n    const timestamp = Date.now();\n    const random = Math.random().toString(36).substring(2, 15);\n    return `homezy_${timestamp}_${random}`;\n  }\n}\n\n\n\n\n"],"names":["PaystackService","paystack","require","process","env","PAYSTACK_SECRET_KEY","initializeTransaction","data","response","transaction","initialize","email","amount","Math","round","currency","reference","callback_url","metadata","status","authorization_url","access_code","error","console","message","verifyTransaction","verify","id","domain","gateway_response","paid_at","created_at","channel","customer","createCustomer","create","first_name","last_name","phone","customer_code","listTransactions","params","list","map","meta","generateReference","timestamp","Date","now","random","toString","substring","configService","secretKey","get"],"mappings":"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"}