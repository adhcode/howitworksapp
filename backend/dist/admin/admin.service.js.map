{"version":3,"sources":["../../src/admin/admin.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, ConflictException, Inject } from '@nestjs/common';\nimport { eq, and, or, ilike, count, sql, inArray } from 'drizzle-orm';\nimport { NodePgDatabase } from 'drizzle-orm/node-postgres';\nimport * as bcrypt from 'bcryptjs';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { users } from '../database/schema/users';\nimport { properties, units } from '../database/schema/properties';\nimport { payments } from '../database/schema/payments';\nimport { maintenanceRequests, messages } from '../database/schema/messages';\nimport { leases } from '../database/schema/leases';\nimport { tenantInvitations } from '../database/schema/tenant-invitations';\nimport { CreateUserDto, UpdateUserDto } from './dto/admin.dto';\n\n@Injectable()\nexport class AdminService {\n  constructor(\n    @Inject(DATABASE_CONNECTION)\n    private readonly db: NodePgDatabase<any>,\n  ) {}\n\n  async getDashboardStats() {\n    try {\n      console.log('üîç Fetching real dashboard stats from database...');\n      \n      // Get user counts by role (only query for roles that exist in database)\n      const [userStats] = await this.db\n        .select({\n          totalLandlords: sql<number>`count(case when role = 'landlord' then 1 end)`,\n          totalTenants: sql<number>`count(case when role = 'tenant' then 1 end)`,\n          totalAdmins: sql<number>`count(case when role = 'admin' then 1 end)`,\n        })\n        .from(users);\n\n      // Get property stats\n      const [propertyStats] = await this.db\n        .select({\n          totalProperties: count(),\n        })\n        .from(properties);\n\n      // Get actual units count from units table (not from properties.totalUnits)\n      const [unitsStats] = await this.db\n        .select({\n          totalUnits: count(),\n        })\n        .from(units);\n\n      // Get occupied units (units with accepted tenant invitations)\n      const [occupiedUnitsStats] = await this.db\n        .select({\n          occupiedUnits: count(),\n        })\n        .from(tenantInvitations)\n        .where(eq(tenantInvitations.status, 'accepted'));\n\n      // TODO: Get more complex stats from other tables when available:\n      // - totalRentCollected from payments table  \n      // - pendingPayments from payments table\n      // - activeMaintenanceRequests from maintenance_requests table\n\n      // Get facilitator stats\n      const [facilitatorStats] = await this.db\n        .select({\n          totalFacilitators: sql<number>`count(case when role = 'facilitator' then 1 end)`,\n          activeFacilitators: sql<number>`count(case when role = 'facilitator' and is_active = true then 1 end)`,\n        })\n        .from(users);\n\n      // Get properties with facilitators assigned\n      const [facilitatorPropertyStats] = await this.db\n        .select({\n          propertiesWithFacilitators: sql<number>`count(case when facilitator_id is not null then 1 end)`,\n        })\n        .from(properties);\n\n      const totalUnits = Number(unitsStats?.totalUnits || 0);\n      const occupiedUnits = Number(occupiedUnitsStats?.occupiedUnits || 0);\n\n      const stats = {\n        totalProperties: Number(propertyStats?.totalProperties || 0),\n        totalLandlords: Number(userStats?.totalLandlords || 0),\n        totalTenants: Number(userStats?.totalTenants || 0),\n        totalFacilitators: Number(facilitatorStats?.totalFacilitators || 0),\n        activeFacilitators: Number(facilitatorStats?.activeFacilitators || 0),\n        propertiesWithFacilitators: Number(facilitatorPropertyStats?.propertiesWithFacilitators || 0),\n        totalUnits, // Count from actual units table\n        occupiedUnits, // Count units with accepted tenant invitations\n        vacantUnits: totalUnits - occupiedUnits, // Calculate vacant units\n        totalRentCollected: 0, // TODO: Calculate from payments table when available\n        pendingPayments: 0, // TODO: Calculate from payments table when available\n        activeMaintenanceRequests: 0, // TODO: Calculate from maintenance_requests table when available\n      };\n      \n      console.log('üìä Real dashboard stats from database:', stats);\n      return stats;\n    } catch (error) {\n      console.error('Error fetching dashboard stats:', error);\n      // Fall back to basic stats if database query fails\n      return {\n        totalProperties: 0,\n        totalLandlords: 0,\n        totalTenants: 0,\n        totalFacilitators: 0,\n        totalUnits: 0,\n        occupiedUnits: 0,\n        vacantUnits: 0,\n        totalRentCollected: 0,\n        pendingPayments: 0,\n        activeMaintenanceRequests: 0,\n      };\n    }\n  }\n\n  async getRevenueAnalytics(timeframe: string = '12m') {\n    try {\n      console.log('üîç Fetching real revenue analytics from database...');\n      \n      // Get current date and calculate timeframe\n      const now = new Date();\n      const monthsBack = parseInt(timeframe.replace('m', '')) || 12;\n      const startDate = new Date(now.getFullYear(), now.getMonth() - monthsBack + 1, 1);\n      \n      console.log(`Querying revenue data from ${startDate.toISOString()} to ${now.toISOString()}`);\n      \n      // Query payments by month for the specified timeframe\n      const revenueData = await this.db\n        .select({\n          month: sql<string>`TO_CHAR(paid_date, 'Mon')`,\n          year: sql<number>`EXTRACT(YEAR FROM paid_date)`,\n          amount: sql<number>`COALESCE(SUM(amount_paid), 0)`,\n        })\n        .from(payments)\n        .where(\n          and(\n            sql`paid_date >= ${startDate}`,\n            sql`paid_date <= ${now}`,\n            eq(payments.status, 'paid')\n          )\n        )\n        .groupBy(sql`DATE_TRUNC('month', paid_date)`, sql`TO_CHAR(paid_date, 'Mon')`, sql`EXTRACT(YEAR FROM paid_date)`)\n        .orderBy(sql`DATE_TRUNC('month', paid_date)`);\n\n      console.log('üìä Revenue analytics data:', revenueData);\n\n      // If no data, return empty array\n      if (revenueData.length === 0) {\n        console.log('No payment data found, returning empty array');\n        return { monthlyData: [] };\n      }\n\n      return {\n        monthlyData: revenueData.map(row => ({\n          month: row.month,\n          amount: Number(row.amount),\n        }))\n      };\n    } catch (error) {\n      console.error('Error fetching revenue analytics:', error);\n      // Return empty data instead of throwing error\n      return { monthlyData: [] };\n    }\n  }\n\n  async getMaintenanceAnalytics(timeframe: string = '12m') {\n    try {\n      console.log('üîç Fetching real maintenance analytics from database...');\n      \n      // Get current date and calculate timeframe\n      const now = new Date();\n      const monthsBack = parseInt(timeframe.replace('m', '')) || 12;\n      const startDate = new Date(now.getFullYear(), now.getMonth() - monthsBack + 1, 1);\n      \n      console.log(`Querying maintenance data from ${startDate.toISOString()} to ${now.toISOString()}`);\n      \n      // Query maintenance requests by month and status for the specified timeframe\n      const maintenanceData = await this.db\n        .select({\n          month: sql<string>`TO_CHAR(created_at, 'Mon')`,\n          year: sql<number>`EXTRACT(YEAR FROM created_at)`,\n          pending: sql<number>`COUNT(CASE WHEN status = 'pending' THEN 1 END)`,\n          inProgress: sql<number>`COUNT(CASE WHEN status = 'in_progress' THEN 1 END)`,\n          completed: sql<number>`COUNT(CASE WHEN status = 'completed' THEN 1 END)`,\n          cancelled: sql<number>`COUNT(CASE WHEN status = 'cancelled' THEN 1 END)`,\n        })\n        .from(maintenanceRequests)\n        .where(\n          and(\n            sql`created_at >= ${startDate}`,\n            sql`created_at <= ${now}`\n          )\n        )\n        .groupBy(sql`DATE_TRUNC('month', created_at)`, sql`TO_CHAR(created_at, 'Mon')`, sql`EXTRACT(YEAR FROM created_at)`)\n        .orderBy(sql`DATE_TRUNC('month', created_at)`);\n\n      console.log('üìä Maintenance analytics data:', maintenanceData);\n\n      // If no data, return empty array\n      if (maintenanceData.length === 0) {\n        console.log('No maintenance request data found, returning empty array');\n        return { monthlyData: [] };\n      }\n\n      return {\n        monthlyData: maintenanceData.map(row => ({\n          month: row.month,\n          open: Number(row.pending), // Map \"pending\" to \"open\" for frontend compatibility\n          inProgress: Number(row.inProgress),\n          resolved: Number(row.completed), // Map \"completed\" to \"resolved\" for frontend compatibility\n        }))\n      };\n    } catch (error) {\n      console.error('Error fetching maintenance analytics:', error);\n      // Return empty data instead of throwing error\n      return { monthlyData: [] };\n    }\n  }\n\n\n\n  async getUsers(options: {\n    page: number;\n    limit: number;\n    role?: string;\n    search?: string;\n  }) {\n    const { page, limit, role, search } = options;\n    const offset = (page - 1) * limit;\n\n    try {\n      // Build where condition\n      let finalWhereCondition;\n      \n      if (role && search) {\n        finalWhereCondition = and(\n          eq(users.role, role as any),\n          sql`${users.firstName} ILIKE ${`%${search}%`} OR ${users.lastName} ILIKE ${`%${search}%`} OR ${users.email} ILIKE ${`%${search}%`}`\n        );\n      } else if (role) {\n        finalWhereCondition = eq(users.role, role as any);\n      } else if (search) {\n        finalWhereCondition = sql`${users.firstName} ILIKE ${`%${search}%`} OR ${users.lastName} ILIKE ${`%${search}%`} OR ${users.email} ILIKE ${`%${search}%`}`;\n      } else {\n        finalWhereCondition = undefined;\n      }\n\n      // Execute queries\n      const dataQuery = this.db\n        .select()\n        .from(users)\n        .where(finalWhereCondition)\n        .limit(limit)\n        .offset(offset)\n        .orderBy(users.createdAt);\n\n      const countQuery = this.db\n        .select({ count: count() })\n        .from(users)\n        .where(finalWhereCondition);\n\n      const [data, totalResult] = await Promise.all([\n        dataQuery,\n        countQuery,\n      ]);\n\n      const total = totalResult[0]?.count || 0;\n\n      // If fetching landlords, add properties count for each\n      let enrichedData = data.map(user => {\n        const { password, ...userWithoutPassword } = user;\n        return userWithoutPassword;\n      });\n\n      if (role === 'landlord') {\n        // Get properties count for each landlord\n        const landlordIds = enrichedData.map(u => u.id);\n        if (landlordIds.length > 0) {\n          const propertiesCounts = await this.db\n            .select({\n              landlordId: properties.landlordId,\n              count: count(),\n            })\n            .from(properties)\n            .where(inArray(properties.landlordId, landlordIds))\n            .groupBy(properties.landlordId);\n\n          const countsMap = new Map(propertiesCounts.map(pc => [pc.landlordId, Number(pc.count)]));\n          \n          enrichedData = enrichedData.map(user => ({\n            ...user,\n            propertiesCount: countsMap.get(user.id) || 0,\n          }));\n        } else {\n          enrichedData = enrichedData.map(user => ({\n            ...user,\n            propertiesCount: 0,\n          }));\n        }\n      }\n\n      return {\n        data: enrichedData,\n        meta: {\n          page,\n          limit,\n          total: Number(total),\n          totalPages: Math.ceil(Number(total) / limit),\n        },\n      };\n    } catch (error) {\n      console.error('Error fetching users:', error);\n      throw error;\n    }\n  }\n\n  async createUser(createUserDto: CreateUserDto) {\n    try {\n      // Check if user already exists\n      const existingUser = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.email, createUserDto.email))\n        .limit(1);\n\n      if (existingUser.length > 0) {\n        throw new ConflictException('User with this email already exists');\n      }\n\n      // Hash password\n      const hashedPassword = await bcrypt.hash(createUserDto.password, 12);\n\n      // Create user\n      const [newUser] = await this.db\n        .insert(users)\n        .values({\n          ...createUserDto,\n          password: hashedPassword,\n          isEmailVerified: true, // Admin-created users are auto-verified\n        })\n        .returning();\n\n      const { password, ...userWithoutPassword } = newUser;\n      return userWithoutPassword;\n    } catch (error) {\n      console.error('Error creating user:', error);\n      throw error;\n    }\n  }\n\n  async getUserById(id: string) {\n    try {\n      const [user] = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.id, id))\n        .limit(1);\n\n      if (!user) {\n        throw new NotFoundException('User not found');\n      }\n\n      const { password, ...userWithoutPassword } = user;\n      return userWithoutPassword;\n    } catch (error) {\n      console.error('Error fetching user:', error);\n      throw error;\n    }\n  }\n\n  async updateUser(id: string, updateUserDto: UpdateUserDto) {\n    try {\n      const [updatedUser] = await this.db\n        .update(users)\n        .set({\n          ...updateUserDto,\n          updatedAt: new Date(),\n        })\n        .where(eq(users.id, id))\n        .returning();\n\n      if (!updatedUser) {\n        throw new NotFoundException('User not found');\n      }\n\n      const { password, ...userWithoutPassword } = updatedUser;\n      return userWithoutPassword;\n    } catch (error) {\n      console.error('Error updating user:', error);\n      throw error;\n    }\n  }\n\n  async deleteUser(id: string) {\n    try {\n      const [deletedUser] = await this.db\n        .delete(users)\n        .where(eq(users.id, id))\n        .returning();\n\n      if (!deletedUser) {\n        throw new NotFoundException('User not found');\n      }\n\n      return { message: 'User deleted successfully' };\n    } catch (error) {\n      console.error('Error deleting user:', error);\n      throw error;\n    }\n  }\n\n  async toggleUserStatus(id: string) {\n    try {\n      // First get the current user\n      const [currentUser] = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.id, id))\n        .limit(1);\n\n      if (!currentUser) {\n        throw new NotFoundException('User not found');\n      }\n\n      // Toggle the status\n      const [updatedUser] = await this.db\n        .update(users)\n        .set({\n          isActive: !currentUser.isActive,\n          updatedAt: new Date(),\n        })\n        .where(eq(users.id, id))\n        .returning();\n\n      const { password, ...userWithoutPassword } = updatedUser;\n      return userWithoutPassword;\n    } catch (error) {\n      console.error('Error toggling user status:', error);\n      throw error;\n    }\n  }\n\n  async getProperties(options: {\n    page: number;\n    limit: number;\n    search?: string;\n  }) {\n    const { page, limit, search } = options;\n    const offset = (page - 1) * limit;\n\n    try {\n      // Build where condition for search\n      const searchCondition = search \n        ? sql`${properties.name} ILIKE ${`%${search}%`} OR ${properties.address} ILIKE ${`%${search}%`}`\n        : undefined;\n\n      // Execute queries with facilitator join\n      const landlordAlias = users;\n      const facilitatorAlias = sql`facilitator`;\n      \n      const dataQuery = this.db\n        .select({\n          id: properties.id,\n          name: properties.name,\n          address: properties.address,\n          city: properties.city,\n          state: properties.state,\n          country: properties.country,\n          propertyType: properties.propertyType,\n          totalUnits: properties.totalUnits,\n          description: properties.description,\n          images: properties.images,\n          amenities: properties.amenities,\n          status: properties.status,\n          landlordId: properties.landlordId,\n          facilitatorId: properties.facilitatorId,\n          createdAt: properties.createdAt,\n          updatedAt: properties.updatedAt,\n          landlordName: sql<string>`${landlordAlias.firstName} || ' ' || ${landlordAlias.lastName}`,\n          landlordEmail: landlordAlias.email,\n          facilitatorName: sql<string>`facilitator.first_name || ' ' || facilitator.last_name`,\n          facilitatorEmail: sql<string>`facilitator.email`,\n        })\n        .from(properties)\n        .leftJoin(landlordAlias, eq(properties.landlordId, landlordAlias.id))\n        .leftJoin(sql`users AS facilitator`, sql`${properties.facilitatorId} = facilitator.id`)\n        .where(searchCondition)\n        .limit(limit)\n        .offset(offset)\n        .orderBy(properties.createdAt);\n\n      const countQuery = this.db\n        .select({ count: count() })\n        .from(properties)\n        .where(searchCondition);\n\n      const [data, totalResult] = await Promise.all([\n        dataQuery,\n        countQuery,\n      ]);\n\n      const total = totalResult[0]?.count || 0;\n\n      return {\n        data,\n        meta: {\n          page,\n          limit,\n          total: Number(total),\n          totalPages: Math.ceil(Number(total) / limit),\n        },\n      };\n    } catch (error) {\n      console.error('Error fetching properties:', error);\n      throw error;\n    }\n  }\n\n  async assignFacilitatorToProperty(propertyId: string, facilitatorId: string) {\n    try {\n      // Verify facilitator exists and has correct role\n      const [facilitator] = await this.db\n        .select()\n        .from(users)\n        .where(and(eq(users.id, facilitatorId), eq(users.role, 'facilitator')))\n        .limit(1);\n\n      if (!facilitator) {\n        throw new NotFoundException('Facilitator not found');\n      }\n\n      // Update property\n      const [updatedProperty] = await this.db\n        .update(properties)\n        .set({\n          facilitatorId,\n          updatedAt: new Date(),\n        })\n        .where(eq(properties.id, propertyId))\n        .returning();\n\n      if (!updatedProperty) {\n        throw new NotFoundException('Property not found');\n      }\n\n      return updatedProperty;\n    } catch (error) {\n      console.error('Error assigning facilitator to property:', error);\n      throw error;\n    }\n  }\n\n  async removeFacilitatorFromProperty(propertyId: string) {\n    try {\n      const [updatedProperty] = await this.db\n        .update(properties)\n        .set({\n          facilitatorId: null,\n          updatedAt: new Date(),\n        })\n        .where(eq(properties.id, propertyId))\n        .returning();\n\n      if (!updatedProperty) {\n        throw new NotFoundException('Property not found');\n      }\n\n      return updatedProperty;\n    } catch (error) {\n      console.error('Error removing facilitator from property:', error);\n      throw error;\n    }\n  }\n\n  // Analytics methods (mock implementations for now)\n  async getPropertyAnalytics(timeframe: string) {\n    // TODO: Implement real analytics based on timeframe\n    return {\n      totalProperties: 24,\n      newProperties: 3,\n      propertiesWithFacilitators: 18,\n      averageUnitsPerProperty: 6.5,\n    };\n  }\n\n  // Property Detail Methods\n  async getPropertyById(id: string) {\n    try {\n      const [property] = await this.db\n        .select({\n          id: properties.id,\n          name: properties.name,\n          address: properties.address,\n          city: properties.city,\n          state: properties.state,\n          country: properties.country,\n          propertyType: properties.propertyType,\n          totalUnits: properties.totalUnits,\n          description: properties.description,\n          images: properties.images,\n          amenities: properties.amenities,\n          status: properties.status,\n          landlordId: properties.landlordId,\n          facilitatorId: properties.facilitatorId,\n          createdAt: properties.createdAt,\n          updatedAt: properties.updatedAt,\n          landlord: {\n            id: users.id,\n            firstName: users.firstName,\n            lastName: users.lastName,\n            email: users.email,\n            phoneNumber: users.phoneNumber,\n          },\n        })\n        .from(properties)\n        .leftJoin(users, eq(properties.landlordId, users.id))\n        .where(eq(properties.id, id))\n        .limit(1);\n\n      if (!property) {\n        throw new NotFoundException('Property not found');\n      }\n\n      // Get facilitator info if assigned\n      let facilitator: {\n        id: string;\n        firstName: string;\n        lastName: string;\n        email: string;\n        phoneNumber: string;\n      } | null = null;\n      if (property.facilitatorId) {\n        const [facilitatorData] = await this.db\n          .select({\n            id: users.id,\n            firstName: users.firstName,\n            lastName: users.lastName,\n            email: users.email,\n            phoneNumber: users.phoneNumber,\n          })\n          .from(users)\n          .where(eq(users.id, property.facilitatorId))\n          .limit(1);\n        \n        facilitator = facilitatorData;\n      }\n\n      return {\n        ...property,\n        facilitator,\n      };\n    } catch (error) {\n      console.error('Error fetching property by ID:', error);\n      throw error;\n    }\n  }\n\n  async getPropertyUnits(propertyId: string) {\n    try {\n      // Query units with active lease information\n      const unitsData = await this.db\n        .select({\n          id: units.id,\n          unitNumber: units.unitNumber,\n          bedrooms: units.bedrooms,\n          bathrooms: units.bathrooms,\n          rent: units.rent,\n          isAvailable: units.isAvailable,\n          propertyId: units.propertyId,\n          // Lease information\n          tenantId: leases.tenantId,\n          leaseStatus: leases.status,\n          // Tenant information\n          tenantFirstName: users.firstName,\n          tenantLastName: users.lastName,\n        })\n        .from(units)\n        .leftJoin(\n          leases,\n          and(\n            eq(units.id, leases.unitId),\n            eq(leases.status, 'active')\n          )\n        )\n        .leftJoin(users, eq(leases.tenantId, users.id))\n        .where(eq(units.propertyId, propertyId))\n        .orderBy(units.unitNumber);\n\n      // Transform to match frontend expectations\n      return unitsData.map(unit => ({\n        id: unit.id,\n        unitNumber: unit.unitNumber,\n        status: unit.tenantId ? 'occupied' : 'vacant',\n        rentAmount: Number(unit.rent),\n        tenantId: unit.tenantId,\n        tenantName: unit.tenantFirstName && unit.tenantLastName \n          ? `${unit.tenantFirstName} ${unit.tenantLastName}`\n          : null,\n        propertyId: unit.propertyId,\n      }));\n    } catch (error) {\n      console.error('Error fetching property units:', error);\n      throw error;\n    }\n  }\n\n  async getPropertyTenants(propertyId: string) {\n    try {\n      // Query tenants with active leases for this property\n      const tenantsData = await this.db\n        .select({\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          phoneNumber: users.phoneNumber,\n          unitNumber: units.unitNumber,\n          monthlyRent: leases.monthlyRent,\n          leaseEndDate: leases.endDate,\n          leaseStatus: leases.status,\n        })\n        .from(leases)\n        .innerJoin(users, eq(leases.tenantId, users.id))\n        .innerJoin(units, eq(leases.unitId, units.id))\n        .where(\n          and(\n            eq(leases.propertyId, propertyId),\n            eq(leases.status, 'active')\n          )\n        )\n        .orderBy(units.unitNumber);\n\n      // Transform to match frontend expectations\n      // TODO: Calculate actual payment status from payments table\n      return tenantsData.map(tenant => ({\n        id: tenant.id,\n        firstName: tenant.firstName,\n        lastName: tenant.lastName,\n        email: tenant.email,\n        phoneNumber: tenant.phoneNumber,\n        unitNumber: tenant.unitNumber,\n        rentAmount: Number(tenant.monthlyRent),\n        leaseEndDate: tenant.leaseEndDate,\n        status: 'paid', // Default for now, should be calculated from payments\n      }));\n    } catch (error) {\n      console.error('Error fetching property tenants:', error);\n      throw error;\n    }\n  }\n\n  async getPropertyMaintenance(propertyId: string) {\n    try {\n      // Query maintenance requests for this property with tenant and unit info\n      const maintenanceData = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          status: maintenanceRequests.status,\n          priority: maintenanceRequests.priority,\n          images: maintenanceRequests.images,\n          createdAt: maintenanceRequests.createdAt,\n          completedAt: maintenanceRequests.completedAt,\n          tenantFirstName: sql<string>`tenant.first_name`,\n          tenantLastName: sql<string>`tenant.last_name`,\n          unitNumber: sql<string>`unit.unit_number`,\n          assignedToFirstName: sql<string>`assigned_admin.first_name`,\n          assignedToLastName: sql<string>`assigned_admin.last_name`,\n        })\n        .from(maintenanceRequests)\n        .leftJoin(sql`users AS tenant`, sql`${maintenanceRequests.tenantId} = tenant.id`)\n        .leftJoin(sql`leases AS active_lease`, sql`active_lease.tenant_id = tenant.id AND active_lease.property_id = ${propertyId} AND active_lease.status = 'active'`)\n        .leftJoin(sql`units AS unit`, sql`active_lease.unit_id = unit.id`)\n        .leftJoin(sql`users AS assigned_admin`, sql`${maintenanceRequests.assignedTo} = assigned_admin.id`)\n        .where(eq(maintenanceRequests.propertyId, propertyId))\n        .orderBy(sql`${maintenanceRequests.createdAt} DESC`);\n\n      // Transform the data to match frontend expectations\n      return maintenanceData.map(request => ({\n        id: request.id,\n        issue: request.title,\n        description: request.description,\n        status: request.status,\n        priority: request.priority || 'medium',\n        images: request.images || [],\n        tenant: request.tenantFirstName && request.tenantLastName \n          ? `${request.tenantFirstName} ${request.tenantLastName}` \n          : 'Unknown',\n        unit: request.unitNumber || 'N/A',\n        assignedAdmin: request.assignedToFirstName && request.assignedToLastName\n          ? `${request.assignedToFirstName} ${request.assignedToLastName}`\n          : 'Unassigned',\n        createdAt: request.createdAt,\n        resolvedAt: request.status === 'completed' ? request.completedAt : null,\n      }));\n    } catch (error) {\n      console.error('Error fetching property maintenance:', error);\n      return [];\n    }\n  }\n\n  async getPropertyPayments(propertyId: string) {\n    try {\n      // Query payments for this property with tenant and unit info\n      const paymentsData = await this.db\n        .select({\n          id: payments.id,\n          amount: payments.amount,\n          amountPaid: payments.amountPaid,\n          dueDate: payments.dueDate,\n          paidDate: payments.paidDate,\n          status: payments.status,\n          tenantFirstName: sql<string>`tenant.first_name`,\n          tenantLastName: sql<string>`tenant.last_name`,\n          unitNumber: units.unitNumber,\n        })\n        .from(payments)\n        .innerJoin(sql`users AS tenant`, sql`${payments.tenantId} = tenant.id`)\n        .innerJoin(units, eq(payments.unitId, units.id))\n        .where(eq(payments.propertyId, propertyId))\n        .orderBy(sql`${payments.dueDate} DESC`);\n\n      // Transform the data to match frontend expectations\n      return paymentsData.map(payment => {\n        const totalDue = Number(payment.amount);\n        const paid = Number(payment.amountPaid);\n        const balance = totalDue - paid;\n\n        return {\n          id: payment.id,\n          tenantName: `${payment.tenantFirstName} ${payment.tenantLastName}`,\n          unitNumber: payment.unitNumber,\n          totalDue,\n          paid,\n          balance,\n          status: payment.status,\n          dueDate: payment.dueDate,\n          lastPayment: payment.paidDate,\n        };\n      });\n    } catch (error) {\n      console.error('Error fetching property payments:', error);\n      return [];\n    }\n  }\n\n  async getAllMaintenanceRequests(filters: {\n    status?: string;\n    priority?: string;\n    page?: number;\n    limit?: number;\n  } = {}) {\n    try {\n      const { status, priority, page = 1, limit = 50 } = filters;\n      const offset = (page - 1) * limit;\n\n      // Build where conditions\n      const conditions: any[] = [];\n      if (status) {\n        conditions.push(eq(maintenanceRequests.status, status as any));\n      }\n      if (priority) {\n        conditions.push(eq(maintenanceRequests.priority, priority as any));\n      }\n\n      // First, let's try a simple query to see if we can get basic maintenance requests\n      console.log('üîç Fetching maintenance requests with filters:', { status, priority, page, limit });\n      \n      // Simple query first - just get maintenance requests with property info\n      const query = this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          status: maintenanceRequests.status,\n          priority: maintenanceRequests.priority,\n          images: maintenanceRequests.images,\n          createdAt: maintenanceRequests.createdAt,\n          completedAt: maintenanceRequests.completedAt,\n          propertyName: properties.name,\n          propertyId: properties.id,\n          tenantId: maintenanceRequests.tenantId,\n          landlordId: maintenanceRequests.landlordId,\n          assignedTo: maintenanceRequests.assignedTo,\n        })\n        .from(maintenanceRequests)\n        .innerJoin(properties, eq(maintenanceRequests.propertyId, properties.id))\n        .orderBy(sql`${maintenanceRequests.createdAt} DESC`)\n        .limit(limit)\n        .offset(offset);\n\n      const maintenanceData = conditions.length > 0 \n        ? await query.where(and(...conditions))\n        : await query;\n\n      console.log(`üìä Found ${maintenanceData.length} maintenance requests`);\n      console.log('Sample data:', maintenanceData.slice(0, 2));\n\n      // For now, let's get tenant and admin names separately to avoid complex joins\n      const transformedData: any[] = [];\n      \n      for (const request of maintenanceData) {\n        // Get tenant info and unit number\n        let tenantName = 'Unknown';\n        let unitNumber = 'N/A';\n        if (request.tenantId) {\n          try {\n            const [tenant] = await this.db\n              .select({\n                firstName: users.firstName,\n                lastName: users.lastName,\n              })\n              .from(users)\n              .where(eq(users.id, request.tenantId))\n              .limit(1);\n            \n            if (tenant) {\n              tenantName = `${tenant.firstName} ${tenant.lastName}`;\n            }\n\n            // Get the unit number for this tenant in this property\n            const [lease] = await this.db\n              .select({\n                unitNumber: units.unitNumber,\n              })\n              .from(leases)\n              .innerJoin(units, eq(leases.unitId, units.id))\n              .where(\n                and(\n                  eq(leases.tenantId, request.tenantId),\n                  eq(leases.propertyId, request.propertyId),\n                  eq(leases.status, 'active')\n                )\n              )\n              .limit(1);\n            \n            if (lease) {\n              unitNumber = lease.unitNumber;\n            }\n          } catch (error) {\n            console.error('Error fetching tenant/unit info:', error);\n          }\n        }\n\n        // Get assigned admin info\n        let assignedAdmin = 'Unassigned';\n        if (request.assignedTo) {\n          try {\n            const [admin] = await this.db\n              .select({\n                firstName: users.firstName,\n                lastName: users.lastName,\n              })\n              .from(users)\n              .where(eq(users.id, request.assignedTo))\n              .limit(1);\n            \n            if (admin) {\n              assignedAdmin = `${admin.firstName} ${admin.lastName}`;\n            }\n          } catch (error) {\n            console.error('Error fetching admin:', error);\n          }\n        }\n\n        // Get facilitator info from property\n        let facilitatorName = 'No facilitator assigned';\n        let facilitatorEmail: string | null = null;\n        let facilitatorPhone: string | null = null;\n        try {\n          const [property] = await this.db\n            .select({\n              facilitatorId: properties.facilitatorId,\n            })\n            .from(properties)\n            .where(eq(properties.id, request.propertyId))\n            .limit(1);\n          \n          if (property?.facilitatorId) {\n            const [facilitator] = await this.db\n              .select({\n                firstName: users.firstName,\n                lastName: users.lastName,\n                email: users.email,\n                phoneNumber: users.phoneNumber,\n              })\n              .from(users)\n              .where(eq(users.id, property.facilitatorId))\n              .limit(1);\n            \n            if (facilitator) {\n              facilitatorName = `${facilitator.firstName} ${facilitator.lastName}`;\n              facilitatorEmail = facilitator.email;\n              facilitatorPhone = facilitator.phoneNumber;\n            }\n          }\n        } catch (error) {\n          console.error('Error fetching facilitator:', error);\n        }\n\n        transformedData.push({\n          id: request.id,\n          issue: request.title,\n          title: request.title,\n          description: request.description,\n          status: request.status,\n          priority: request.priority || 'medium',\n          images: request.images || [],\n          propertyName: request.propertyName,\n          propertyId: request.propertyId,\n          reportedBy: tenantName,\n          tenant: tenantName,\n          unitNumber: unitNumber,\n          unit: unitNumber,\n          assignedAdmin,\n          facilitatorName,\n          facilitatorEmail,\n          facilitatorPhone,\n          createdAt: request.createdAt,\n          resolvedAt: request.status === 'completed' ? request.completedAt : null,\n        });\n      }\n\n      console.log('‚úÖ Transformed maintenance data:', transformedData);\n      return transformedData;\n    } catch (error) {\n      console.error('Error fetching all maintenance requests:', error);\n      return [];\n    }\n  }\n\n  // Admin Message Methods\n  async getAdminConversations(adminId: string) {\n    try {\n      // Get all messages where admin is sender or receiver\n      const adminMessages = await this.db\n        .select({\n          id: messages.id,\n          senderId: messages.senderId,\n          receiverId: messages.receiverId,\n          content: messages.content,\n          subject: messages.subject,\n          isRead: messages.isRead,\n          createdAt: messages.createdAt,\n        })\n        .from(messages)\n        .where(\n          or(\n            eq(messages.senderId, adminId),\n            eq(messages.receiverId, adminId)\n          )\n        )\n        .orderBy(sql`${messages.createdAt} DESC`);\n\n      // Group by other user and get latest message\n      const conversationsMap = new Map();\n      \n      for (const message of adminMessages) {\n        const otherUserId = message.senderId === adminId ? message.receiverId : message.senderId;\n        \n        if (!conversationsMap.has(otherUserId)) {\n          // Get the other user's details\n          const [otherUser] = await this.db\n            .select({\n              firstName: users.firstName,\n              lastName: users.lastName,\n              role: users.role,\n            })\n            .from(users)\n            .where(eq(users.id, otherUserId));\n\n          if (otherUser) {\n            // Count unread messages from this user\n            const unreadMessages = await this.db\n              .select()\n              .from(messages)\n              .where(\n                and(\n                  eq(messages.senderId, otherUserId),\n                  eq(messages.receiverId, adminId),\n                  eq(messages.isRead, false)\n                )\n              );\n\n            conversationsMap.set(otherUserId, {\n              id: otherUserId,\n              name: `${otherUser.firstName} ${otherUser.lastName}`,\n              role: otherUser.role,\n              lastMessage: message.content,\n              lastMessageTime: message.createdAt,\n              unreadCount: unreadMessages.length,\n              isOwn: message.senderId === adminId,\n            });\n          }\n        }\n      }\n\n      return Array.from(conversationsMap.values());\n    } catch (error) {\n      console.error('Error getting admin conversations:', error);\n      return [];\n    }\n  }\n\n  async getAdminConversation(\n    adminId: string, \n    otherUserId: string, \n    pagination: { page: number; limit: number }\n  ) {\n    try {\n      const { page = 1, limit = 20 } = pagination;\n      const offset = (page - 1) * limit;\n\n      const conversation = await this.db\n        .select({\n          id: messages.id,\n          senderId: messages.senderId,\n          receiverId: messages.receiverId,\n          subject: messages.subject,\n          content: messages.content,\n          isRead: messages.isRead,\n          createdAt: messages.createdAt,\n        })\n        .from(messages)\n        .where(\n          or(\n            and(eq(messages.senderId, adminId), eq(messages.receiverId, otherUserId)),\n            and(eq(messages.senderId, otherUserId), eq(messages.receiverId, adminId))\n          )\n        )\n        .orderBy(sql`${messages.createdAt} ASC`)\n        .limit(limit)\n        .offset(offset);\n\n      // Mark messages from other user as read\n      await this.db\n        .update(messages)\n        .set({ \n          isRead: true, \n          readAt: new Date(),\n          updatedAt: new Date() \n        })\n        .where(\n          and(\n            eq(messages.senderId, otherUserId),\n            eq(messages.receiverId, adminId),\n            eq(messages.isRead, false)\n          )\n        );\n\n      return conversation.map(msg => ({\n        id: msg.id,\n        senderId: msg.senderId,\n        content: msg.content,\n        subject: msg.subject,\n        timestamp: msg.createdAt,\n        isOwn: msg.senderId === adminId,\n        isRead: msg.isRead,\n      }));\n    } catch (error) {\n      console.error('Error getting admin conversation:', error);\n      return [];\n    }\n  }\n\n  async sendAdminMessage(\n    adminId: string, \n    messageDto: { receiverId: string; subject?: string; content: string }\n  ) {\n    try {\n      // Verify receiver exists\n      const [receiver] = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.id, messageDto.receiverId));\n\n      if (!receiver) {\n        throw new NotFoundException('Receiver not found');\n      }\n\n      const messageData = {\n        senderId: adminId,\n        receiverId: messageDto.receiverId,\n        subject: messageDto.subject || 'Message from Admin',\n        content: messageDto.content,\n      };\n\n      const [message] = await this.db.insert(messages).values(messageData).returning();\n      return message;\n    } catch (error) {\n      console.error('Error sending admin message:', error);\n      throw error;\n    }\n  }\n\n  async getAdminUnreadCount(adminId: string) {\n    try {\n      const unreadMessages = await this.db\n        .select()\n        .from(messages)\n        .where(\n          and(\n            eq(messages.receiverId, adminId),\n            eq(messages.isRead, false)\n          )\n        );\n\n      return { count: unreadMessages.length };\n    } catch (error) {\n      console.error('Error getting admin unread count:', error);\n      return { count: 0 };\n    }\n  }\n\n}\n"],"names":["AdminService","getDashboardStats","console","log","userStats","db","select","totalLandlords","sql","totalTenants","totalAdmins","from","users","propertyStats","totalProperties","count","properties","unitsStats","totalUnits","units","occupiedUnitsStats","occupiedUnits","tenantInvitations","where","eq","status","facilitatorStats","totalFacilitators","activeFacilitators","facilitatorPropertyStats","propertiesWithFacilitators","Number","stats","vacantUnits","totalRentCollected","pendingPayments","activeMaintenanceRequests","error","getRevenueAnalytics","timeframe","now","Date","monthsBack","parseInt","replace","startDate","getFullYear","getMonth","toISOString","revenueData","month","year","amount","payments","and","groupBy","orderBy","length","monthlyData","map","row","getMaintenanceAnalytics","maintenanceData","pending","inProgress","completed","cancelled","maintenanceRequests","open","resolved","getUsers","options","page","limit","role","search","offset","finalWhereCondition","firstName","lastName","email","undefined","dataQuery","createdAt","countQuery","data","totalResult","Promise","all","total","enrichedData","user","password","userWithoutPassword","landlordIds","u","id","propertiesCounts","landlordId","inArray","countsMap","Map","pc","propertiesCount","get","meta","totalPages","Math","ceil","createUser","createUserDto","existingUser","ConflictException","hashedPassword","bcrypt","hash","newUser","insert","values","isEmailVerified","returning","getUserById","NotFoundException","updateUser","updateUserDto","updatedUser","update","set","updatedAt","deleteUser","deletedUser","delete","message","toggleUserStatus","currentUser","isActive","getProperties","searchCondition","name","address","landlordAlias","facilitatorAlias","city","state","country","propertyType","description","images","amenities","facilitatorId","landlordName","landlordEmail","facilitatorName","facilitatorEmail","leftJoin","assignFacilitatorToProperty","propertyId","facilitator","updatedProperty","removeFacilitatorFromProperty","getPropertyAnalytics","newProperties","averageUnitsPerProperty","getPropertyById","property","landlord","phoneNumber","facilitatorData","getPropertyUnits","unitsData","unitNumber","bedrooms","bathrooms","rent","isAvailable","tenantId","leases","leaseStatus","tenantFirstName","tenantLastName","unitId","unit","rentAmount","tenantName","getPropertyTenants","tenantsData","monthlyRent","leaseEndDate","endDate","innerJoin","tenant","getPropertyMaintenance","title","priority","completedAt","assignedToFirstName","assignedToLastName","assignedTo","request","issue","assignedAdmin","resolvedAt","getPropertyPayments","paymentsData","amountPaid","dueDate","paidDate","payment","totalDue","paid","balance","lastPayment","getAllMaintenanceRequests","filters","conditions","push","query","propertyName","slice","transformedData","lease","admin","facilitatorPhone","reportedBy","getAdminConversations","adminId","adminMessages","messages","senderId","receiverId","content","subject","isRead","or","conversationsMap","otherUserId","has","otherUser","unreadMessages","lastMessage","lastMessageTime","unreadCount","isOwn","Array","getAdminConversation","pagination","conversation","readAt","msg","timestamp","sendAdminMessage","messageDto","receiver","messageData","getAdminUnreadCount"],"mappings":";;;;+BAcaA;;;eAAAA;;;wBAd4D;4BACjB;8BACzB;kEACP;gCACY;uBACd;4BACY;0BACT;0BACqB;wBACvB;mCACW;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAI3B,IAAA,AAAMA,eAAN,MAAMA;IAMX,MAAMC,oBAAoB;QACxB,IAAI;YACFC,QAAQC,GAAG,CAAC;YAEZ,wEAAwE;YACxE,MAAM,CAACC,UAAU,GAAG,MAAM,IAAI,CAACC,EAAE,CAC9BC,MAAM,CAAC;gBACNC,gBAAgBC,IAAAA,eAAG,CAAQ,CAAC,6CAA6C,CAAC;gBAC1EC,cAAcD,IAAAA,eAAG,CAAQ,CAAC,2CAA2C,CAAC;gBACtEE,aAAaF,IAAAA,eAAG,CAAQ,CAAC,0CAA0C,CAAC;YACtE,GACCG,IAAI,CAACC,YAAK;YAEb,qBAAqB;YACrB,MAAM,CAACC,cAAc,GAAG,MAAM,IAAI,CAACR,EAAE,CAClCC,MAAM,CAAC;gBACNQ,iBAAiBC,IAAAA,iBAAK;YACxB,GACCJ,IAAI,CAACK,sBAAU;YAElB,2EAA2E;YAC3E,MAAM,CAACC,WAAW,GAAG,MAAM,IAAI,CAACZ,EAAE,CAC/BC,MAAM,CAAC;gBACNY,YAAYH,IAAAA,iBAAK;YACnB,GACCJ,IAAI,CAACQ,iBAAK;YAEb,8DAA8D;YAC9D,MAAM,CAACC,mBAAmB,GAAG,MAAM,IAAI,CAACf,EAAE,CACvCC,MAAM,CAAC;gBACNe,eAAeN,IAAAA,iBAAK;YACtB,GACCJ,IAAI,CAACW,oCAAiB,EACtBC,KAAK,CAACC,IAAAA,cAAE,EAACF,oCAAiB,CAACG,MAAM,EAAE;YAEtC,iEAAiE;YACjE,6CAA6C;YAC7C,wCAAwC;YACxC,8DAA8D;YAE9D,wBAAwB;YACxB,MAAM,CAACC,iBAAiB,GAAG,MAAM,IAAI,CAACrB,EAAE,CACrCC,MAAM,CAAC;gBACNqB,mBAAmBnB,IAAAA,eAAG,CAAQ,CAAC,gDAAgD,CAAC;gBAChFoB,oBAAoBpB,IAAAA,eAAG,CAAQ,CAAC,qEAAqE,CAAC;YACxG,GACCG,IAAI,CAACC,YAAK;YAEb,4CAA4C;YAC5C,MAAM,CAACiB,yBAAyB,GAAG,MAAM,IAAI,CAACxB,EAAE,CAC7CC,MAAM,CAAC;gBACNwB,4BAA4BtB,IAAAA,eAAG,CAAQ,CAAC,sDAAsD,CAAC;YACjG,GACCG,IAAI,CAACK,sBAAU;YAElB,MAAME,aAAaa,OAAOd,YAAYC,cAAc;YACpD,MAAMG,gBAAgBU,OAAOX,oBAAoBC,iBAAiB;YAElE,MAAMW,QAAQ;gBACZlB,iBAAiBiB,OAAOlB,eAAeC,mBAAmB;gBAC1DP,gBAAgBwB,OAAO3B,WAAWG,kBAAkB;gBACpDE,cAAcsB,OAAO3B,WAAWK,gBAAgB;gBAChDkB,mBAAmBI,OAAOL,kBAAkBC,qBAAqB;gBACjEC,oBAAoBG,OAAOL,kBAAkBE,sBAAsB;gBACnEE,4BAA4BC,OAAOF,0BAA0BC,8BAA8B;gBAC3FZ;gBACAG;gBACAY,aAAaf,aAAaG;gBAC1Ba,oBAAoB;gBACpBC,iBAAiB;gBACjBC,2BAA2B;YAC7B;YAEAlC,QAAQC,GAAG,CAAC,0CAA0C6B;YACtD,OAAOA;QACT,EAAE,OAAOK,OAAO;YACdnC,QAAQmC,KAAK,CAAC,mCAAmCA;YACjD,mDAAmD;YACnD,OAAO;gBACLvB,iBAAiB;gBACjBP,gBAAgB;gBAChBE,cAAc;gBACdkB,mBAAmB;gBACnBT,YAAY;gBACZG,eAAe;gBACfY,aAAa;gBACbC,oBAAoB;gBACpBC,iBAAiB;gBACjBC,2BAA2B;YAC7B;QACF;IACF;IAEA,MAAME,oBAAoBC,YAAoB,KAAK,EAAE;QACnD,IAAI;YACFrC,QAAQC,GAAG,CAAC;YAEZ,2CAA2C;YAC3C,MAAMqC,MAAM,IAAIC;YAChB,MAAMC,aAAaC,SAASJ,UAAUK,OAAO,CAAC,KAAK,QAAQ;YAC3D,MAAMC,YAAY,IAAIJ,KAAKD,IAAIM,WAAW,IAAIN,IAAIO,QAAQ,KAAKL,aAAa,GAAG;YAE/ExC,QAAQC,GAAG,CAAC,CAAC,2BAA2B,EAAE0C,UAAUG,WAAW,GAAG,IAAI,EAAER,IAAIQ,WAAW,IAAI;YAE3F,sDAAsD;YACtD,MAAMC,cAAc,MAAM,IAAI,CAAC5C,EAAE,CAC9BC,MAAM,CAAC;gBACN4C,OAAO1C,IAAAA,eAAG,CAAQ,CAAC,yBAAyB,CAAC;gBAC7C2C,MAAM3C,IAAAA,eAAG,CAAQ,CAAC,4BAA4B,CAAC;gBAC/C4C,QAAQ5C,IAAAA,eAAG,CAAQ,CAAC,6BAA6B,CAAC;YACpD,GACCG,IAAI,CAAC0C,kBAAQ,EACb9B,KAAK,CACJ+B,IAAAA,eAAG,EACD9C,IAAAA,eAAG,CAAA,CAAC,aAAa,EAAEqC,UAAU,CAAC,EAC9BrC,IAAAA,eAAG,CAAA,CAAC,aAAa,EAAEgC,IAAI,CAAC,EACxBhB,IAAAA,cAAE,EAAC6B,kBAAQ,CAAC5B,MAAM,EAAE,UAGvB8B,OAAO,CAAC/C,IAAAA,eAAG,CAAA,CAAC,8BAA8B,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,yBAAyB,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,4BAA4B,CAAC,EAC9GgD,OAAO,CAAChD,IAAAA,eAAG,CAAA,CAAC,8BAA8B,CAAC;YAE9CN,QAAQC,GAAG,CAAC,8BAA8B8C;YAE1C,iCAAiC;YACjC,IAAIA,YAAYQ,MAAM,KAAK,GAAG;gBAC5BvD,QAAQC,GAAG,CAAC;gBACZ,OAAO;oBAAEuD,aAAa,EAAE;gBAAC;YAC3B;YAEA,OAAO;gBACLA,aAAaT,YAAYU,GAAG,CAACC,CAAAA,MAAQ,CAAA;wBACnCV,OAAOU,IAAIV,KAAK;wBAChBE,QAAQrB,OAAO6B,IAAIR,MAAM;oBAC3B,CAAA;YACF;QACF,EAAE,OAAOf,OAAO;YACdnC,QAAQmC,KAAK,CAAC,qCAAqCA;YACnD,8CAA8C;YAC9C,OAAO;gBAAEqB,aAAa,EAAE;YAAC;QAC3B;IACF;IAEA,MAAMG,wBAAwBtB,YAAoB,KAAK,EAAE;QACvD,IAAI;YACFrC,QAAQC,GAAG,CAAC;YAEZ,2CAA2C;YAC3C,MAAMqC,MAAM,IAAIC;YAChB,MAAMC,aAAaC,SAASJ,UAAUK,OAAO,CAAC,KAAK,QAAQ;YAC3D,MAAMC,YAAY,IAAIJ,KAAKD,IAAIM,WAAW,IAAIN,IAAIO,QAAQ,KAAKL,aAAa,GAAG;YAE/ExC,QAAQC,GAAG,CAAC,CAAC,+BAA+B,EAAE0C,UAAUG,WAAW,GAAG,IAAI,EAAER,IAAIQ,WAAW,IAAI;YAE/F,6EAA6E;YAC7E,MAAMc,kBAAkB,MAAM,IAAI,CAACzD,EAAE,CAClCC,MAAM,CAAC;gBACN4C,OAAO1C,IAAAA,eAAG,CAAQ,CAAC,0BAA0B,CAAC;gBAC9C2C,MAAM3C,IAAAA,eAAG,CAAQ,CAAC,6BAA6B,CAAC;gBAChDuD,SAASvD,IAAAA,eAAG,CAAQ,CAAC,8CAA8C,CAAC;gBACpEwD,YAAYxD,IAAAA,eAAG,CAAQ,CAAC,kDAAkD,CAAC;gBAC3EyD,WAAWzD,IAAAA,eAAG,CAAQ,CAAC,gDAAgD,CAAC;gBACxE0D,WAAW1D,IAAAA,eAAG,CAAQ,CAAC,gDAAgD,CAAC;YAC1E,GACCG,IAAI,CAACwD,6BAAmB,EACxB5C,KAAK,CACJ+B,IAAAA,eAAG,EACD9C,IAAAA,eAAG,CAAA,CAAC,cAAc,EAAEqC,UAAU,CAAC,EAC/BrC,IAAAA,eAAG,CAAA,CAAC,cAAc,EAAEgC,IAAI,CAAC,GAG5Be,OAAO,CAAC/C,IAAAA,eAAG,CAAA,CAAC,+BAA+B,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,0BAA0B,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,6BAA6B,CAAC,EACjHgD,OAAO,CAAChD,IAAAA,eAAG,CAAA,CAAC,+BAA+B,CAAC;YAE/CN,QAAQC,GAAG,CAAC,kCAAkC2D;YAE9C,iCAAiC;YACjC,IAAIA,gBAAgBL,MAAM,KAAK,GAAG;gBAChCvD,QAAQC,GAAG,CAAC;gBACZ,OAAO;oBAAEuD,aAAa,EAAE;gBAAC;YAC3B;YAEA,OAAO;gBACLA,aAAaI,gBAAgBH,GAAG,CAACC,CAAAA,MAAQ,CAAA;wBACvCV,OAAOU,IAAIV,KAAK;wBAChBkB,MAAMrC,OAAO6B,IAAIG,OAAO;wBACxBC,YAAYjC,OAAO6B,IAAII,UAAU;wBACjCK,UAAUtC,OAAO6B,IAAIK,SAAS;oBAChC,CAAA;YACF;QACF,EAAE,OAAO5B,OAAO;YACdnC,QAAQmC,KAAK,CAAC,yCAAyCA;YACvD,8CAA8C;YAC9C,OAAO;gBAAEqB,aAAa,EAAE;YAAC;QAC3B;IACF;IAIA,MAAMY,SAASC,OAKd,EAAE;QACD,MAAM,EAAEC,IAAI,EAAEC,KAAK,EAAEC,IAAI,EAAEC,MAAM,EAAE,GAAGJ;QACtC,MAAMK,SAAS,AAACJ,CAAAA,OAAO,CAAA,IAAKC;QAE5B,IAAI;YACF,wBAAwB;YACxB,IAAII;YAEJ,IAAIH,QAAQC,QAAQ;gBAClBE,sBAAsBvB,IAAAA,eAAG,EACvB9B,IAAAA,cAAE,EAACZ,YAAK,CAAC8D,IAAI,EAAEA,OACflE,IAAAA,eAAG,CAAA,CAAC,EAAEI,YAAK,CAACkE,SAAS,CAAC,OAAO,EAAE,CAAC,CAAC,EAAEH,OAAO,CAAC,CAAC,CAAC,IAAI,EAAE/D,YAAK,CAACmE,QAAQ,CAAC,OAAO,EAAE,CAAC,CAAC,EAAEJ,OAAO,CAAC,CAAC,CAAC,IAAI,EAAE/D,YAAK,CAACoE,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC,EAAEL,OAAO,CAAC,CAAC,CAAC,CAAC;YAEvI,OAAO,IAAID,MAAM;gBACfG,sBAAsBrD,IAAAA,cAAE,EAACZ,YAAK,CAAC8D,IAAI,EAAEA;YACvC,OAAO,IAAIC,QAAQ;gBACjBE,sBAAsBrE,IAAAA,eAAG,CAAA,CAAC,EAAEI,YAAK,CAACkE,SAAS,CAAC,OAAO,EAAE,CAAC,CAAC,EAAEH,OAAO,CAAC,CAAC,CAAC,IAAI,EAAE/D,YAAK,CAACmE,QAAQ,CAAC,OAAO,EAAE,CAAC,CAAC,EAAEJ,OAAO,CAAC,CAAC,CAAC,IAAI,EAAE/D,YAAK,CAACoE,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC,EAAEL,OAAO,CAAC,CAAC,CAAC,CAAC;YAC3J,OAAO;gBACLE,sBAAsBI;YACxB;YAEA,kBAAkB;YAClB,MAAMC,YAAY,IAAI,CAAC7E,EAAE,CACtBC,MAAM,GACNK,IAAI,CAACC,YAAK,EACVW,KAAK,CAACsD,qBACNJ,KAAK,CAACA,OACNG,MAAM,CAACA,QACPpB,OAAO,CAAC5C,YAAK,CAACuE,SAAS;YAE1B,MAAMC,aAAa,IAAI,CAAC/E,EAAE,CACvBC,MAAM,CAAC;gBAAES,OAAOA,IAAAA,iBAAK;YAAG,GACxBJ,IAAI,CAACC,YAAK,EACVW,KAAK,CAACsD;YAET,MAAM,CAACQ,MAAMC,YAAY,GAAG,MAAMC,QAAQC,GAAG,CAAC;gBAC5CN;gBACAE;aACD;YAED,MAAMK,QAAQH,WAAW,CAAC,EAAE,EAAEvE,SAAS;YAEvC,uDAAuD;YACvD,IAAI2E,eAAeL,KAAK1B,GAAG,CAACgC,CAAAA;gBAC1B,MAAM,EAAEC,QAAQ,EAAE,GAAGC,qBAAqB,GAAGF;gBAC7C,OAAOE;YACT;YAEA,IAAInB,SAAS,YAAY;gBACvB,yCAAyC;gBACzC,MAAMoB,cAAcJ,aAAa/B,GAAG,CAACoC,CAAAA,IAAKA,EAAEC,EAAE;gBAC9C,IAAIF,YAAYrC,MAAM,GAAG,GAAG;oBAC1B,MAAMwC,mBAAmB,MAAM,IAAI,CAAC5F,EAAE,CACnCC,MAAM,CAAC;wBACN4F,YAAYlF,sBAAU,CAACkF,UAAU;wBACjCnF,OAAOA,IAAAA,iBAAK;oBACd,GACCJ,IAAI,CAACK,sBAAU,EACfO,KAAK,CAAC4E,IAAAA,mBAAO,EAACnF,sBAAU,CAACkF,UAAU,EAAEJ,cACrCvC,OAAO,CAACvC,sBAAU,CAACkF,UAAU;oBAEhC,MAAME,YAAY,IAAIC,IAAIJ,iBAAiBtC,GAAG,CAAC2C,CAAAA,KAAM;4BAACA,GAAGJ,UAAU;4BAAEnE,OAAOuE,GAAGvF,KAAK;yBAAE;oBAEtF2E,eAAeA,aAAa/B,GAAG,CAACgC,CAAAA,OAAS,CAAA;4BACvC,GAAGA,IAAI;4BACPY,iBAAiBH,UAAUI,GAAG,CAACb,KAAKK,EAAE,KAAK;wBAC7C,CAAA;gBACF,OAAO;oBACLN,eAAeA,aAAa/B,GAAG,CAACgC,CAAAA,OAAS,CAAA;4BACvC,GAAGA,IAAI;4BACPY,iBAAiB;wBACnB,CAAA;gBACF;YACF;YAEA,OAAO;gBACLlB,MAAMK;gBACNe,MAAM;oBACJjC;oBACAC;oBACAgB,OAAO1D,OAAO0D;oBACdiB,YAAYC,KAAKC,IAAI,CAAC7E,OAAO0D,SAAShB;gBACxC;YACF;QACF,EAAE,OAAOpC,OAAO;YACdnC,QAAQmC,KAAK,CAAC,yBAAyBA;YACvC,MAAMA;QACR;IACF;IAEA,MAAMwE,WAAWC,aAA4B,EAAE;QAC7C,IAAI;YACF,+BAA+B;YAC/B,MAAMC,eAAe,MAAM,IAAI,CAAC1G,EAAE,CAC/BC,MAAM,GACNK,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoE,KAAK,EAAE8B,cAAc9B,KAAK,GACzCP,KAAK,CAAC;YAET,IAAIsC,aAAatD,MAAM,GAAG,GAAG;gBAC3B,MAAM,IAAIuD,yBAAiB,CAAC;YAC9B;YAEA,gBAAgB;YAChB,MAAMC,iBAAiB,MAAMC,UAAOC,IAAI,CAACL,cAAclB,QAAQ,EAAE;YAEjE,cAAc;YACd,MAAM,CAACwB,QAAQ,GAAG,MAAM,IAAI,CAAC/G,EAAE,CAC5BgH,MAAM,CAACzG,YAAK,EACZ0G,MAAM,CAAC;gBACN,GAAGR,aAAa;gBAChBlB,UAAUqB;gBACVM,iBAAiB;YACnB,GACCC,SAAS;YAEZ,MAAM,EAAE5B,QAAQ,EAAE,GAAGC,qBAAqB,GAAGuB;YAC7C,OAAOvB;QACT,EAAE,OAAOxD,OAAO;YACdnC,QAAQmC,KAAK,CAAC,wBAAwBA;YACtC,MAAMA;QACR;IACF;IAEA,MAAMoF,YAAYzB,EAAU,EAAE;QAC5B,IAAI;YACF,MAAM,CAACL,KAAK,GAAG,MAAM,IAAI,CAACtF,EAAE,CACzBC,MAAM,GACNK,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEA,KACnBvB,KAAK,CAAC;YAET,IAAI,CAACkB,MAAM;gBACT,MAAM,IAAI+B,yBAAiB,CAAC;YAC9B;YAEA,MAAM,EAAE9B,QAAQ,EAAE,GAAGC,qBAAqB,GAAGF;YAC7C,OAAOE;QACT,EAAE,OAAOxD,OAAO;YACdnC,QAAQmC,KAAK,CAAC,wBAAwBA;YACtC,MAAMA;QACR;IACF;IAEA,MAAMsF,WAAW3B,EAAU,EAAE4B,aAA4B,EAAE;QACzD,IAAI;YACF,MAAM,CAACC,YAAY,GAAG,MAAM,IAAI,CAACxH,EAAE,CAChCyH,MAAM,CAAClH,YAAK,EACZmH,GAAG,CAAC;gBACH,GAAGH,aAAa;gBAChBI,WAAW,IAAIvF;YACjB,GACClB,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEA,KACnBwB,SAAS;YAEZ,IAAI,CAACK,aAAa;gBAChB,MAAM,IAAIH,yBAAiB,CAAC;YAC9B;YAEA,MAAM,EAAE9B,QAAQ,EAAE,GAAGC,qBAAqB,GAAGgC;YAC7C,OAAOhC;QACT,EAAE,OAAOxD,OAAO;YACdnC,QAAQmC,KAAK,CAAC,wBAAwBA;YACtC,MAAMA;QACR;IACF;IAEA,MAAM4F,WAAWjC,EAAU,EAAE;QAC3B,IAAI;YACF,MAAM,CAACkC,YAAY,GAAG,MAAM,IAAI,CAAC7H,EAAE,CAChC8H,MAAM,CAACvH,YAAK,EACZW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEA,KACnBwB,SAAS;YAEZ,IAAI,CAACU,aAAa;gBAChB,MAAM,IAAIR,yBAAiB,CAAC;YAC9B;YAEA,OAAO;gBAAEU,SAAS;YAA4B;QAChD,EAAE,OAAO/F,OAAO;YACdnC,QAAQmC,KAAK,CAAC,wBAAwBA;YACtC,MAAMA;QACR;IACF;IAEA,MAAMgG,iBAAiBrC,EAAU,EAAE;QACjC,IAAI;YACF,6BAA6B;YAC7B,MAAM,CAACsC,YAAY,GAAG,MAAM,IAAI,CAACjI,EAAE,CAChCC,MAAM,GACNK,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEA,KACnBvB,KAAK,CAAC;YAET,IAAI,CAAC6D,aAAa;gBAChB,MAAM,IAAIZ,yBAAiB,CAAC;YAC9B;YAEA,oBAAoB;YACpB,MAAM,CAACG,YAAY,GAAG,MAAM,IAAI,CAACxH,EAAE,CAChCyH,MAAM,CAAClH,YAAK,EACZmH,GAAG,CAAC;gBACHQ,UAAU,CAACD,YAAYC,QAAQ;gBAC/BP,WAAW,IAAIvF;YACjB,GACClB,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEA,KACnBwB,SAAS;YAEZ,MAAM,EAAE5B,QAAQ,EAAE,GAAGC,qBAAqB,GAAGgC;YAC7C,OAAOhC;QACT,EAAE,OAAOxD,OAAO;YACdnC,QAAQmC,KAAK,CAAC,+BAA+BA;YAC7C,MAAMA;QACR;IACF;IAEA,MAAMmG,cAAcjE,OAInB,EAAE;QACD,MAAM,EAAEC,IAAI,EAAEC,KAAK,EAAEE,MAAM,EAAE,GAAGJ;QAChC,MAAMK,SAAS,AAACJ,CAAAA,OAAO,CAAA,IAAKC;QAE5B,IAAI;YACF,mCAAmC;YACnC,MAAMgE,kBAAkB9D,SACpBnE,IAAAA,eAAG,CAAA,CAAC,EAAEQ,sBAAU,CAAC0H,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,EAAE/D,OAAO,CAAC,CAAC,CAAC,IAAI,EAAE3D,sBAAU,CAAC2H,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC,EAAEhE,OAAO,CAAC,CAAC,CAAC,CAAC,GAC9FM;YAEJ,wCAAwC;YACxC,MAAM2D,gBAAgBhI,YAAK;YAC3B,MAAMiI,mBAAmBrI,IAAAA,eAAG,CAAA,CAAC,WAAW,CAAC;YAEzC,MAAM0E,YAAY,IAAI,CAAC7E,EAAE,CACtBC,MAAM,CAAC;gBACN0F,IAAIhF,sBAAU,CAACgF,EAAE;gBACjB0C,MAAM1H,sBAAU,CAAC0H,IAAI;gBACrBC,SAAS3H,sBAAU,CAAC2H,OAAO;gBAC3BG,MAAM9H,sBAAU,CAAC8H,IAAI;gBACrBC,OAAO/H,sBAAU,CAAC+H,KAAK;gBACvBC,SAAShI,sBAAU,CAACgI,OAAO;gBAC3BC,cAAcjI,sBAAU,CAACiI,YAAY;gBACrC/H,YAAYF,sBAAU,CAACE,UAAU;gBACjCgI,aAAalI,sBAAU,CAACkI,WAAW;gBACnCC,QAAQnI,sBAAU,CAACmI,MAAM;gBACzBC,WAAWpI,sBAAU,CAACoI,SAAS;gBAC/B3H,QAAQT,sBAAU,CAACS,MAAM;gBACzByE,YAAYlF,sBAAU,CAACkF,UAAU;gBACjCmD,eAAerI,sBAAU,CAACqI,aAAa;gBACvClE,WAAWnE,sBAAU,CAACmE,SAAS;gBAC/B6C,WAAWhH,sBAAU,CAACgH,SAAS;gBAC/BsB,cAAc9I,IAAAA,eAAG,CAAQ,CAAC,EAAEoI,cAAc9D,SAAS,CAAC,WAAW,EAAE8D,cAAc7D,QAAQ,CAAC,CAAC;gBACzFwE,eAAeX,cAAc5D,KAAK;gBAClCwE,iBAAiBhJ,IAAAA,eAAG,CAAQ,CAAC,sDAAsD,CAAC;gBACpFiJ,kBAAkBjJ,IAAAA,eAAG,CAAQ,CAAC,iBAAiB,CAAC;YAClD,GACCG,IAAI,CAACK,sBAAU,EACf0I,QAAQ,CAACd,eAAepH,IAAAA,cAAE,EAACR,sBAAU,CAACkF,UAAU,EAAE0C,cAAc5C,EAAE,GAClE0D,QAAQ,CAAClJ,IAAAA,eAAG,CAAA,CAAC,oBAAoB,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,EAAEQ,sBAAU,CAACqI,aAAa,CAAC,iBAAiB,CAAC,EACrF9H,KAAK,CAACkH,iBACNhE,KAAK,CAACA,OACNG,MAAM,CAACA,QACPpB,OAAO,CAACxC,sBAAU,CAACmE,SAAS;YAE/B,MAAMC,aAAa,IAAI,CAAC/E,EAAE,CACvBC,MAAM,CAAC;gBAAES,OAAOA,IAAAA,iBAAK;YAAG,GACxBJ,IAAI,CAACK,sBAAU,EACfO,KAAK,CAACkH;YAET,MAAM,CAACpD,MAAMC,YAAY,GAAG,MAAMC,QAAQC,GAAG,CAAC;gBAC5CN;gBACAE;aACD;YAED,MAAMK,QAAQH,WAAW,CAAC,EAAE,EAAEvE,SAAS;YAEvC,OAAO;gBACLsE;gBACAoB,MAAM;oBACJjC;oBACAC;oBACAgB,OAAO1D,OAAO0D;oBACdiB,YAAYC,KAAKC,IAAI,CAAC7E,OAAO0D,SAAShB;gBACxC;YACF;QACF,EAAE,OAAOpC,OAAO;YACdnC,QAAQmC,KAAK,CAAC,8BAA8BA;YAC5C,MAAMA;QACR;IACF;IAEA,MAAMsH,4BAA4BC,UAAkB,EAAEP,aAAqB,EAAE;QAC3E,IAAI;YACF,iDAAiD;YACjD,MAAM,CAACQ,YAAY,GAAG,MAAM,IAAI,CAACxJ,EAAE,CAChCC,MAAM,GACNK,IAAI,CAACC,YAAK,EACVW,KAAK,CAAC+B,IAAAA,eAAG,EAAC9B,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEqD,gBAAgB7H,IAAAA,cAAE,EAACZ,YAAK,CAAC8D,IAAI,EAAE,iBACtDD,KAAK,CAAC;YAET,IAAI,CAACoF,aAAa;gBAChB,MAAM,IAAInC,yBAAiB,CAAC;YAC9B;YAEA,kBAAkB;YAClB,MAAM,CAACoC,gBAAgB,GAAG,MAAM,IAAI,CAACzJ,EAAE,CACpCyH,MAAM,CAAC9G,sBAAU,EACjB+G,GAAG,CAAC;gBACHsB;gBACArB,WAAW,IAAIvF;YACjB,GACClB,KAAK,CAACC,IAAAA,cAAE,EAACR,sBAAU,CAACgF,EAAE,EAAE4D,aACxBpC,SAAS;YAEZ,IAAI,CAACsC,iBAAiB;gBACpB,MAAM,IAAIpC,yBAAiB,CAAC;YAC9B;YAEA,OAAOoC;QACT,EAAE,OAAOzH,OAAO;YACdnC,QAAQmC,KAAK,CAAC,4CAA4CA;YAC1D,MAAMA;QACR;IACF;IAEA,MAAM0H,8BAA8BH,UAAkB,EAAE;QACtD,IAAI;YACF,MAAM,CAACE,gBAAgB,GAAG,MAAM,IAAI,CAACzJ,EAAE,CACpCyH,MAAM,CAAC9G,sBAAU,EACjB+G,GAAG,CAAC;gBACHsB,eAAe;gBACfrB,WAAW,IAAIvF;YACjB,GACClB,KAAK,CAACC,IAAAA,cAAE,EAACR,sBAAU,CAACgF,EAAE,EAAE4D,aACxBpC,SAAS;YAEZ,IAAI,CAACsC,iBAAiB;gBACpB,MAAM,IAAIpC,yBAAiB,CAAC;YAC9B;YAEA,OAAOoC;QACT,EAAE,OAAOzH,OAAO;YACdnC,QAAQmC,KAAK,CAAC,6CAA6CA;YAC3D,MAAMA;QACR;IACF;IAEA,mDAAmD;IACnD,MAAM2H,qBAAqBzH,SAAiB,EAAE;QAC5C,oDAAoD;QACpD,OAAO;YACLzB,iBAAiB;YACjBmJ,eAAe;YACfnI,4BAA4B;YAC5BoI,yBAAyB;QAC3B;IACF;IAEA,0BAA0B;IAC1B,MAAMC,gBAAgBnE,EAAU,EAAE;QAChC,IAAI;YACF,MAAM,CAACoE,SAAS,GAAG,MAAM,IAAI,CAAC/J,EAAE,CAC7BC,MAAM,CAAC;gBACN0F,IAAIhF,sBAAU,CAACgF,EAAE;gBACjB0C,MAAM1H,sBAAU,CAAC0H,IAAI;gBACrBC,SAAS3H,sBAAU,CAAC2H,OAAO;gBAC3BG,MAAM9H,sBAAU,CAAC8H,IAAI;gBACrBC,OAAO/H,sBAAU,CAAC+H,KAAK;gBACvBC,SAAShI,sBAAU,CAACgI,OAAO;gBAC3BC,cAAcjI,sBAAU,CAACiI,YAAY;gBACrC/H,YAAYF,sBAAU,CAACE,UAAU;gBACjCgI,aAAalI,sBAAU,CAACkI,WAAW;gBACnCC,QAAQnI,sBAAU,CAACmI,MAAM;gBACzBC,WAAWpI,sBAAU,CAACoI,SAAS;gBAC/B3H,QAAQT,sBAAU,CAACS,MAAM;gBACzByE,YAAYlF,sBAAU,CAACkF,UAAU;gBACjCmD,eAAerI,sBAAU,CAACqI,aAAa;gBACvClE,WAAWnE,sBAAU,CAACmE,SAAS;gBAC/B6C,WAAWhH,sBAAU,CAACgH,SAAS;gBAC/BqC,UAAU;oBACRrE,IAAIpF,YAAK,CAACoF,EAAE;oBACZlB,WAAWlE,YAAK,CAACkE,SAAS;oBAC1BC,UAAUnE,YAAK,CAACmE,QAAQ;oBACxBC,OAAOpE,YAAK,CAACoE,KAAK;oBAClBsF,aAAa1J,YAAK,CAAC0J,WAAW;gBAChC;YACF,GACC3J,IAAI,CAACK,sBAAU,EACf0I,QAAQ,CAAC9I,YAAK,EAAEY,IAAAA,cAAE,EAACR,sBAAU,CAACkF,UAAU,EAAEtF,YAAK,CAACoF,EAAE,GAClDzE,KAAK,CAACC,IAAAA,cAAE,EAACR,sBAAU,CAACgF,EAAE,EAAEA,KACxBvB,KAAK,CAAC;YAET,IAAI,CAAC2F,UAAU;gBACb,MAAM,IAAI1C,yBAAiB,CAAC;YAC9B;YAEA,mCAAmC;YACnC,IAAImC,cAMO;YACX,IAAIO,SAASf,aAAa,EAAE;gBAC1B,MAAM,CAACkB,gBAAgB,GAAG,MAAM,IAAI,CAAClK,EAAE,CACpCC,MAAM,CAAC;oBACN0F,IAAIpF,YAAK,CAACoF,EAAE;oBACZlB,WAAWlE,YAAK,CAACkE,SAAS;oBAC1BC,UAAUnE,YAAK,CAACmE,QAAQ;oBACxBC,OAAOpE,YAAK,CAACoE,KAAK;oBAClBsF,aAAa1J,YAAK,CAAC0J,WAAW;gBAChC,GACC3J,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEoE,SAASf,aAAa,GACzC5E,KAAK,CAAC;gBAEToF,cAAcU;YAChB;YAEA,OAAO;gBACL,GAAGH,QAAQ;gBACXP;YACF;QACF,EAAE,OAAOxH,OAAO;YACdnC,QAAQmC,KAAK,CAAC,kCAAkCA;YAChD,MAAMA;QACR;IACF;IAEA,MAAMmI,iBAAiBZ,UAAkB,EAAE;QACzC,IAAI;YACF,4CAA4C;YAC5C,MAAMa,YAAY,MAAM,IAAI,CAACpK,EAAE,CAC5BC,MAAM,CAAC;gBACN0F,IAAI7E,iBAAK,CAAC6E,EAAE;gBACZ0E,YAAYvJ,iBAAK,CAACuJ,UAAU;gBAC5BC,UAAUxJ,iBAAK,CAACwJ,QAAQ;gBACxBC,WAAWzJ,iBAAK,CAACyJ,SAAS;gBAC1BC,MAAM1J,iBAAK,CAAC0J,IAAI;gBAChBC,aAAa3J,iBAAK,CAAC2J,WAAW;gBAC9BlB,YAAYzI,iBAAK,CAACyI,UAAU;gBAC5B,oBAAoB;gBACpBmB,UAAUC,cAAM,CAACD,QAAQ;gBACzBE,aAAaD,cAAM,CAACvJ,MAAM;gBAC1B,qBAAqB;gBACrByJ,iBAAiBtK,YAAK,CAACkE,SAAS;gBAChCqG,gBAAgBvK,YAAK,CAACmE,QAAQ;YAChC,GACCpE,IAAI,CAACQ,iBAAK,EACVuI,QAAQ,CACPsB,cAAM,EACN1H,IAAAA,eAAG,EACD9B,IAAAA,cAAE,EAACL,iBAAK,CAAC6E,EAAE,EAAEgF,cAAM,CAACI,MAAM,GAC1B5J,IAAAA,cAAE,EAACwJ,cAAM,CAACvJ,MAAM,EAAE,YAGrBiI,QAAQ,CAAC9I,YAAK,EAAEY,IAAAA,cAAE,EAACwJ,cAAM,CAACD,QAAQ,EAAEnK,YAAK,CAACoF,EAAE,GAC5CzE,KAAK,CAACC,IAAAA,cAAE,EAACL,iBAAK,CAACyI,UAAU,EAAEA,aAC3BpG,OAAO,CAACrC,iBAAK,CAACuJ,UAAU;YAE3B,2CAA2C;YAC3C,OAAOD,UAAU9G,GAAG,CAAC0H,CAAAA,OAAS,CAAA;oBAC5BrF,IAAIqF,KAAKrF,EAAE;oBACX0E,YAAYW,KAAKX,UAAU;oBAC3BjJ,QAAQ4J,KAAKN,QAAQ,GAAG,aAAa;oBACrCO,YAAYvJ,OAAOsJ,KAAKR,IAAI;oBAC5BE,UAAUM,KAAKN,QAAQ;oBACvBQ,YAAYF,KAAKH,eAAe,IAAIG,KAAKF,cAAc,GACnD,GAAGE,KAAKH,eAAe,CAAC,CAAC,EAAEG,KAAKF,cAAc,EAAE,GAChD;oBACJvB,YAAYyB,KAAKzB,UAAU;gBAC7B,CAAA;QACF,EAAE,OAAOvH,OAAO;YACdnC,QAAQmC,KAAK,CAAC,kCAAkCA;YAChD,MAAMA;QACR;IACF;IAEA,MAAMmJ,mBAAmB5B,UAAkB,EAAE;QAC3C,IAAI;YACF,qDAAqD;YACrD,MAAM6B,cAAc,MAAM,IAAI,CAACpL,EAAE,CAC9BC,MAAM,CAAC;gBACN0F,IAAIpF,YAAK,CAACoF,EAAE;gBACZlB,WAAWlE,YAAK,CAACkE,SAAS;gBAC1BC,UAAUnE,YAAK,CAACmE,QAAQ;gBACxBC,OAAOpE,YAAK,CAACoE,KAAK;gBAClBsF,aAAa1J,YAAK,CAAC0J,WAAW;gBAC9BI,YAAYvJ,iBAAK,CAACuJ,UAAU;gBAC5BgB,aAAaV,cAAM,CAACU,WAAW;gBAC/BC,cAAcX,cAAM,CAACY,OAAO;gBAC5BX,aAAaD,cAAM,CAACvJ,MAAM;YAC5B,GACCd,IAAI,CAACqK,cAAM,EACXa,SAAS,CAACjL,YAAK,EAAEY,IAAAA,cAAE,EAACwJ,cAAM,CAACD,QAAQ,EAAEnK,YAAK,CAACoF,EAAE,GAC7C6F,SAAS,CAAC1K,iBAAK,EAAEK,IAAAA,cAAE,EAACwJ,cAAM,CAACI,MAAM,EAAEjK,iBAAK,CAAC6E,EAAE,GAC3CzE,KAAK,CACJ+B,IAAAA,eAAG,EACD9B,IAAAA,cAAE,EAACwJ,cAAM,CAACpB,UAAU,EAAEA,aACtBpI,IAAAA,cAAE,EAACwJ,cAAM,CAACvJ,MAAM,EAAE,YAGrB+B,OAAO,CAACrC,iBAAK,CAACuJ,UAAU;YAE3B,2CAA2C;YAC3C,4DAA4D;YAC5D,OAAOe,YAAY9H,GAAG,CAACmI,CAAAA,SAAW,CAAA;oBAChC9F,IAAI8F,OAAO9F,EAAE;oBACblB,WAAWgH,OAAOhH,SAAS;oBAC3BC,UAAU+G,OAAO/G,QAAQ;oBACzBC,OAAO8G,OAAO9G,KAAK;oBACnBsF,aAAawB,OAAOxB,WAAW;oBAC/BI,YAAYoB,OAAOpB,UAAU;oBAC7BY,YAAYvJ,OAAO+J,OAAOJ,WAAW;oBACrCC,cAAcG,OAAOH,YAAY;oBACjClK,QAAQ;gBACV,CAAA;QACF,EAAE,OAAOY,OAAO;YACdnC,QAAQmC,KAAK,CAAC,oCAAoCA;YAClD,MAAMA;QACR;IACF;IAEA,MAAM0J,uBAAuBnC,UAAkB,EAAE;QAC/C,IAAI;YACF,yEAAyE;YACzE,MAAM9F,kBAAkB,MAAM,IAAI,CAACzD,EAAE,CAClCC,MAAM,CAAC;gBACN0F,IAAI7B,6BAAmB,CAAC6B,EAAE;gBAC1BgG,OAAO7H,6BAAmB,CAAC6H,KAAK;gBAChC9C,aAAa/E,6BAAmB,CAAC+E,WAAW;gBAC5CzH,QAAQ0C,6BAAmB,CAAC1C,MAAM;gBAClCwK,UAAU9H,6BAAmB,CAAC8H,QAAQ;gBACtC9C,QAAQhF,6BAAmB,CAACgF,MAAM;gBAClChE,WAAWhB,6BAAmB,CAACgB,SAAS;gBACxC+G,aAAa/H,6BAAmB,CAAC+H,WAAW;gBAC5ChB,iBAAiB1K,IAAAA,eAAG,CAAQ,CAAC,iBAAiB,CAAC;gBAC/C2K,gBAAgB3K,IAAAA,eAAG,CAAQ,CAAC,gBAAgB,CAAC;gBAC7CkK,YAAYlK,IAAAA,eAAG,CAAQ,CAAC,gBAAgB,CAAC;gBACzC2L,qBAAqB3L,IAAAA,eAAG,CAAQ,CAAC,yBAAyB,CAAC;gBAC3D4L,oBAAoB5L,IAAAA,eAAG,CAAQ,CAAC,wBAAwB,CAAC;YAC3D,GACCG,IAAI,CAACwD,6BAAmB,EACxBuF,QAAQ,CAAClJ,IAAAA,eAAG,CAAA,CAAC,eAAe,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,EAAE2D,6BAAmB,CAAC4G,QAAQ,CAAC,YAAY,CAAC,EAC/ErB,QAAQ,CAAClJ,IAAAA,eAAG,CAAA,CAAC,sBAAsB,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,kEAAkE,EAAEoJ,WAAW,mCAAmC,CAAC,EAC7JF,QAAQ,CAAClJ,IAAAA,eAAG,CAAA,CAAC,aAAa,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,8BAA8B,CAAC,EAChEkJ,QAAQ,CAAClJ,IAAAA,eAAG,CAAA,CAAC,uBAAuB,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,EAAE2D,6BAAmB,CAACkI,UAAU,CAAC,oBAAoB,CAAC,EACjG9K,KAAK,CAACC,IAAAA,cAAE,EAAC2C,6BAAmB,CAACyF,UAAU,EAAEA,aACzCpG,OAAO,CAAChD,IAAAA,eAAG,CAAA,CAAC,EAAE2D,6BAAmB,CAACgB,SAAS,CAAC,KAAK,CAAC;YAErD,oDAAoD;YACpD,OAAOrB,gBAAgBH,GAAG,CAAC2I,CAAAA,UAAY,CAAA;oBACrCtG,IAAIsG,QAAQtG,EAAE;oBACduG,OAAOD,QAAQN,KAAK;oBACpB9C,aAAaoD,QAAQpD,WAAW;oBAChCzH,QAAQ6K,QAAQ7K,MAAM;oBACtBwK,UAAUK,QAAQL,QAAQ,IAAI;oBAC9B9C,QAAQmD,QAAQnD,MAAM,IAAI,EAAE;oBAC5B2C,QAAQQ,QAAQpB,eAAe,IAAIoB,QAAQnB,cAAc,GACrD,GAAGmB,QAAQpB,eAAe,CAAC,CAAC,EAAEoB,QAAQnB,cAAc,EAAE,GACtD;oBACJE,MAAMiB,QAAQ5B,UAAU,IAAI;oBAC5B8B,eAAeF,QAAQH,mBAAmB,IAAIG,QAAQF,kBAAkB,GACpE,GAAGE,QAAQH,mBAAmB,CAAC,CAAC,EAAEG,QAAQF,kBAAkB,EAAE,GAC9D;oBACJjH,WAAWmH,QAAQnH,SAAS;oBAC5BsH,YAAYH,QAAQ7K,MAAM,KAAK,cAAc6K,QAAQJ,WAAW,GAAG;gBACrE,CAAA;QACF,EAAE,OAAO7J,OAAO;YACdnC,QAAQmC,KAAK,CAAC,wCAAwCA;YACtD,OAAO,EAAE;QACX;IACF;IAEA,MAAMqK,oBAAoB9C,UAAkB,EAAE;QAC5C,IAAI;YACF,6DAA6D;YAC7D,MAAM+C,eAAe,MAAM,IAAI,CAACtM,EAAE,CAC/BC,MAAM,CAAC;gBACN0F,IAAI3C,kBAAQ,CAAC2C,EAAE;gBACf5C,QAAQC,kBAAQ,CAACD,MAAM;gBACvBwJ,YAAYvJ,kBAAQ,CAACuJ,UAAU;gBAC/BC,SAASxJ,kBAAQ,CAACwJ,OAAO;gBACzBC,UAAUzJ,kBAAQ,CAACyJ,QAAQ;gBAC3BrL,QAAQ4B,kBAAQ,CAAC5B,MAAM;gBACvByJ,iBAAiB1K,IAAAA,eAAG,CAAQ,CAAC,iBAAiB,CAAC;gBAC/C2K,gBAAgB3K,IAAAA,eAAG,CAAQ,CAAC,gBAAgB,CAAC;gBAC7CkK,YAAYvJ,iBAAK,CAACuJ,UAAU;YAC9B,GACC/J,IAAI,CAAC0C,kBAAQ,EACbwI,SAAS,CAACrL,IAAAA,eAAG,CAAA,CAAC,eAAe,CAAC,EAAEA,IAAAA,eAAG,CAAA,CAAC,EAAE6C,kBAAQ,CAAC0H,QAAQ,CAAC,YAAY,CAAC,EACrEc,SAAS,CAAC1K,iBAAK,EAAEK,IAAAA,cAAE,EAAC6B,kBAAQ,CAAC+H,MAAM,EAAEjK,iBAAK,CAAC6E,EAAE,GAC7CzE,KAAK,CAACC,IAAAA,cAAE,EAAC6B,kBAAQ,CAACuG,UAAU,EAAEA,aAC9BpG,OAAO,CAAChD,IAAAA,eAAG,CAAA,CAAC,EAAE6C,kBAAQ,CAACwJ,OAAO,CAAC,KAAK,CAAC;YAExC,oDAAoD;YACpD,OAAOF,aAAahJ,GAAG,CAACoJ,CAAAA;gBACtB,MAAMC,WAAWjL,OAAOgL,QAAQ3J,MAAM;gBACtC,MAAM6J,OAAOlL,OAAOgL,QAAQH,UAAU;gBACtC,MAAMM,UAAUF,WAAWC;gBAE3B,OAAO;oBACLjH,IAAI+G,QAAQ/G,EAAE;oBACduF,YAAY,GAAGwB,QAAQ7B,eAAe,CAAC,CAAC,EAAE6B,QAAQ5B,cAAc,EAAE;oBAClET,YAAYqC,QAAQrC,UAAU;oBAC9BsC;oBACAC;oBACAC;oBACAzL,QAAQsL,QAAQtL,MAAM;oBACtBoL,SAASE,QAAQF,OAAO;oBACxBM,aAAaJ,QAAQD,QAAQ;gBAC/B;YACF;QACF,EAAE,OAAOzK,OAAO;YACdnC,QAAQmC,KAAK,CAAC,qCAAqCA;YACnD,OAAO,EAAE;QACX;IACF;IAEA,MAAM+K,0BAA0BC,UAK5B,CAAC,CAAC,EAAE;QACN,IAAI;YACF,MAAM,EAAE5L,MAAM,EAAEwK,QAAQ,EAAEzH,OAAO,CAAC,EAAEC,QAAQ,EAAE,EAAE,GAAG4I;YACnD,MAAMzI,SAAS,AAACJ,CAAAA,OAAO,CAAA,IAAKC;YAE5B,yBAAyB;YACzB,MAAM6I,aAAoB,EAAE;YAC5B,IAAI7L,QAAQ;gBACV6L,WAAWC,IAAI,CAAC/L,IAAAA,cAAE,EAAC2C,6BAAmB,CAAC1C,MAAM,EAAEA;YACjD;YACA,IAAIwK,UAAU;gBACZqB,WAAWC,IAAI,CAAC/L,IAAAA,cAAE,EAAC2C,6BAAmB,CAAC8H,QAAQ,EAAEA;YACnD;YAEA,kFAAkF;YAClF/L,QAAQC,GAAG,CAAC,kDAAkD;gBAAEsB;gBAAQwK;gBAAUzH;gBAAMC;YAAM;YAE9F,wEAAwE;YACxE,MAAM+I,QAAQ,IAAI,CAACnN,EAAE,CAClBC,MAAM,CAAC;gBACN0F,IAAI7B,6BAAmB,CAAC6B,EAAE;gBAC1BgG,OAAO7H,6BAAmB,CAAC6H,KAAK;gBAChC9C,aAAa/E,6BAAmB,CAAC+E,WAAW;gBAC5CzH,QAAQ0C,6BAAmB,CAAC1C,MAAM;gBAClCwK,UAAU9H,6BAAmB,CAAC8H,QAAQ;gBACtC9C,QAAQhF,6BAAmB,CAACgF,MAAM;gBAClChE,WAAWhB,6BAAmB,CAACgB,SAAS;gBACxC+G,aAAa/H,6BAAmB,CAAC+H,WAAW;gBAC5CuB,cAAczM,sBAAU,CAAC0H,IAAI;gBAC7BkB,YAAY5I,sBAAU,CAACgF,EAAE;gBACzB+E,UAAU5G,6BAAmB,CAAC4G,QAAQ;gBACtC7E,YAAY/B,6BAAmB,CAAC+B,UAAU;gBAC1CmG,YAAYlI,6BAAmB,CAACkI,UAAU;YAC5C,GACC1L,IAAI,CAACwD,6BAAmB,EACxB0H,SAAS,CAAC7K,sBAAU,EAAEQ,IAAAA,cAAE,EAAC2C,6BAAmB,CAACyF,UAAU,EAAE5I,sBAAU,CAACgF,EAAE,GACtExC,OAAO,CAAChD,IAAAA,eAAG,CAAA,CAAC,EAAE2D,6BAAmB,CAACgB,SAAS,CAAC,KAAK,CAAC,EAClDV,KAAK,CAACA,OACNG,MAAM,CAACA;YAEV,MAAMd,kBAAkBwJ,WAAW7J,MAAM,GAAG,IACxC,MAAM+J,MAAMjM,KAAK,CAAC+B,IAAAA,eAAG,KAAIgK,eACzB,MAAME;YAEVtN,QAAQC,GAAG,CAAC,CAAC,SAAS,EAAE2D,gBAAgBL,MAAM,CAAC,qBAAqB,CAAC;YACrEvD,QAAQC,GAAG,CAAC,gBAAgB2D,gBAAgB4J,KAAK,CAAC,GAAG;YAErD,8EAA8E;YAC9E,MAAMC,kBAAyB,EAAE;YAEjC,KAAK,MAAMrB,WAAWxI,gBAAiB;gBACrC,kCAAkC;gBAClC,IAAIyH,aAAa;gBACjB,IAAIb,aAAa;gBACjB,IAAI4B,QAAQvB,QAAQ,EAAE;oBACpB,IAAI;wBACF,MAAM,CAACe,OAAO,GAAG,MAAM,IAAI,CAACzL,EAAE,CAC3BC,MAAM,CAAC;4BACNwE,WAAWlE,YAAK,CAACkE,SAAS;4BAC1BC,UAAUnE,YAAK,CAACmE,QAAQ;wBAC1B,GACCpE,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEsG,QAAQvB,QAAQ,GACnCtG,KAAK,CAAC;wBAET,IAAIqH,QAAQ;4BACVP,aAAa,GAAGO,OAAOhH,SAAS,CAAC,CAAC,EAAEgH,OAAO/G,QAAQ,EAAE;wBACvD;wBAEA,uDAAuD;wBACvD,MAAM,CAAC6I,MAAM,GAAG,MAAM,IAAI,CAACvN,EAAE,CAC1BC,MAAM,CAAC;4BACNoK,YAAYvJ,iBAAK,CAACuJ,UAAU;wBAC9B,GACC/J,IAAI,CAACqK,cAAM,EACXa,SAAS,CAAC1K,iBAAK,EAAEK,IAAAA,cAAE,EAACwJ,cAAM,CAACI,MAAM,EAAEjK,iBAAK,CAAC6E,EAAE,GAC3CzE,KAAK,CACJ+B,IAAAA,eAAG,EACD9B,IAAAA,cAAE,EAACwJ,cAAM,CAACD,QAAQ,EAAEuB,QAAQvB,QAAQ,GACpCvJ,IAAAA,cAAE,EAACwJ,cAAM,CAACpB,UAAU,EAAE0C,QAAQ1C,UAAU,GACxCpI,IAAAA,cAAE,EAACwJ,cAAM,CAACvJ,MAAM,EAAE,YAGrBgD,KAAK,CAAC;wBAET,IAAImJ,OAAO;4BACTlD,aAAakD,MAAMlD,UAAU;wBAC/B;oBACF,EAAE,OAAOrI,OAAO;wBACdnC,QAAQmC,KAAK,CAAC,oCAAoCA;oBACpD;gBACF;gBAEA,0BAA0B;gBAC1B,IAAImK,gBAAgB;gBACpB,IAAIF,QAAQD,UAAU,EAAE;oBACtB,IAAI;wBACF,MAAM,CAACwB,MAAM,GAAG,MAAM,IAAI,CAACxN,EAAE,CAC1BC,MAAM,CAAC;4BACNwE,WAAWlE,YAAK,CAACkE,SAAS;4BAC1BC,UAAUnE,YAAK,CAACmE,QAAQ;wBAC1B,GACCpE,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEsG,QAAQD,UAAU,GACrC5H,KAAK,CAAC;wBAET,IAAIoJ,OAAO;4BACTrB,gBAAgB,GAAGqB,MAAM/I,SAAS,CAAC,CAAC,EAAE+I,MAAM9I,QAAQ,EAAE;wBACxD;oBACF,EAAE,OAAO1C,OAAO;wBACdnC,QAAQmC,KAAK,CAAC,yBAAyBA;oBACzC;gBACF;gBAEA,qCAAqC;gBACrC,IAAImH,kBAAkB;gBACtB,IAAIC,mBAAkC;gBACtC,IAAIqE,mBAAkC;gBACtC,IAAI;oBACF,MAAM,CAAC1D,SAAS,GAAG,MAAM,IAAI,CAAC/J,EAAE,CAC7BC,MAAM,CAAC;wBACN+I,eAAerI,sBAAU,CAACqI,aAAa;oBACzC,GACC1I,IAAI,CAACK,sBAAU,EACfO,KAAK,CAACC,IAAAA,cAAE,EAACR,sBAAU,CAACgF,EAAE,EAAEsG,QAAQ1C,UAAU,GAC1CnF,KAAK,CAAC;oBAET,IAAI2F,UAAUf,eAAe;wBAC3B,MAAM,CAACQ,YAAY,GAAG,MAAM,IAAI,CAACxJ,EAAE,CAChCC,MAAM,CAAC;4BACNwE,WAAWlE,YAAK,CAACkE,SAAS;4BAC1BC,UAAUnE,YAAK,CAACmE,QAAQ;4BACxBC,OAAOpE,YAAK,CAACoE,KAAK;4BAClBsF,aAAa1J,YAAK,CAAC0J,WAAW;wBAChC,GACC3J,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAEoE,SAASf,aAAa,GACzC5E,KAAK,CAAC;wBAET,IAAIoF,aAAa;4BACfL,kBAAkB,GAAGK,YAAY/E,SAAS,CAAC,CAAC,EAAE+E,YAAY9E,QAAQ,EAAE;4BACpE0E,mBAAmBI,YAAY7E,KAAK;4BACpC8I,mBAAmBjE,YAAYS,WAAW;wBAC5C;oBACF;gBACF,EAAE,OAAOjI,OAAO;oBACdnC,QAAQmC,KAAK,CAAC,+BAA+BA;gBAC/C;gBAEAsL,gBAAgBJ,IAAI,CAAC;oBACnBvH,IAAIsG,QAAQtG,EAAE;oBACduG,OAAOD,QAAQN,KAAK;oBACpBA,OAAOM,QAAQN,KAAK;oBACpB9C,aAAaoD,QAAQpD,WAAW;oBAChCzH,QAAQ6K,QAAQ7K,MAAM;oBACtBwK,UAAUK,QAAQL,QAAQ,IAAI;oBAC9B9C,QAAQmD,QAAQnD,MAAM,IAAI,EAAE;oBAC5BsE,cAAcnB,QAAQmB,YAAY;oBAClC7D,YAAY0C,QAAQ1C,UAAU;oBAC9BmE,YAAYxC;oBACZO,QAAQP;oBACRb,YAAYA;oBACZW,MAAMX;oBACN8B;oBACAhD;oBACAC;oBACAqE;oBACA3I,WAAWmH,QAAQnH,SAAS;oBAC5BsH,YAAYH,QAAQ7K,MAAM,KAAK,cAAc6K,QAAQJ,WAAW,GAAG;gBACrE;YACF;YAEAhM,QAAQC,GAAG,CAAC,mCAAmCwN;YAC/C,OAAOA;QACT,EAAE,OAAOtL,OAAO;YACdnC,QAAQmC,KAAK,CAAC,4CAA4CA;YAC1D,OAAO,EAAE;QACX;IACF;IAEA,wBAAwB;IACxB,MAAM2L,sBAAsBC,OAAe,EAAE;QAC3C,IAAI;YACF,qDAAqD;YACrD,MAAMC,gBAAgB,MAAM,IAAI,CAAC7N,EAAE,CAChCC,MAAM,CAAC;gBACN0F,IAAImI,kBAAQ,CAACnI,EAAE;gBACfoI,UAAUD,kBAAQ,CAACC,QAAQ;gBAC3BC,YAAYF,kBAAQ,CAACE,UAAU;gBAC/BC,SAASH,kBAAQ,CAACG,OAAO;gBACzBC,SAASJ,kBAAQ,CAACI,OAAO;gBACzBC,QAAQL,kBAAQ,CAACK,MAAM;gBACvBrJ,WAAWgJ,kBAAQ,CAAChJ,SAAS;YAC/B,GACCxE,IAAI,CAACwN,kBAAQ,EACb5M,KAAK,CACJkN,IAAAA,cAAE,EACAjN,IAAAA,cAAE,EAAC2M,kBAAQ,CAACC,QAAQ,EAAEH,UACtBzM,IAAAA,cAAE,EAAC2M,kBAAQ,CAACE,UAAU,EAAEJ,WAG3BzK,OAAO,CAAChD,IAAAA,eAAG,CAAA,CAAC,EAAE2N,kBAAQ,CAAChJ,SAAS,CAAC,KAAK,CAAC;YAE1C,6CAA6C;YAC7C,MAAMuJ,mBAAmB,IAAIrI;YAE7B,KAAK,MAAM+B,WAAW8F,cAAe;gBACnC,MAAMS,cAAcvG,QAAQgG,QAAQ,KAAKH,UAAU7F,QAAQiG,UAAU,GAAGjG,QAAQgG,QAAQ;gBAExF,IAAI,CAACM,iBAAiBE,GAAG,CAACD,cAAc;oBACtC,+BAA+B;oBAC/B,MAAM,CAACE,UAAU,GAAG,MAAM,IAAI,CAACxO,EAAE,CAC9BC,MAAM,CAAC;wBACNwE,WAAWlE,YAAK,CAACkE,SAAS;wBAC1BC,UAAUnE,YAAK,CAACmE,QAAQ;wBACxBL,MAAM9D,YAAK,CAAC8D,IAAI;oBAClB,GACC/D,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAE2I;oBAEtB,IAAIE,WAAW;wBACb,uCAAuC;wBACvC,MAAMC,iBAAiB,MAAM,IAAI,CAACzO,EAAE,CACjCC,MAAM,GACNK,IAAI,CAACwN,kBAAQ,EACb5M,KAAK,CACJ+B,IAAAA,eAAG,EACD9B,IAAAA,cAAE,EAAC2M,kBAAQ,CAACC,QAAQ,EAAEO,cACtBnN,IAAAA,cAAE,EAAC2M,kBAAQ,CAACE,UAAU,EAAEJ,UACxBzM,IAAAA,cAAE,EAAC2M,kBAAQ,CAACK,MAAM,EAAE;wBAI1BE,iBAAiB3G,GAAG,CAAC4G,aAAa;4BAChC3I,IAAI2I;4BACJjG,MAAM,GAAGmG,UAAU/J,SAAS,CAAC,CAAC,EAAE+J,UAAU9J,QAAQ,EAAE;4BACpDL,MAAMmK,UAAUnK,IAAI;4BACpBqK,aAAa3G,QAAQkG,OAAO;4BAC5BU,iBAAiB5G,QAAQjD,SAAS;4BAClC8J,aAAaH,eAAerL,MAAM;4BAClCyL,OAAO9G,QAAQgG,QAAQ,KAAKH;wBAC9B;oBACF;gBACF;YACF;YAEA,OAAOkB,MAAMxO,IAAI,CAAC+N,iBAAiBpH,MAAM;QAC3C,EAAE,OAAOjF,OAAO;YACdnC,QAAQmC,KAAK,CAAC,sCAAsCA;YACpD,OAAO,EAAE;QACX;IACF;IAEA,MAAM+M,qBACJnB,OAAe,EACfU,WAAmB,EACnBU,UAA2C,EAC3C;QACA,IAAI;YACF,MAAM,EAAE7K,OAAO,CAAC,EAAEC,QAAQ,EAAE,EAAE,GAAG4K;YACjC,MAAMzK,SAAS,AAACJ,CAAAA,OAAO,CAAA,IAAKC;YAE5B,MAAM6K,eAAe,MAAM,IAAI,CAACjP,EAAE,CAC/BC,MAAM,CAAC;gBACN0F,IAAImI,kBAAQ,CAACnI,EAAE;gBACfoI,UAAUD,kBAAQ,CAACC,QAAQ;gBAC3BC,YAAYF,kBAAQ,CAACE,UAAU;gBAC/BE,SAASJ,kBAAQ,CAACI,OAAO;gBACzBD,SAASH,kBAAQ,CAACG,OAAO;gBACzBE,QAAQL,kBAAQ,CAACK,MAAM;gBACvBrJ,WAAWgJ,kBAAQ,CAAChJ,SAAS;YAC/B,GACCxE,IAAI,CAACwN,kBAAQ,EACb5M,KAAK,CACJkN,IAAAA,cAAE,EACAnL,IAAAA,eAAG,EAAC9B,IAAAA,cAAE,EAAC2M,kBAAQ,CAACC,QAAQ,EAAEH,UAAUzM,IAAAA,cAAE,EAAC2M,kBAAQ,CAACE,UAAU,EAAEM,eAC5DrL,IAAAA,eAAG,EAAC9B,IAAAA,cAAE,EAAC2M,kBAAQ,CAACC,QAAQ,EAAEO,cAAcnN,IAAAA,cAAE,EAAC2M,kBAAQ,CAACE,UAAU,EAAEJ,YAGnEzK,OAAO,CAAChD,IAAAA,eAAG,CAAA,CAAC,EAAE2N,kBAAQ,CAAChJ,SAAS,CAAC,IAAI,CAAC,EACtCV,KAAK,CAACA,OACNG,MAAM,CAACA;YAEV,wCAAwC;YACxC,MAAM,IAAI,CAACvE,EAAE,CACVyH,MAAM,CAACqG,kBAAQ,EACfpG,GAAG,CAAC;gBACHyG,QAAQ;gBACRe,QAAQ,IAAI9M;gBACZuF,WAAW,IAAIvF;YACjB,GACClB,KAAK,CACJ+B,IAAAA,eAAG,EACD9B,IAAAA,cAAE,EAAC2M,kBAAQ,CAACC,QAAQ,EAAEO,cACtBnN,IAAAA,cAAE,EAAC2M,kBAAQ,CAACE,UAAU,EAAEJ,UACxBzM,IAAAA,cAAE,EAAC2M,kBAAQ,CAACK,MAAM,EAAE;YAI1B,OAAOc,aAAa3L,GAAG,CAAC6L,CAAAA,MAAQ,CAAA;oBAC9BxJ,IAAIwJ,IAAIxJ,EAAE;oBACVoI,UAAUoB,IAAIpB,QAAQ;oBACtBE,SAASkB,IAAIlB,OAAO;oBACpBC,SAASiB,IAAIjB,OAAO;oBACpBkB,WAAWD,IAAIrK,SAAS;oBACxB+J,OAAOM,IAAIpB,QAAQ,KAAKH;oBACxBO,QAAQgB,IAAIhB,MAAM;gBACpB,CAAA;QACF,EAAE,OAAOnM,OAAO;YACdnC,QAAQmC,KAAK,CAAC,qCAAqCA;YACnD,OAAO,EAAE;QACX;IACF;IAEA,MAAMqN,iBACJzB,OAAe,EACf0B,UAAqE,EACrE;QACA,IAAI;YACF,yBAAyB;YACzB,MAAM,CAACC,SAAS,GAAG,MAAM,IAAI,CAACvP,EAAE,CAC7BC,MAAM,GACNK,IAAI,CAACC,YAAK,EACVW,KAAK,CAACC,IAAAA,cAAE,EAACZ,YAAK,CAACoF,EAAE,EAAE2J,WAAWtB,UAAU;YAE3C,IAAI,CAACuB,UAAU;gBACb,MAAM,IAAIlI,yBAAiB,CAAC;YAC9B;YAEA,MAAMmI,cAAc;gBAClBzB,UAAUH;gBACVI,YAAYsB,WAAWtB,UAAU;gBACjCE,SAASoB,WAAWpB,OAAO,IAAI;gBAC/BD,SAASqB,WAAWrB,OAAO;YAC7B;YAEA,MAAM,CAAClG,QAAQ,GAAG,MAAM,IAAI,CAAC/H,EAAE,CAACgH,MAAM,CAAC8G,kBAAQ,EAAE7G,MAAM,CAACuI,aAAarI,SAAS;YAC9E,OAAOY;QACT,EAAE,OAAO/F,OAAO;YACdnC,QAAQmC,KAAK,CAAC,gCAAgCA;YAC9C,MAAMA;QACR;IACF;IAEA,MAAMyN,oBAAoB7B,OAAe,EAAE;QACzC,IAAI;YACF,MAAMa,iBAAiB,MAAM,IAAI,CAACzO,EAAE,CACjCC,MAAM,GACNK,IAAI,CAACwN,kBAAQ,EACb5M,KAAK,CACJ+B,IAAAA,eAAG,EACD9B,IAAAA,cAAE,EAAC2M,kBAAQ,CAACE,UAAU,EAAEJ,UACxBzM,IAAAA,cAAE,EAAC2M,kBAAQ,CAACK,MAAM,EAAE;YAI1B,OAAO;gBAAEzN,OAAO+N,eAAerL,MAAM;YAAC;QACxC,EAAE,OAAOpB,OAAO;YACdnC,QAAQmC,KAAK,CAAC,qCAAqCA;YACnD,OAAO;gBAAEtB,OAAO;YAAE;QACpB;IACF;IA5qCA,YACE,AACiBV,EAAuB,CACxC;aADiBA,KAAAA;IAChB;AA2qCL"}