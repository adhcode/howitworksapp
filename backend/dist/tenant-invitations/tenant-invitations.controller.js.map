{"version":3,"sources":["../../src/tenant-invitations/tenant-invitations.controller.ts"],"sourcesContent":["import { Controller, Post, Get, Body, Param, UseGuards, Request, Patch, Delete } from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { TenantInvitationsService } from './tenant-invitations.service';\nimport { CreateTenantInvitationDto, AcceptInvitationDto, TenantSignupWithTokenDto } from './dto/tenant-invitation.dto';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\nimport * as bcrypt from 'bcryptjs';\n\n@ApiTags('tenant-invitations')\n@Controller('tenant-invitations')\nexport class TenantInvitationsController {\n  constructor(\n    private readonly tenantInvitationsService: TenantInvitationsService,\n    private readonly usersService: UsersService,\n    private readonly jwtService: JwtService,\n  ) {}\n\n  @Post()\n  @UseGuards(JwtAuthGuard)\n  @ApiBearerAuth()\n  @ApiOperation({ summary: 'Create a tenant invitation' })\n  @ApiResponse({ status: 201, description: 'Invitation created successfully' })\n  async createInvitation(\n    @Body() createInvitationDto: CreateTenantInvitationDto,\n    @Request() req: any,\n  ) {\n    // Debug logging to check the user object\n    console.log('=== CONTROLLER DEBUG ===');\n    console.log('req.user:', JSON.stringify(req.user, null, 2));\n    console.log('req.user.id:', req.user.id);\n    console.log('req.user.id type:', typeof req.user.id);\n    console.log('createInvitationDto:', JSON.stringify(createInvitationDto, null, 2));\n    \n    // Check if landlordId is valid\n    const landlordId = req.user.id;\n    if (!landlordId) {\n      throw new Error('Landlord ID is missing from request');\n    }\n    \n    console.log('Final landlordId to pass:', landlordId);\n    console.log('=== END CONTROLLER DEBUG ===');\n\n    const invitation = await this.tenantInvitationsService.createInvitation({\n      ...createInvitationDto,\n      landlordId: landlordId,\n    });\n\n\n\n    return {\n      success: true,\n      data: {\n        ...invitation,\n        invitationUrl: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/auth/tenant-signup?token=${invitation.invitationToken}`,\n      },\n    };\n  }\n\n  @Get('token/:token')\n  @ApiOperation({ summary: 'Get invitation details by token' })\n  @ApiResponse({ status: 200, description: 'Invitation details retrieved' })\n  async getInvitationByToken(@Param('token') token: string) {\n    const invitation = await this.tenantInvitationsService.getInvitationByToken(token);\n    \n    if (!invitation) {\n      return {\n        success: false,\n        data: null,\n        message: 'Invitation not found',\n      };\n    }\n\n    return {\n      success: true,\n      data: invitation,\n    };\n  }\n\n  @Post('accept')\n  @UseGuards(JwtAuthGuard)\n  @ApiBearerAuth()\n  @ApiOperation({ summary: 'Accept a tenant invitation' })\n  @ApiResponse({ status: 200, description: 'Invitation accepted successfully' })\n  async acceptInvitation(\n    @Body() acceptInvitationDto: AcceptInvitationDto,\n    @Request() req: any,\n  ) {\n    const invitation = await this.tenantInvitationsService.acceptInvitation(\n      acceptInvitationDto.token,\n      req.user.id,\n    );\n\n    return {\n      success: true,\n      data: invitation,\n      message: 'Invitation accepted successfully',\n    };\n  }\n\n  @Get('my-invitations')\n  @UseGuards(JwtAuthGuard)\n  @ApiBearerAuth()\n  @ApiOperation({ summary: 'Get invitations created by landlord' })\n  @ApiResponse({ status: 200, description: 'Invitations retrieved successfully' })\n  async getMyInvitations(@Request() req: any) {\n    console.log('ðŸ” GET /my-invitations called');\n    console.log('ðŸ” Landlord ID from JWT:', req.user.id);\n    console.log('ðŸ” User object:', JSON.stringify(req.user, null, 2));\n    \n    const invitations = await this.tenantInvitationsService.getInvitationsByLandlord(req.user.id);\n    \n    console.log('ðŸ” Invitations found:', invitations.length);\n    if (invitations.length > 0) {\n      console.log('ðŸ” First invitation:', JSON.stringify(invitations[0], null, 2));\n    }\n\n    return {\n      success: true,\n      data: invitations,\n    };\n  }\n\n  @Get('my-tenants')\n  @UseGuards(JwtAuthGuard)\n  @ApiBearerAuth()\n  @ApiOperation({ summary: 'Get accepted tenants by landlord' })\n  @ApiResponse({ status: 200, description: 'Tenants retrieved successfully' })\n  async getMyTenants(@Request() req: any) {\n    const tenants = await this.tenantInvitationsService.getAcceptedTenantsByLandlord(req.user.id);\n\n    return {\n      success: true,\n      data: tenants,\n    };\n  }\n\n  @Patch(':id/cancel')\n  @UseGuards(JwtAuthGuard)\n  @ApiBearerAuth()\n  @ApiOperation({ summary: 'Cancel a tenant invitation' })\n  @ApiResponse({ status: 200, description: 'Invitation cancelled successfully' })\n  async cancelInvitation(\n    @Param('id') invitationId: string,\n    @Request() req: any,\n  ) {\n    await this.tenantInvitationsService.cancelInvitation(invitationId, req.user.id);\n\n    return {\n      success: true,\n      message: 'Invitation cancelled successfully',\n    };\n  }\n\n  @Get('validate/:token')\n  @ApiOperation({ summary: 'Validate invitation token' })\n  @ApiResponse({ status: 200, description: 'Token validation result' })\n  async validateToken(@Param('token') token: string) {\n    const isValid = await this.tenantInvitationsService.validateInvitationToken(token);\n\n    return {\n      success: true,\n      data: { isValid },\n    };\n  }\n\n  @Post('register-with-token')\n  @ApiOperation({ summary: 'Register tenant with invitation token' })\n  @ApiResponse({ status: 201, description: 'Tenant registered successfully' })\n  async registerWithToken(@Body() signupDto: TenantSignupWithTokenDto) {\n    console.log('=== TENANT REGISTRATION DEBUG ===');\n    console.log('Signup DTO:', JSON.stringify(signupDto, null, 2));\n    \n    // Get invitation details\n    const invitation = await this.tenantInvitationsService.getInvitationByToken(signupDto.token);\n    \n    console.log('Found invitation:', invitation ? 'YES' : 'NO');\n    if (invitation) {\n      console.log('Invitation status:', invitation.status);\n      console.log('Invitation expires at:', invitation.expiresAt);\n      console.log('Current time:', new Date());\n    }\n    \n    if (!invitation) {\n      console.log('REGISTRATION FAILED: Invalid invitation token');\n      return {\n        success: false,\n        message: 'Invalid invitation token',\n      };\n    }\n\n    if (invitation.status !== 'pending') {\n      console.log('REGISTRATION FAILED: Invitation status is', invitation.status);\n      return {\n        success: false,\n        message: 'Invitation is no longer valid',\n      };\n    }\n\n    if (new Date() > invitation.expiresAt) {\n      console.log('REGISTRATION FAILED: Invitation expired');\n      return {\n        success: false,\n        message: 'Invitation has expired',\n      };\n    }\n\n    // Check if user already exists with the provided email\n    console.log('Checking existing user with email:', signupDto.email);\n    const existingUser = await this.usersService.findByEmail(signupDto.email);\n    if (existingUser) {\n      console.log('REGISTRATION FAILED: User already exists');\n      return {\n        success: false,\n        message: 'User with this email already exists',\n      };\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(signupDto.password, 12);\n\n    // Create tenant user with the provided email\n    console.log('Creating user with data:', {\n      firstName: invitation.firstName,\n      lastName: invitation.lastName,\n      email: signupDto.email, // Use the email provided by the tenant\n      phoneNumber: signupDto.phone || invitation.phone,\n      role: 'tenant',\n    });\n    \n    const user = await this.usersService.create({\n      firstName: invitation.firstName,\n      lastName: invitation.lastName,\n      email: signupDto.email, // Use the email provided by the tenant\n      password: hashedPassword,\n      phoneNumber: signupDto.phone || invitation.phone || '',\n      role: 'tenant',\n      isActive: true,\n    });\n\n    console.log('User created successfully:', user.id);\n\n    // Accept the invitation\n    console.log('Accepting invitation...');\n    await this.tenantInvitationsService.acceptInvitation(signupDto.token, user.id);\n\n    // Generate JWT token\n    const payload = { sub: user.id, email: user.email, role: user.role };\n    const accessToken = this.jwtService.sign(payload);\n\n    console.log('REGISTRATION SUCCESS: User registered and invitation accepted');\n    console.log('=== END TENANT REGISTRATION DEBUG ===');\n\n    return {\n      success: true,\n      data: {\n        user: {\n          id: user.id,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          email: user.email,\n          role: user.role,\n        },\n        accessToken,\n      },\n      message: 'Account created successfully',\n    };\n  }\n}"],"names":["TenantInvitationsController","createInvitation","createInvitationDto","req","console","log","JSON","stringify","user","id","landlordId","Error","invitation","tenantInvitationsService","success","data","invitationUrl","process","env","FRONTEND_URL","invitationToken","getInvitationByToken","token","message","acceptInvitation","acceptInvitationDto","getMyInvitations","invitations","getInvitationsByLandlord","length","getMyTenants","tenants","getAcceptedTenantsByLandlord","cancelInvitation","invitationId","validateToken","isValid","validateInvitationToken","registerWithToken","signupDto","status","expiresAt","Date","email","existingUser","usersService","findByEmail","hashedPassword","bcrypt","hash","password","firstName","lastName","phoneNumber","phone","role","create","isActive","payload","sub","accessToken","jwtService","sign","summary","description"],"mappings":"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"}