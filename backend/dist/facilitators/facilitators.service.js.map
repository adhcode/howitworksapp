{"version":3,"sources":["../../src/facilitators/facilitators.service.ts"],"sourcesContent":["import { Injectable, Inject, NotFoundException, BadRequestException, ForbiddenException } from '@nestjs/common';\nimport { eq, and, or, desc, sql, count } from 'drizzle-orm';\nimport * as bcrypt from 'bcryptjs';\nimport * as crypto from 'crypto';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { users, properties, messages, maintenanceRequests, units, leases, payments } from '../database/schema';\nimport { CreateFacilitatorDto, AssignFacilitatorDto, FacilitatorStatsDto } from './dto/facilitator.dto';\n\n@Injectable()\nexport class FacilitatorsService {\n  constructor(@Inject(DATABASE_CONNECTION) private readonly db: any) {}\n\n  /**\n   * Create a new facilitator user\n   */\n  async createFacilitator(createFacilitatorDto: CreateFacilitatorDto) {\n    try {\n      // Check if email already exists\n      const existingUser = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.email, createFacilitatorDto.email))\n        .limit(1);\n\n      if (existingUser.length > 0) {\n        throw new BadRequestException('Email already exists');\n      }\n\n      // Hash password before storing\n      const hashedPassword = await bcrypt.hash(createFacilitatorDto.password, 10);\n\n      // Create facilitator user\n      const [facilitator] = await this.db\n        .insert(users)\n        .values({\n          ...createFacilitatorDto,\n          password: hashedPassword,\n          role: 'facilitator',\n          isActive: true,\n          isEmailVerified: true, // Auto-verify facilitators created by admin\n        })\n        .returning();\n\n      // Remove password from response\n      const { password, ...facilitatorResponse } = facilitator;\n      return facilitatorResponse;\n    } catch (error) {\n      console.error('Error creating facilitator:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get all facilitators\n   */\n  async getAllFacilitators() {\n    try {\n      const facilitators = await this.db\n        .select({\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          phoneNumber: users.phoneNumber,\n          isActive: users.isActive,\n          lastLoginAt: users.lastLoginAt,\n          createdAt: users.createdAt,\n        })\n        .from(users)\n        .where(eq(users.role, 'facilitator'))\n        .orderBy(desc(users.createdAt));\n\n      // Get property counts for each facilitator\n      const facilitatorsWithCounts = await Promise.all(\n        facilitators.map(async (facilitator) => {\n          const [propertyCount] = await this.db\n            .select({ count: count() })\n            .from(properties)\n            .where(eq(properties.facilitatorId, facilitator.id));\n\n          return {\n            ...facilitator,\n            assignedProperties: Number(propertyCount?.count || 0),\n          };\n        })\n      );\n\n      console.log('Facilitators with property counts:', facilitatorsWithCounts);\n      return facilitatorsWithCounts;\n    } catch (error) {\n      console.error('Error getting facilitators:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get facilitator by ID\n   */\n  async getFacilitatorById(facilitatorId: string) {\n    try {\n      const [facilitator] = await this.db\n        .select({\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          phoneNumber: users.phoneNumber,\n          nextOfKinName: users.nextOfKinName,\n          nextOfKinPhone: users.nextOfKinPhone,\n          nextOfKinRelationship: users.nextOfKinRelationship,\n          isActive: users.isActive,\n          lastLoginAt: users.lastLoginAt,\n          createdAt: users.createdAt,\n        })\n        .from(users)\n        .where(and(\n          eq(users.id, facilitatorId),\n          eq(users.role, 'facilitator')\n        ));\n\n      if (!facilitator) {\n        throw new NotFoundException('Facilitator not found');\n      }\n\n      return facilitator;\n    } catch (error) {\n      console.error('Error getting facilitator:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Assign facilitator to property\n   */\n  async assignFacilitatorToProperty(assignDto: AssignFacilitatorDto, adminId: string) {\n    try {\n      // Verify admin role\n      const [admin] = await this.db\n        .select()\n        .from(users)\n        .where(and(\n          eq(users.id, adminId),\n          eq(users.role, 'admin')\n        ));\n\n      if (!admin) {\n        throw new ForbiddenException('Only admins can assign facilitators');\n      }\n\n      // Verify facilitator exists and is active\n      const [facilitator] = await this.db\n        .select()\n        .from(users)\n        .where(and(\n          eq(users.id, assignDto.facilitatorId),\n          eq(users.role, 'facilitator'),\n          eq(users.isActive, true)\n        ));\n\n      if (!facilitator) {\n        throw new NotFoundException('Active facilitator not found');\n      }\n\n      // Verify property exists\n      const [property] = await this.db\n        .select()\n        .from(properties)\n        .where(eq(properties.id, assignDto.propertyId));\n\n      if (!property) {\n        throw new NotFoundException('Property not found');\n      }\n\n      // Update property with facilitator assignment\n      const [updatedProperty] = await this.db\n        .update(properties)\n        .set({\n          facilitatorId: assignDto.facilitatorId,\n          updatedAt: new Date(),\n        })\n        .where(eq(properties.id, assignDto.propertyId))\n        .returning();\n\n      return {\n        success: true,\n        message: `Facilitator ${facilitator.firstName} ${facilitator.lastName} assigned to property ${property.name}`,\n        property: updatedProperty,\n        facilitator: {\n          id: facilitator.id,\n          firstName: facilitator.firstName,\n          lastName: facilitator.lastName,\n          email: facilitator.email,\n        },\n      };\n    } catch (error) {\n      console.error('Error assigning facilitator:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Remove facilitator from property\n   */\n  async removeFacilitatorFromProperty(propertyId: string, adminId: string) {\n    try {\n      // Verify admin role\n      const [admin] = await this.db\n        .select()\n        .from(users)\n        .where(and(\n          eq(users.id, adminId),\n          eq(users.role, 'admin')\n        ));\n\n      if (!admin) {\n        throw new ForbiddenException('Only admins can remove facilitators');\n      }\n\n      // Update property to remove facilitator\n      const [updatedProperty] = await this.db\n        .update(properties)\n        .set({\n          facilitatorId: null,\n          updatedAt: new Date(),\n        })\n        .where(eq(properties.id, propertyId))\n        .returning();\n\n      if (!updatedProperty) {\n        throw new NotFoundException('Property not found');\n      }\n\n      return {\n        success: true,\n        message: 'Facilitator removed from property',\n        property: updatedProperty,\n      };\n    } catch (error) {\n      console.error('Error removing facilitator:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get properties assigned to a facilitator\n   */\n  async getFacilitatorProperties(facilitatorId: string) {\n    try {\n      const facilitatorProperties = await this.db\n        .select({\n          id: properties.id,\n          name: properties.name,\n          address: properties.address,\n          city: properties.city,\n          state: properties.state,\n          propertyType: properties.propertyType,\n          totalUnits: properties.totalUnits,\n          status: properties.status,\n          landlordId: properties.landlordId,\n          landlordFirstName: users.firstName,\n          landlordLastName: users.lastName,\n          landlordEmail: users.email,\n          createdAt: properties.createdAt,\n        })\n        .from(properties)\n        .leftJoin(users, eq(users.id, properties.landlordId))\n        .where(eq(properties.facilitatorId, facilitatorId))\n        .orderBy(desc(properties.createdAt));\n\n      // Transform to include full landlord name\n      return facilitatorProperties.map(prop => ({\n        ...prop,\n        landlordName: prop.landlordFirstName && prop.landlordLastName \n          ? `${prop.landlordFirstName} ${prop.landlordLastName}`\n          : null,\n      }));\n    } catch (error) {\n      console.error('Error getting facilitator properties:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Reset facilitator password\n   */\n  async resetPassword(facilitatorId: string): Promise<{ tempPassword: string }> {\n    try {\n      // Generate temporary password\n      const tempPassword = Math.random().toString(36).slice(-8) + Math.random().toString(36).slice(-8);\n      const hashedPassword = await bcrypt.hash(tempPassword, 10);\n\n      // Update password in database\n      await this.db\n        .update(users)\n        .set({ \n          password: hashedPassword,\n          updatedAt: new Date() \n        })\n        .where(and(\n          eq(users.id, facilitatorId),\n          eq(users.role, 'facilitator')\n        ));\n\n      return { tempPassword };\n    } catch (error) {\n      console.error('Error resetting password:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Update facilitator details\n   */\n  async updateFacilitator(facilitatorId: string, updateData: {\n    firstName?: string;\n    lastName?: string;\n    email?: string;\n    phoneNumber?: string;\n    nextOfKinName?: string;\n    nextOfKinPhone?: string;\n    nextOfKinRelationship?: string;\n  }) {\n    try {\n      const [facilitator] = await this.db\n        .update(users)\n        .set({ \n          ...updateData,\n          updatedAt: new Date() \n        })\n        .where(and(\n          eq(users.id, facilitatorId),\n          eq(users.role, 'facilitator')\n        ))\n        .returning({\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          phoneNumber: users.phoneNumber,\n          nextOfKinName: users.nextOfKinName,\n          nextOfKinPhone: users.nextOfKinPhone,\n          nextOfKinRelationship: users.nextOfKinRelationship,\n          isActive: users.isActive,\n          lastLoginAt: users.lastLoginAt,\n          createdAt: users.createdAt,\n        });\n\n      if (!facilitator) {\n        throw new NotFoundException('Facilitator not found');\n      }\n\n      return facilitator;\n    } catch (error) {\n      console.error('Error updating facilitator:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get facilitator dashboard statistics\n   */\n  async getFacilitatorStats(facilitatorId: string): Promise<FacilitatorStatsDto> {\n    try {\n      // Get assigned properties count\n      const assignedProperties = await this.db\n        .select()\n        .from(properties)\n        .where(eq(properties.facilitatorId, facilitatorId));\n\n      // Get pending maintenance requests for facilitator's properties\n      const pendingMaintenanceRequests = await this.db\n        .select()\n        .from(maintenanceRequests)\n        .leftJoin(properties, eq(properties.id, maintenanceRequests.propertyId))\n        .where(and(\n          eq(properties.facilitatorId, facilitatorId),\n          eq(maintenanceRequests.status, 'pending')\n        ));\n\n      // Get unread messages for facilitator\n      const unreadMessages = await this.db\n        .select()\n        .from(messages)\n        .where(and(\n          eq(messages.receiverId, facilitatorId),\n          eq(messages.isRead, false)\n        ));\n\n      // Get total tenants from active rent contracts for facilitator's properties\n      const { tenantRentContracts } = await import('../database/schema');\n      const activeTenantsQuery = await this.db\n        .select({ tenantId: tenantRentContracts.tenantId })\n        .from(tenantRentContracts)\n        .leftJoin(properties, eq(properties.id, tenantRentContracts.propertyId))\n        .where(and(\n          eq(properties.facilitatorId, facilitatorId),\n          eq(tenantRentContracts.status, 'active')\n        ));\n\n      const totalTenants = activeTenantsQuery.length;\n\n      return {\n        assignedProperties: assignedProperties.length,\n        pendingMaintenanceRequests: pendingMaintenanceRequests.length,\n        unreadMessages: unreadMessages.length,\n        totalTenants,\n      };\n    } catch (error) {\n      console.error('Error getting facilitator stats:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get tenants for facilitator's assigned properties\n   */\n  async getFacilitatorTenants(facilitatorId: string) {\n    try {\n      const tenants = await this.db\n        .select({\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          phoneNumber: users.phoneNumber,\n          propertyName: properties.name,\n          propertyId: properties.id,\n          unitNumber: units.unitNumber,\n          rentAmount: leases.monthlyRent,\n          leaseStartDate: leases.startDate,\n          leaseEndDate: leases.endDate,\n          leaseStatus: leases.status,\n        })\n        .from(leases)\n        .innerJoin(users, eq(users.id, leases.tenantId))\n        .innerJoin(properties, eq(properties.id, leases.propertyId))\n        .innerJoin(units, eq(units.id, leases.unitId))\n        .where(and(\n          eq(properties.facilitatorId, facilitatorId),\n          eq(leases.status, 'active')\n        ))\n        .orderBy(desc(leases.createdAt));\n\n      // Add payment status (this would need to be calculated based on payment records)\n      const tenantsWithStatus = tenants.map(tenant => ({\n        ...tenant,\n        status: 'paid' as const, // This should be calculated from payment records\n      }));\n\n      return tenantsWithStatus;\n    } catch (error) {\n      console.error('Error getting facilitator tenants:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get property details for facilitator (only if assigned to them)\n   */\n  async getFacilitatorPropertyById(propertyId: string, facilitatorId: string) {\n    try {\n      const [property] = await this.db\n        .select({\n          id: properties.id,\n          name: properties.name,\n          address: properties.address,\n          city: properties.city,\n          state: properties.state,\n          country: properties.country,\n          propertyType: properties.propertyType,\n          totalUnits: properties.totalUnits,\n          description: properties.description,\n          landlordId: properties.landlordId,\n          facilitatorId: properties.facilitatorId,\n          createdAt: properties.createdAt,\n          updatedAt: properties.updatedAt,\n          landlord: {\n            id: users.id,\n            firstName: users.firstName,\n            lastName: users.lastName,\n            email: users.email,\n            phoneNumber: users.phoneNumber,\n          },\n        })\n        .from(properties)\n        .leftJoin(users, eq(properties.landlordId, users.id))\n        .where(and(\n          eq(properties.id, propertyId),\n          eq(properties.facilitatorId, facilitatorId)\n        ))\n        .limit(1);\n\n      if (!property) {\n        throw new NotFoundException('Property not found or not assigned to you');\n      }\n\n      return property;\n    } catch (error) {\n      console.error('Error getting facilitator property:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get units for facilitator property\n   */\n  async getFacilitatorPropertyUnits(propertyId: string, facilitatorId: string) {\n    try {\n      // First verify the property is assigned to this facilitator\n      const [property] = await this.db\n        .select()\n        .from(properties)\n        .where(and(\n          eq(properties.id, propertyId),\n          eq(properties.facilitatorId, facilitatorId)\n        ))\n        .limit(1);\n\n      if (!property) {\n        throw new NotFoundException('Property not found or not assigned to you');\n      }\n\n      // Query units with active lease information\n      const unitsData = await this.db\n        .select({\n          id: units.id,\n          unitNumber: units.unitNumber,\n          rent: units.rent,\n          tenantId: leases.tenantId,\n          tenantFirstName: users.firstName,\n          tenantLastName: users.lastName,\n        })\n        .from(units)\n        .leftJoin(\n          leases,\n          and(\n            eq(units.id, leases.unitId),\n            eq(leases.status, 'active')\n          )\n        )\n        .leftJoin(users, eq(leases.tenantId, users.id))\n        .where(eq(units.propertyId, propertyId))\n        .orderBy(units.unitNumber);\n\n      return unitsData.map(unit => ({\n        id: unit.id,\n        unitNumber: unit.unitNumber,\n        status: unit.tenantId ? 'occupied' : 'vacant',\n        rentAmount: Number(unit.rent),\n        tenantId: unit.tenantId,\n        tenantName: unit.tenantFirstName && unit.tenantLastName \n          ? `${unit.tenantFirstName} ${unit.tenantLastName}`\n          : null,\n        propertyId,\n      }));\n    } catch (error) {\n      console.error('Error getting facilitator property units:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get tenants for facilitator property\n   */\n  async getFacilitatorPropertyTenants(propertyId: string, facilitatorId: string) {\n    try {\n      // First verify the property is assigned to this facilitator\n      const [property] = await this.db\n        .select()\n        .from(properties)\n        .where(and(\n          eq(properties.id, propertyId),\n          eq(properties.facilitatorId, facilitatorId)\n        ))\n        .limit(1);\n\n      if (!property) {\n        throw new NotFoundException('Property not found or not assigned to you');\n      }\n\n      // Query tenants with active leases\n      const tenantsData = await this.db\n        .select({\n          id: users.id,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          email: users.email,\n          phoneNumber: users.phoneNumber,\n          unitNumber: units.unitNumber,\n          monthlyRent: leases.monthlyRent,\n          leaseEndDate: leases.endDate,\n        })\n        .from(leases)\n        .innerJoin(users, eq(leases.tenantId, users.id))\n        .innerJoin(units, eq(leases.unitId, units.id))\n        .where(\n          and(\n            eq(leases.propertyId, propertyId),\n            eq(leases.status, 'active')\n          )\n        )\n        .orderBy(units.unitNumber);\n\n      return tenantsData.map(tenant => ({\n        id: tenant.id,\n        firstName: tenant.firstName,\n        lastName: tenant.lastName,\n        email: tenant.email,\n        phoneNumber: tenant.phoneNumber,\n        unitNumber: tenant.unitNumber,\n        rentAmount: Number(tenant.monthlyRent),\n        leaseEndDate: tenant.leaseEndDate,\n        status: 'paid', // Default for now\n      }));\n    } catch (error) {\n      console.error('Error getting facilitator property tenants:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get all maintenance requests for facilitator's assigned properties\n   */\n  async getFacilitatorMaintenanceRequests(facilitatorId: string) {\n    try {\n      // Get all properties assigned to this facilitator\n      const facilitatorProperties = await this.db\n        .select({ id: properties.id })\n        .from(properties)\n        .where(eq(properties.facilitatorId, facilitatorId));\n\n      if (facilitatorProperties.length === 0) {\n        return [];\n      }\n\n      const propertyIds = facilitatorProperties.map(p => p.id);\n\n      // Query maintenance requests for facilitator's properties\n      const maintenanceData = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          status: maintenanceRequests.status,\n          priority: maintenanceRequests.priority,\n          images: maintenanceRequests.images,\n          createdAt: maintenanceRequests.createdAt,\n          completedAt: maintenanceRequests.completedAt,\n          propertyName: properties.name,\n          tenantFirstName: sql<string>`tenant.first_name`,\n          tenantLastName: sql<string>`tenant.last_name`,\n          unitNumber: sql<string>`unit.unit_number`,\n        })\n        .from(maintenanceRequests)\n        .innerJoin(properties, eq(maintenanceRequests.propertyId, properties.id))\n        .leftJoin(sql`users AS tenant`, sql`${maintenanceRequests.tenantId} = tenant.id`)\n        .leftJoin(sql`leases AS active_lease`, sql`active_lease.tenant_id = tenant.id AND active_lease.property_id = ${maintenanceRequests.propertyId} AND active_lease.status = 'active'`)\n        .leftJoin(sql`units AS unit`, sql`active_lease.unit_id = unit.id`)\n        .where(sql`${maintenanceRequests.propertyId} IN (${sql.join(propertyIds.map(id => sql`${id}`), sql`, `)})`)\n        .orderBy(sql`${maintenanceRequests.createdAt} DESC`);\n\n      return maintenanceData.map(request => ({\n        id: request.id,\n        title: request.title,\n        description: request.description,\n        status: request.status,\n        priority: request.priority || 'medium',\n        images: request.images || [],\n        propertyName: request.propertyName,\n        tenantName: request.tenantFirstName,\n        tenantLastName: request.tenantLastName,\n        unitNumber: request.unitNumber || 'N/A',\n        createdAt: request.createdAt,\n        completedAt: request.completedAt,\n      }));\n    } catch (error) {\n      console.error('Error getting facilitator maintenance requests:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Get maintenance requests for facilitator property\n   */\n  async getFacilitatorPropertyMaintenance(propertyId: string, facilitatorId: string) {\n    try {\n      // First verify the property is assigned to this facilitator\n      const [property] = await this.db\n        .select()\n        .from(properties)\n        .where(and(\n          eq(properties.id, propertyId),\n          eq(properties.facilitatorId, facilitatorId)\n        ))\n        .limit(1);\n\n      if (!property) {\n        throw new NotFoundException('Property not found or not assigned to you');\n      }\n\n      // Query maintenance requests with tenant and unit info\n      const maintenanceData = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          status: maintenanceRequests.status,\n          priority: maintenanceRequests.priority,\n          createdAt: maintenanceRequests.createdAt,\n          completedAt: maintenanceRequests.completedAt,\n          tenantFirstName: sql<string>`tenant.first_name`,\n          tenantLastName: sql<string>`tenant.last_name`,\n          unitNumber: sql<string>`unit.unit_number`,\n          assignedToFirstName: sql<string>`assigned_admin.first_name`,\n          assignedToLastName: sql<string>`assigned_admin.last_name`,\n        })\n        .from(maintenanceRequests)\n        .leftJoin(sql`users AS tenant`, sql`${maintenanceRequests.tenantId} = tenant.id`)\n        .leftJoin(sql`leases AS active_lease`, sql`active_lease.tenant_id = tenant.id AND active_lease.property_id = ${propertyId} AND active_lease.status = 'active'`)\n        .leftJoin(sql`units AS unit`, sql`active_lease.unit_id = unit.id`)\n        .leftJoin(sql`users AS assigned_admin`, sql`${maintenanceRequests.assignedTo} = assigned_admin.id`)\n        .where(eq(maintenanceRequests.propertyId, propertyId))\n        .orderBy(sql`${maintenanceRequests.createdAt} DESC`);\n\n      return maintenanceData.map(request => ({\n        id: request.id,\n        issue: request.title,\n        description: request.description,\n        status: request.status,\n        priority: request.priority || 'medium',\n        tenant: request.tenantFirstName && request.tenantLastName \n          ? `${request.tenantFirstName} ${request.tenantLastName}` \n          : 'Unknown',\n        unit: request.unitNumber || 'N/A',\n        assignedAdmin: request.assignedToFirstName && request.assignedToLastName\n          ? `${request.assignedToFirstName} ${request.assignedToLastName}`\n          : 'Unassigned',\n        createdAt: request.createdAt,\n        resolvedAt: request.status === 'completed' ? request.completedAt : null,\n      }));\n    } catch (error) {\n      console.error('Error getting facilitator property maintenance:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Get payments for facilitator property\n   */\n  async getFacilitatorPropertyPayments(propertyId: string, facilitatorId: string) {\n    try {\n      // First verify the property is assigned to this facilitator\n      const [property] = await this.db\n        .select()\n        .from(properties)\n        .where(and(\n          eq(properties.id, propertyId),\n          eq(properties.facilitatorId, facilitatorId)\n        ))\n        .limit(1);\n\n      if (!property) {\n        throw new NotFoundException('Property not found or not assigned to you');\n      }\n\n      // Query payments with tenant and unit info\n      const paymentsData = await this.db\n        .select({\n          id: payments.id,\n          amount: payments.amount,\n          amountPaid: payments.amountPaid,\n          dueDate: payments.dueDate,\n          paidDate: payments.paidDate,\n          status: payments.status,\n          tenantFirstName: sql<string>`tenant.first_name`,\n          tenantLastName: sql<string>`tenant.last_name`,\n          unitNumber: units.unitNumber,\n        })\n        .from(payments)\n        .innerJoin(sql`users AS tenant`, sql`${payments.tenantId} = tenant.id`)\n        .innerJoin(units, eq(payments.unitId, units.id))\n        .where(eq(payments.propertyId, propertyId))\n        .orderBy(sql`${payments.dueDate} DESC`);\n\n      return paymentsData.map(payment => {\n        const totalDue = Number(payment.amount);\n        const paid = Number(payment.amountPaid);\n        const balance = totalDue - paid;\n\n        return {\n          id: payment.id,\n          tenantName: `${payment.tenantFirstName} ${payment.tenantLastName}`,\n          unitNumber: payment.unitNumber,\n          totalDue,\n          paid,\n          balance,\n          status: payment.status,\n          dueDate: payment.dueDate,\n          lastPayment: payment.paidDate,\n        };\n      });\n    } catch (error) {\n      console.error('Error getting facilitator property payments:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Get facilitator for a specific property\n   */\n  async getPropertyFacilitator(propertyId: string) {\n    try {\n      const [propertyWithFacilitator] = await this.db\n        .select({\n          facilitatorId: properties.facilitatorId,\n          facilitatorFirstName: users.firstName,\n          facilitatorLastName: users.lastName,\n          facilitatorEmail: users.email,\n          facilitatorPhone: users.phoneNumber,\n        })\n        .from(properties)\n        .leftJoin(users, eq(users.id, properties.facilitatorId))\n        .where(eq(properties.id, propertyId));\n\n      if (!propertyWithFacilitator) {\n        throw new NotFoundException('Property not found');\n      }\n\n      return propertyWithFacilitator.facilitatorId ? {\n        id: propertyWithFacilitator.facilitatorId,\n        firstName: propertyWithFacilitator.facilitatorFirstName,\n        lastName: propertyWithFacilitator.facilitatorLastName,\n        email: propertyWithFacilitator.facilitatorEmail,\n        phoneNumber: propertyWithFacilitator.facilitatorPhone,\n      } : null;\n    } catch (error) {\n      console.error('Error getting property facilitator:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Update facilitator status (activate/deactivate)\n   */\n  async updateFacilitatorStatus(facilitatorId: string, isActive: boolean, adminId: string) {\n    try {\n      // Verify admin role\n      const [admin] = await this.db\n        .select()\n        .from(users)\n        .where(and(\n          eq(users.id, adminId),\n          eq(users.role, 'admin')\n        ));\n\n      if (!admin) {\n        throw new ForbiddenException('Only admins can update facilitator status');\n      }\n\n      // Update facilitator status\n      const [updatedFacilitator] = await this.db\n        .update(users)\n        .set({\n          isActive,\n          updatedAt: new Date(),\n        })\n        .where(and(\n          eq(users.id, facilitatorId),\n          eq(users.role, 'facilitator')\n        ))\n        .returning();\n\n      if (!updatedFacilitator) {\n        throw new NotFoundException('Facilitator not found');\n      }\n\n      // If deactivating, remove from all assigned properties\n      if (!isActive) {\n        await this.db\n          .update(properties)\n          .set({\n            facilitatorId: null,\n            updatedAt: new Date(),\n          })\n          .where(eq(properties.facilitatorId, facilitatorId));\n      }\n\n      const { password, ...facilitatorResponse } = updatedFacilitator;\n      return facilitatorResponse;\n    } catch (error) {\n      console.error('Error updating facilitator status:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Add a comment to a maintenance request (Facilitator)\n   */\n  async addMaintenanceComment(facilitatorId: string, maintenanceId: string, commentText: string) {\n    try {\n      // Get the maintenance request and verify facilitator has access\n      const [request] = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          propertyId: maintenanceRequests.propertyId,\n          comments: maintenanceRequests.comments,\n        })\n        .from(maintenanceRequests)\n        .innerJoin(properties, eq(maintenanceRequests.propertyId, properties.id))\n        .where(and(\n          eq(maintenanceRequests.id, maintenanceId),\n          eq(properties.facilitatorId, facilitatorId)\n        ));\n\n      if (!request) {\n        throw new NotFoundException('Maintenance request not found or access denied');\n      }\n\n      // Get facilitator info\n      const [facilitator] = await this.db\n        .select({\n          firstName: users.firstName,\n          lastName: users.lastName,\n        })\n        .from(users)\n        .where(eq(users.id, facilitatorId));\n\n      // Create new comment\n      const newComment = {\n        id: crypto.randomUUID(),\n        authorId: facilitatorId,\n        authorName: `${facilitator.firstName} ${facilitator.lastName}`,\n        authorRole: 'facilitator',\n        text: commentText,\n        createdAt: new Date().toISOString(),\n      };\n\n      // Get existing comments or initialize empty array\n      let existingComments = [];\n      try {\n        if (typeof request.comments === 'string') {\n          existingComments = JSON.parse(request.comments);\n        } else if (Array.isArray(request.comments)) {\n          existingComments = request.comments;\n        }\n      } catch (e) {\n        console.error('Error parsing existing comments:', e);\n        existingComments = [];\n      }\n      \n      const updatedComments = [...existingComments, newComment];\n\n      // Update the maintenance request with new comment\n      await this.db\n        .update(maintenanceRequests)\n        .set({ comments: JSON.stringify(updatedComments) })\n        .where(eq(maintenanceRequests.id, maintenanceId));\n      \n      console.log('âœ… Facilitator comment added successfully:', newComment.id);\n\n      return newComment;\n    } catch (error) {\n      console.error('Error adding comment:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get maintenance request details (Facilitator)\n   */\n  async getMaintenanceRequestDetails(facilitatorId: string, maintenanceId: string) {\n    try {\n      const [request] = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          status: maintenanceRequests.status,\n          priority: maintenanceRequests.priority,\n          images: maintenanceRequests.images,\n          comments: maintenanceRequests.comments,\n          createdAt: maintenanceRequests.createdAt,\n          completedAt: maintenanceRequests.completedAt,\n          propertyId: properties.id,\n          propertyName: properties.name,\n          unitNumber: sql<string>`unit.unit_number`,\n          reporterFirstName: sql<string>`reporter.first_name`,\n          reporterLastName: sql<string>`reporter.last_name`,\n          reporterRole: sql<string>`reporter.role`,\n        })\n        .from(maintenanceRequests)\n        .innerJoin(properties, eq(maintenanceRequests.propertyId, properties.id))\n        .leftJoin(sql`units AS unit`, sql`unit.id = ${maintenanceRequests.unitId}`)\n        .leftJoin(sql`users AS reporter`, sql`${maintenanceRequests.tenantId} = reporter.id`)\n        .where(and(\n          eq(maintenanceRequests.id, maintenanceId),\n          eq(properties.facilitatorId, facilitatorId)\n        ));\n\n      if (!request) {\n        throw new NotFoundException('Maintenance request not found or access denied');\n      }\n\n      // Parse comments from JSON string if needed\n      let comments = [];\n      try {\n        if (typeof request.comments === 'string') {\n          comments = JSON.parse(request.comments);\n        } else if (Array.isArray(request.comments)) {\n          comments = request.comments;\n        }\n      } catch (e) {\n        console.error('Error parsing comments:', e);\n        comments = [];\n      }\n\n      return {\n        ...request,\n        comments: comments,\n        reportedBy: request.reporterRole === 'landlord' ? \n                   `${request.reporterFirstName} ${request.reporterLastName} (Landlord)` : \n                   request.reporterRole === 'tenant' ? \n                   `${request.reporterFirstName} ${request.reporterLastName} (Tenant)` : 'Unknown',\n        reporterType: request.reporterRole,\n        hasFacilitator: true,\n        assignedFacilitator: 'You',\n      };\n    } catch (error) {\n      console.error('Error getting maintenance request details:', error);\n      throw error;\n    }\n  }\n}\n\n\n\n"],"names":["FacilitatorsService","createFacilitator","createFacilitatorDto","existingUser","db","select","from","users","where","eq","email","limit","length","BadRequestException","hashedPassword","bcrypt","hash","password","facilitator","insert","values","role","isActive","isEmailVerified","returning","facilitatorResponse","error","console","getAllFacilitators","facilitators","id","firstName","lastName","phoneNumber","lastLoginAt","createdAt","orderBy","desc","facilitatorsWithCounts","Promise","all","map","propertyCount","count","properties","facilitatorId","assignedProperties","Number","log","getFacilitatorById","nextOfKinName","nextOfKinPhone","nextOfKinRelationship","and","NotFoundException","assignFacilitatorToProperty","assignDto","adminId","admin","ForbiddenException","property","propertyId","updatedProperty","update","set","updatedAt","Date","success","message","name","removeFacilitatorFromProperty","getFacilitatorProperties","facilitatorProperties","address","city","state","propertyType","totalUnits","status","landlordId","landlordFirstName","landlordLastName","landlordEmail","leftJoin","prop","landlordName","resetPassword","tempPassword","Math","random","toString","slice","updateFacilitator","updateData","getFacilitatorStats","pendingMaintenanceRequests","maintenanceRequests","unreadMessages","messages","receiverId","isRead","tenantRentContracts","activeTenantsQuery","tenantId","totalTenants","getFacilitatorTenants","tenants","propertyName","unitNumber","units","rentAmount","leases","monthlyRent","leaseStartDate","startDate","leaseEndDate","endDate","leaseStatus","innerJoin","unitId","tenantsWithStatus","tenant","getFacilitatorPropertyById","country","description","landlord","getFacilitatorPropertyUnits","unitsData","rent","tenantFirstName","tenantLastName","unit","tenantName","getFacilitatorPropertyTenants","tenantsData","getFacilitatorMaintenanceRequests","propertyIds","p","maintenanceData","title","priority","images","completedAt","sql","join","request","getFacilitatorPropertyMaintenance","assignedToFirstName","assignedToLastName","assignedTo","issue","assignedAdmin","resolvedAt","getFacilitatorPropertyPayments","paymentsData","payments","amount","amountPaid","dueDate","paidDate","payment","totalDue","paid","balance","lastPayment","getPropertyFacilitator","propertyWithFacilitator","facilitatorFirstName","facilitatorLastName","facilitatorEmail","facilitatorPhone","updateFacilitatorStatus","updatedFacilitator","addMaintenanceComment","maintenanceId","commentText","comments","newComment","crypto","randomUUID","authorId","authorName","authorRole","text","toISOString","existingComments","JSON","parse","Array","isArray","e","updatedComments","stringify","getMaintenanceRequestDetails","reporterFirstName","reporterLastName","reporterRole","reportedBy","reporterType","hasFacilitator","assignedFacilitator"],"mappings":"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"}