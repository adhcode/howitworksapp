{"version":3,"sources":["../../src/tenants/tenants.service.ts"],"sourcesContent":["import { Injectable, Inject, NotFoundException } from '@nestjs/common';\nimport { eq, and, sql } from 'drizzle-orm';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { tenantInvitations, properties, units, users, payments } from '../database/schema';\nimport { tenantRentContracts } from '../database/schema/tenant-rent-contracts';\n\n@Injectable()\nexport class TenantsService {\n  constructor(\n    @Inject(DATABASE_CONNECTION) private readonly db: any,\n  ) {}\n\n  async getTenantData(userId: string) {\n    try {\n      // Get payment data which has accurate totalDue calculation\n      const paymentData = await this.getTenantPayments(userId);\n      \n      // Get contract data for property info\n      const contractData = await this.getTenantRentContract(userId);\n      \n      if (!contractData || !contractData.contract) {\n        throw new NotFoundException('Tenant data not found');\n      }\n      \n      const contract = contractData.contract;\n      \n      return {\n        property: {\n          name: contract.property?.name || 'Unknown Property',\n          unit: `Unit ${contract.unit?.unitNumber || 'N/A'}`,\n        },\n        totalDue: paymentData.totalDue, // Use accurate calculation from getTenantPayments\n        dueDate: paymentData.dueDate,\n        tenant: {\n          firstName: '', // Will be filled from user context\n          lastName: '',\n        },\n        monthsDue: paymentData.monthsDue,\n        monthlyRent: paymentData.monthlyRent,\n        totalPaid: paymentData.totalPaid || 0,\n      };\n    } catch (error) {\n      console.error('Error getting tenant data:', error);\n      throw error;\n    }\n  }\n\n  async getTenantPayments(userId: string) {\n    try {\n      // Find the tenant's accepted invitation with property and unit data\n      const [tenantInvitation] = await this.db\n        .select({\n          invitation: tenantInvitations,\n          property: properties,\n          unit: units,\n        })\n        .from(tenantInvitations)\n        .leftJoin(properties, eq(tenantInvitations.propertyId, properties.id))\n        .leftJoin(units, eq(tenantInvitations.unitId, units.id))\n        .where(and(\n          eq(tenantInvitations.tenantId, userId),\n          eq(tenantInvitations.status, 'accepted')\n        ));\n\n      if (!tenantInvitation) {\n        throw new NotFoundException('Tenant payment data not found');\n      }\n\n      // Use the same calculation logic as getTenantData\n      const moveInDate = new Date(tenantInvitation.invitation.leaseStartDate);\n      const monthlyRent = parseFloat(tenantInvitation.unit?.rent || tenantInvitation.invitation.monthlyRent || '0');\n      const today = new Date();\n      \n      // Calculate how many months of rent are due from move-in date to now\n      let monthsDue = 0;\n      let nextDueDate = 'No payments due';\n      \n      if (moveInDate <= today) {\n        // Calculate months between move-in date and today\n        const yearsDiff = today.getFullYear() - moveInDate.getFullYear();\n        const monthsDiff = today.getMonth() - moveInDate.getMonth();\n        monthsDue = yearsDiff * 12 + monthsDiff + 1; // +1 for current month\n        \n        // Next due date is the first day of next month\n        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);\n        nextDueDate = nextMonth.toLocaleDateString('en-US', {\n          year: 'numeric',\n          month: 'long',\n          day: 'numeric',\n        });\n      } else {\n        // Move-in date is in the future, no payments due yet\n        nextDueDate = moveInDate.toLocaleDateString('en-US', {\n          year: 'numeric',\n          month: 'long',\n          day: 'numeric',\n        });\n      }\n      \n      // Calculate total paid from successful payments\n      const paidPayments = await this.db\n        .select()\n        .from(payments)\n        .where(and(\n          eq(payments.tenantId, userId),\n          eq(payments.status, 'paid')\n        ));\n\n      const totalPaid = paidPayments.reduce((sum, payment) => {\n        return sum + parseFloat(payment.amountPaid || payment.amount || '0');\n      }, 0);\n\n      const totalExpected = monthsDue * monthlyRent;\n      const totalDue = Math.max(0, totalExpected - totalPaid);\n\n      return {\n        totalDue,\n        totalPaid,\n        totalExpected,\n        dueDate: nextDueDate,\n        paymentHistory: await this.getPaymentHistory(userId),\n        monthlyRent,\n        monthsDue,\n        moveInDate: moveInDate.toLocaleDateString('en-US', {\n          year: 'numeric',\n          month: 'long',\n          day: 'numeric',\n        }),\n      };\n    } catch (error) {\n      console.error('Error getting tenant payments:', error);\n      throw error;\n    }\n  }\n\n  async getPaymentHistory(userId: string) {\n    try {\n      const history = await this.db\n        .select({\n          id: payments.id,\n          amount: payments.amount,\n          status: payments.status,\n          paymentMethod: payments.paymentMethod,\n          paidDate: payments.paidDate,\n          createdAt: payments.createdAt,\n          description: payments.description,\n          paystackReference: payments.paystackReference,\n          paystackStatus: payments.paystackStatus,\n        })\n        .from(payments)\n        .where(eq(payments.tenantId, userId))\n        .orderBy(sql`${payments.createdAt} DESC`)\n        .limit(50);\n\n      return history;\n    } catch (error) {\n      console.error('Error getting payment history:', error);\n      return [];\n    }\n  }\n\n  async getTenantReports(userId: string) {\n    try {\n      // TODO: Implement reports when payment and maintenance systems are ready\n      return [];\n    } catch (error) {\n      console.error('Error getting tenant reports:', error);\n      throw error;\n    }\n  }\n\n  async getTenantComplaints(userId: string) {\n    try {\n      const { maintenanceRequests } = await import('../database/schema');\n      const { desc, sql } = await import('drizzle-orm');\n      \n      // Get maintenance requests created by this tenant\n      const requests = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          status: maintenanceRequests.status,\n          priority: maintenanceRequests.priority,\n          images: maintenanceRequests.images,\n          createdAt: maintenanceRequests.createdAt,\n          completedAt: maintenanceRequests.completedAt,\n          // Property info\n          propertyName: sql<string>`property.name`,\n          // Unit info\n          unitNumber: sql<string>`unit.unit_number`,\n          // Facilitator info\n          facilitatorFirstName: sql<string>`facilitator.first_name`,\n          facilitatorLastName: sql<string>`facilitator.last_name`,\n        })\n        .from(maintenanceRequests)\n        .leftJoin(sql`properties AS property`, sql`${maintenanceRequests.propertyId} = property.id`)\n        .leftJoin(sql`units AS unit`, sql`unit.id = ${maintenanceRequests.unitId}`)\n        .leftJoin(sql`users AS facilitator`, sql`${maintenanceRequests.assignedTo} = facilitator.id`)\n        .where(sql`${maintenanceRequests.tenantId} = ${userId}`)\n        .orderBy(desc(maintenanceRequests.createdAt));\n\n      return requests.map(request => ({\n        ...request,\n        assignedFacilitator: request.facilitatorFirstName \n          ? `${request.facilitatorFirstName} ${request.facilitatorLastName}` \n          : 'Not assigned',\n      }));\n    } catch (error) {\n      console.error('Error getting tenant complaints:', error);\n      throw error;\n    }\n  }\n\n  async getComplaintDetail(complaintId: string, userId: string) {\n    try {\n      const { maintenanceRequests } = await import('../database/schema');\n      const { eq, and, sql } = await import('drizzle-orm');\n      \n      // Get maintenance request details\n      const [request] = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          status: maintenanceRequests.status,\n          priority: maintenanceRequests.priority,\n          images: maintenanceRequests.images,\n          comments: maintenanceRequests.comments,\n          createdAt: maintenanceRequests.createdAt,\n          completedAt: maintenanceRequests.completedAt,\n          // Property info\n          propertyId: sql<string>`property.id`,\n          propertyName: sql<string>`property.name`,\n          // Unit info\n          unitNumber: sql<string>`unit.unit_number`,\n          // Facilitator info\n          facilitatorId: sql<string>`facilitator.id`,\n          facilitatorFirstName: sql<string>`facilitator.first_name`,\n          facilitatorLastName: sql<string>`facilitator.last_name`,\n          facilitatorEmail: sql<string>`facilitator.email`,\n        })\n        .from(maintenanceRequests)\n        .leftJoin(sql`properties AS property`, sql`${maintenanceRequests.propertyId} = property.id`)\n        .leftJoin(sql`units AS unit`, sql`unit.id = ${maintenanceRequests.unitId}`)\n        .leftJoin(sql`users AS facilitator`, sql`${maintenanceRequests.assignedTo} = facilitator.id`)\n        .where(and(\n          eq(maintenanceRequests.id, complaintId),\n          sql`${maintenanceRequests.tenantId} = ${userId}`\n        ));\n\n      if (!request) {\n        throw new Error('Maintenance request not found or access denied');\n      }\n\n      return {\n        ...request,\n        assignedFacilitator: request.facilitatorFirstName \n          ? `${request.facilitatorFirstName} ${request.facilitatorLastName}` \n          : 'Not assigned',\n        hasFacilitator: !!request.facilitatorId,\n      };\n    } catch (error) {\n      console.error('Error getting complaint detail:', error);\n      throw error;\n    }\n  }\n\n  async submitComplaint(complaintData: any, userId: string) {\n    try {\n      const { maintenanceRequests } = await import('../database/schema');\n      const { eq, and, sql } = await import('drizzle-orm');\n      \n      // Get tenant's property info\n      const [tenantInvitation] = await this.db\n        .select({\n          propertyId: tenantInvitations.propertyId,\n          unitId: tenantInvitations.unitId,\n          facilitatorId: sql<string>`property.facilitator_id`,\n        })\n        .from(tenantInvitations)\n        .leftJoin(sql`properties AS property`, sql`${tenantInvitations.propertyId} = property.id`)\n        .where(and(\n          eq(tenantInvitations.tenantId, userId),\n          eq(tenantInvitations.status, 'accepted')\n        ))\n        .limit(1);\n\n      if (!tenantInvitation) {\n        throw new Error('No active tenancy found');\n      }\n\n      // Create maintenance request\n      const [newRequest] = await this.db\n        .insert(maintenanceRequests)\n        .values({\n          tenantId: userId,\n          landlordId: null, // Tenant-reported, no landlord\n          propertyId: tenantInvitation.propertyId,\n          unitId: tenantInvitation.unitId,\n          title: complaintData.title,\n          description: complaintData.description,\n          priority: complaintData.priority || 'medium',\n          status: 'pending',\n          images: complaintData.images || [],\n          assignedTo: tenantInvitation.facilitatorId, // Auto-assign to property facilitator\n        })\n        .returning();\n\n      return newRequest;\n    } catch (error) {\n      console.error('Error submitting complaint:', error);\n      throw error;\n    }\n  }\n\n  async getTenantRentContract(userId: string) {\n    try {\n      // Find the tenant's active rent contract\n      const [contractData] = await this.db\n        .select({\n          contract: tenantRentContracts,\n          property: properties,\n          unit: units,\n        })\n        .from(tenantRentContracts)\n        .leftJoin(properties, eq(tenantRentContracts.propertyId, properties.id))\n        .leftJoin(units, eq(tenantRentContracts.unitId, units.id))\n        .where(and(\n          eq(tenantRentContracts.tenantId, userId),\n          eq(tenantRentContracts.status, 'active')\n        ))\n        .limit(1);\n\n      if (!contractData) {\n        return null; // No active contract found\n      }\n\n      const contract = {\n        id: contractData.contract.id,\n        monthlyAmount: contractData.contract.monthlyAmount,\n        nextPaymentDue: contractData.contract.nextPaymentDue,\n        expiryDate: contractData.contract.expiryDate,\n        transitionStartDate: contractData.contract.transitionStartDate,\n        landlordPayoutType: contractData.contract.landlordPayoutType,\n        status: contractData.contract.status,\n        isExistingTenant: contractData.contract.isExistingTenant,\n        property: {\n          name: contractData.property?.name || 'Unknown Property',\n        },\n        unit: {\n          unitNumber: contractData.unit?.unitNumber || 'N/A',\n        },\n      };\n\n      // Calculate arrears if existing tenant\n      let arrearsInfo: {\n        monthsOverdue: number;\n        totalArrears: number;\n        message: string;\n      } | null = null;\n      if (contractData.contract.isExistingTenant) {\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n        \n        const transition = new Date(contractData.contract.transitionStartDate);\n        transition.setHours(0, 0, 0, 0);\n        \n        // If transition date is in the past, calculate arrears\n        if (transition < today) {\n          let monthsOverdue = 0;\n          let checkDate = new Date(transition);\n          \n          while (checkDate < today) {\n            monthsOverdue++;\n            checkDate.setMonth(checkDate.getMonth() + 1);\n          }\n          \n          if (monthsOverdue > 0) {\n            const monthlyAmount = parseFloat(contractData.contract.monthlyAmount);\n            const totalArrears = monthsOverdue * monthlyAmount;\n            \n            arrearsInfo = {\n              monthsOverdue,\n              totalArrears,\n              message: `You owe ${monthsOverdue} month${monthsOverdue > 1 ? 's' : ''} rent (â‚¦${totalArrears.toLocaleString()}). Please pay arrears to continue.`\n            };\n          }\n        }\n      }\n\n      // Get payment history\n      const { desc } = await import('drizzle-orm');\n      const paymentHistory = await this.db\n        .select()\n        .from(payments)\n        .where(and(\n          eq(payments.tenantId, userId),\n          eq(payments.status, 'paid')\n        ))\n        .orderBy(desc(payments.paidDate))\n        .limit(10);\n\n      const result = {\n        contract,\n        arrears: arrearsInfo,\n        paymentHistory: paymentHistory || [],\n      };\n      \n      console.log('ðŸ“¤ Returning contract data for tenant:', userId);\n      console.log('   Next Payment Due:', contract.nextPaymentDue);\n      console.log('   Monthly Amount:', contract.monthlyAmount);\n      console.log('   Arrears:', arrearsInfo ? 'YES' : 'NO');\n      \n      return result;\n    } catch (error) {\n      console.error('Error getting tenant rent contract:', error);\n      return null; // Return null instead of throwing to avoid breaking the app\n    }\n  }\n}"],"names":["TenantsService","getTenantData","userId","paymentData","getTenantPayments","contractData","getTenantRentContract","contract","NotFoundException","property","name","unit","unitNumber","totalDue","dueDate","tenant","firstName","lastName","monthsDue","monthlyRent","totalPaid","error","console","tenantInvitation","db","select","invitation","tenantInvitations","properties","units","from","leftJoin","eq","propertyId","id","unitId","where","and","tenantId","status","moveInDate","Date","leaseStartDate","parseFloat","rent","today","nextDueDate","yearsDiff","getFullYear","monthsDiff","getMonth","nextMonth","toLocaleDateString","year","month","day","paidPayments","payments","reduce","sum","payment","amountPaid","amount","totalExpected","Math","max","paymentHistory","getPaymentHistory","history","paymentMethod","paidDate","createdAt","description","paystackReference","paystackStatus","orderBy","sql","limit","getTenantReports","getTenantComplaints","maintenanceRequests","desc","requests","title","priority","images","completedAt","propertyName","facilitatorFirstName","facilitatorLastName","assignedTo","map","request","assignedFacilitator","getComplaintDetail","complaintId","comments","facilitatorId","facilitatorEmail","Error","hasFacilitator","submitComplaint","complaintData","newRequest","insert","values","landlordId","returning","tenantRentContracts","monthlyAmount","nextPaymentDue","expiryDate","transitionStartDate","landlordPayoutType","isExistingTenant","arrearsInfo","setHours","transition","monthsOverdue","checkDate","setMonth","totalArrears","message","toLocaleString","result","arrears","log"],"mappings":"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"}