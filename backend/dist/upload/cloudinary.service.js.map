{"version":3,"sources":["../../src/upload/cloudinary.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { v2 as cloudinary, UploadApiResponse } from 'cloudinary';\nimport { Readable } from 'stream';\n\n@Injectable()\nexport class CloudinaryService {\n  private readonly logger = new Logger(CloudinaryService.name);\n\n  constructor() {\n    // Configure Cloudinary\n    cloudinary.config({\n      cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\n      api_key: process.env.CLOUDINARY_API_KEY,\n      api_secret: process.env.CLOUDINARY_API_SECRET,\n    });\n\n    // Log configuration status (without exposing secrets)\n    if (process.env.CLOUDINARY_CLOUD_NAME) {\n      this.logger.log(`Cloudinary configured for: ${process.env.CLOUDINARY_CLOUD_NAME}`);\n    } else {\n      this.logger.warn('Cloudinary not configured - check environment variables');\n    }\n  }\n\n  /**\n   * Upload an image to Cloudinary\n   * @param fileBuffer - The file buffer to upload\n   * @param filename - The filename (will be used as public_id)\n   * @param folder - Optional folder name in Cloudinary (default: 'homezy')\n   * @returns The secure URL of the uploaded image\n   */\n  async uploadImage(\n    fileBuffer: Buffer,\n    filename: string,\n    folder: string = 'homezy'\n  ): Promise<string> {\n    return new Promise((resolve, reject) => {\n      const uploadStream = cloudinary.uploader.upload_stream(\n        {\n          folder: folder,\n          public_id: filename.replace(/\\.[^/.]+$/, ''), // Remove extension\n          resource_type: 'image',\n          transformation: [\n            { quality: 'auto' }, // Auto-optimize quality\n            { fetch_format: 'auto' }, // Auto-select best format\n          ],\n        },\n        (error: any, result: UploadApiResponse) => {\n          if (error) {\n            this.logger.error('Cloudinary upload error:', error);\n            return reject(error);\n          }\n          this.logger.log(`Image uploaded: ${result.secure_url}`);\n          resolve(result.secure_url);\n        }\n      );\n\n      // Convert buffer to stream and pipe to Cloudinary\n      const readableStream = Readable.from(fileBuffer);\n      readableStream.pipe(uploadStream);\n    });\n  }\n\n  /**\n   * Delete an image from Cloudinary\n   * @param publicId - The public ID of the image to delete\n   */\n  async deleteImage(publicId: string): Promise<void> {\n    try {\n      await cloudinary.uploader.destroy(publicId);\n      this.logger.log(`Image deleted: ${publicId}`);\n    } catch (error) {\n      this.logger.error('Cloudinary delete error:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Check if Cloudinary is properly configured\n   */\n  isConfigured(): boolean {\n    return !!(\n      process.env.CLOUDINARY_CLOUD_NAME &&\n      process.env.CLOUDINARY_API_KEY &&\n      process.env.CLOUDINARY_API_SECRET\n    );\n  }\n}\n"],"names":["CloudinaryService","uploadImage","fileBuffer","filename","folder","Promise","resolve","reject","uploadStream","cloudinary","uploader","upload_stream","public_id","replace","resource_type","transformation","quality","fetch_format","error","result","logger","log","secure_url","readableStream","Readable","from","pipe","deleteImage","publicId","destroy","isConfigured","process","env","CLOUDINARY_CLOUD_NAME","CLOUDINARY_API_KEY","CLOUDINARY_API_SECRET","Logger","name","config","cloud_name","api_key","api_secret","warn"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBALsB;4BACiB;wBAC3B;;;;;;;;;;AAGlB,IAAA,AAAMA,oBAAN,MAAMA;IAmBX;;;;;;GAMC,GACD,MAAMC,YACJC,UAAkB,EAClBC,QAAgB,EAChBC,SAAiB,QAAQ,EACR;QACjB,OAAO,IAAIC,QAAQ,CAACC,SAASC;YAC3B,MAAMC,eAAeC,cAAU,CAACC,QAAQ,CAACC,aAAa,CACpD;gBACEP,QAAQA;gBACRQ,WAAWT,SAASU,OAAO,CAAC,aAAa;gBACzCC,eAAe;gBACfC,gBAAgB;oBACd;wBAAEC,SAAS;oBAAO;oBAClB;wBAAEC,cAAc;oBAAO;iBACxB;YACH,GACA,CAACC,OAAYC;gBACX,IAAID,OAAO;oBACT,IAAI,CAACE,MAAM,CAACF,KAAK,CAAC,4BAA4BA;oBAC9C,OAAOX,OAAOW;gBAChB;gBACA,IAAI,CAACE,MAAM,CAACC,GAAG,CAAC,CAAC,gBAAgB,EAAEF,OAAOG,UAAU,EAAE;gBACtDhB,QAAQa,OAAOG,UAAU;YAC3B;YAGF,kDAAkD;YAClD,MAAMC,iBAAiBC,gBAAQ,CAACC,IAAI,CAACvB;YACrCqB,eAAeG,IAAI,CAAClB;QACtB;IACF;IAEA;;;GAGC,GACD,MAAMmB,YAAYC,QAAgB,EAAiB;QACjD,IAAI;YACF,MAAMnB,cAAU,CAACC,QAAQ,CAACmB,OAAO,CAACD;YAClC,IAAI,CAACR,MAAM,CAACC,GAAG,CAAC,CAAC,eAAe,EAAEO,UAAU;QAC9C,EAAE,OAAOV,OAAO;YACd,IAAI,CAACE,MAAM,CAACF,KAAK,CAAC,4BAA4BA;YAC9C,MAAMA;QACR;IACF;IAEA;;GAEC,GACDY,eAAwB;QACtB,OAAO,CAAC,CACNC,CAAAA,QAAQC,GAAG,CAACC,qBAAqB,IACjCF,QAAQC,GAAG,CAACE,kBAAkB,IAC9BH,QAAQC,GAAG,CAACG,qBAAqB,AAAD;IAEpC;IA9EA,aAAc;aAFGf,SAAS,IAAIgB,cAAM,CAACpC,kBAAkBqC,IAAI;QAGzD,uBAAuB;QACvB5B,cAAU,CAAC6B,MAAM,CAAC;YAChBC,YAAYR,QAAQC,GAAG,CAACC,qBAAqB;YAC7CO,SAAST,QAAQC,GAAG,CAACE,kBAAkB;YACvCO,YAAYV,QAAQC,GAAG,CAACG,qBAAqB;QAC/C;QAEA,sDAAsD;QACtD,IAAIJ,QAAQC,GAAG,CAACC,qBAAqB,EAAE;YACrC,IAAI,CAACb,MAAM,CAACC,GAAG,CAAC,CAAC,2BAA2B,EAAEU,QAAQC,GAAG,CAACC,qBAAqB,EAAE;QACnF,OAAO;YACL,IAAI,CAACb,MAAM,CAACsB,IAAI,CAAC;QACnB;IACF;AAiEF"}