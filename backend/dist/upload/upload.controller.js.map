{"version":3,"sources":["../../src/upload/upload.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Request,\n  BadRequestException,\n  Logger,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiConsumes, ApiBody } from '@nestjs/swagger';\nimport * as path from 'path';\nimport { CloudinaryService } from './cloudinary.service';\n\n@ApiTags('Upload')\n@Controller('upload')\nexport class UploadController {\n  private readonly logger = new Logger(UploadController.name);\n\n  constructor(private readonly cloudinaryService: CloudinaryService) {}\n\n  @Post()\n  @ApiOperation({ summary: 'Upload a file' })\n  @ApiConsumes('multipart/form-data')\n  @ApiBody({\n    schema: {\n      type: 'object',\n      properties: {\n        file: {\n          type: 'string',\n          format: 'binary',\n        },\n      },\n    },\n  })\n  async uploadFile(@Request() req: any) {\n    try {\n      // Fastify multipart handling\n      const data = await req.file();\n      \n      if (!data) {\n        throw new BadRequestException('No file uploaded');\n      }\n\n      // Check file type\n      if (!data.mimetype.match(/\\/(jpg|jpeg|png|gif|webp)$/)) {\n        throw new BadRequestException('Only image files are allowed!');\n      }\n\n      // Check file size (max 5MB)\n      const MAX_SIZE = 5 * 1024 * 1024; // 5MB\n      let fileSize = 0;\n\n      // Convert stream to buffer\n      const chunks: Buffer[] = [];\n      for await (const chunk of data.file) {\n        chunks.push(chunk as Buffer);\n        fileSize += (chunk as Buffer).length;\n        \n        if (fileSize > MAX_SIZE) {\n          throw new BadRequestException('File size exceeds 5MB limit');\n        }\n      }\n      const buffer = Buffer.concat(chunks);\n\n      // Generate unique filename\n      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\n      const ext = path.extname(data.filename);\n      const filename = `${uniqueSuffix}${ext}`;\n\n      // Upload to Cloudinary\n      const url = await this.cloudinaryService.uploadImage(buffer, filename);\n      \n      this.logger.log(`ðŸ“¸ File uploaded to Cloudinary: ${filename}`);\n      \n      return {\n        url: url,\n        filename: filename,\n        originalname: data.filename,\n      };\n    } catch (error) {\n      this.logger.error('Upload error:', error);\n      if (error instanceof BadRequestException) {\n        throw error;\n      }\n      throw new BadRequestException('File upload failed');\n    }\n  }\n} "],"names":["UploadController","uploadFile","req","data","file","BadRequestException","mimetype","match","MAX_SIZE","fileSize","chunks","chunk","push","length","buffer","Buffer","concat","uniqueSuffix","Date","now","Math","round","random","ext","path","extname","filename","url","cloudinaryService","uploadImage","logger","log","originalname","error","Logger","name","summary","schema","type","properties","format"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBAPN;yBACqD;8DACtC;mCACY;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAI3B,IAAA,AAAMA,mBAAN,MAAMA;IAKX,MAcMC,WAAW,AAAWC,GAAQ,EAAE;QACpC,IAAI;YACF,6BAA6B;YAC7B,MAAMC,OAAO,MAAMD,IAAIE,IAAI;YAE3B,IAAI,CAACD,MAAM;gBACT,MAAM,IAAIE,2BAAmB,CAAC;YAChC;YAEA,kBAAkB;YAClB,IAAI,CAACF,KAAKG,QAAQ,CAACC,KAAK,CAAC,+BAA+B;gBACtD,MAAM,IAAIF,2BAAmB,CAAC;YAChC;YAEA,4BAA4B;YAC5B,MAAMG,WAAW,IAAI,OAAO,MAAM,MAAM;YACxC,IAAIC,WAAW;YAEf,2BAA2B;YAC3B,MAAMC,SAAmB,EAAE;YAC3B,WAAW,MAAMC,SAASR,KAAKC,IAAI,CAAE;gBACnCM,OAAOE,IAAI,CAACD;gBACZF,YAAY,AAACE,MAAiBE,MAAM;gBAEpC,IAAIJ,WAAWD,UAAU;oBACvB,MAAM,IAAIH,2BAAmB,CAAC;gBAChC;YACF;YACA,MAAMS,SAASC,OAAOC,MAAM,CAACN;YAE7B,2BAA2B;YAC3B,MAAMO,eAAeC,KAAKC,GAAG,KAAK,MAAMC,KAAKC,KAAK,CAACD,KAAKE,MAAM,KAAK;YACnE,MAAMC,MAAMC,MAAKC,OAAO,CAACtB,KAAKuB,QAAQ;YACtC,MAAMA,WAAW,GAAGT,eAAeM,KAAK;YAExC,uBAAuB;YACvB,MAAMI,MAAM,MAAM,IAAI,CAACC,iBAAiB,CAACC,WAAW,CAACf,QAAQY;YAE7D,IAAI,CAACI,MAAM,CAACC,GAAG,CAAC,CAAC,gCAAgC,EAAEL,UAAU;YAE7D,OAAO;gBACLC,KAAKA;gBACLD,UAAUA;gBACVM,cAAc7B,KAAKuB,QAAQ;YAC7B;QACF,EAAE,OAAOO,OAAO;YACd,IAAI,CAACH,MAAM,CAACG,KAAK,CAAC,iBAAiBA;YACnC,IAAIA,iBAAiB5B,2BAAmB,EAAE;gBACxC,MAAM4B;YACR;YACA,MAAM,IAAI5B,2BAAmB,CAAC;QAChC;IACF;IApEA,YAAY,AAAiBuB,iBAAoC,CAAE;aAAtCA,oBAAAA;aAFZE,SAAS,IAAII,cAAM,CAAClC,iBAAiBmC,IAAI;IAEU;AAqEtE;;;;QAlEkBC,SAAS;;;;QAGvBC,QAAQ;YACNC,MAAM;YACNC,YAAY;gBACVnC,MAAM;oBACJkC,MAAM;oBACNE,QAAQ;gBACV;YACF;QACF"}