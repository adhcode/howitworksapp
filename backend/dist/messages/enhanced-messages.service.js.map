{"version":3,"sources":["../../src/messages/enhanced-messages.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, ForbiddenException, Inject } from '@nestjs/common';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { CreateMessageDto, CreateMaintenanceRequestDto } from './dto/message.dto';\nimport { PaginationDto } from '../common/dto/pagination.dto';\nimport { \n  messages, \n  maintenanceRequests, \n  Message, \n  MaintenanceRequest, \n  NewMessage, \n  NewMaintenanceRequest \n} from '../database/schema/messages';\nimport { users } from '../database/schema/users';\nimport { properties } from '../database/schema/properties';\nimport { tenantInvitations } from '../database/schema/tenant-invitations';\nimport { eq, or, and, desc, asc } from 'drizzle-orm';\nimport { NotificationsService } from '../notifications/notifications.service';\nimport { NotificationType } from '../notifications/dto/notification.dto';\n\n@Injectable()\nexport class EnhancedMessagesService {\n  constructor(\n    @Inject(DATABASE_CONNECTION) private readonly db: any,\n    private readonly notificationsService: NotificationsService\n  ) {}\n\n  /**\n   * Create a message with facilitator routing\n   * If tenant sends to landlord and property has facilitator, route to facilitator instead\n   */\n  async createWithFacilitatorRouting(senderId: string, createMessageDto: CreateMessageDto): Promise<Message> {\n    try {\n      // Get sender info\n      const [sender] = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.id, senderId));\n\n      if (!sender) {\n        throw new NotFoundException('Sender not found');\n      }\n\n      let finalReceiverId = createMessageDto.receiverId;\n\n      // If sender is tenant, check if message should be routed through facilitator\n      if (sender.role === 'tenant') {\n        const facilitatorId = await this.getFacilitatorForTenantMessage(senderId, createMessageDto.receiverId);\n        if (facilitatorId) {\n          finalReceiverId = facilitatorId;\n          console.log(`Routing tenant message from ${senderId} through facilitator ${facilitatorId} instead of ${createMessageDto.receiverId}`);\n        }\n      }\n\n      // Verify final receiver exists\n      const [receiver] = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.id, finalReceiverId));\n\n      if (!receiver) {\n        throw new NotFoundException('Receiver not found');\n      }\n\n      const messageData: NewMessage = {\n        senderId,\n        receiverId: finalReceiverId,\n        subject: createMessageDto.subject,\n        content: createMessageDto.content,\n      };\n\n      const [message] = await this.db.insert(messages).values(messageData).returning();\n      return message;\n    } catch (error) {\n      console.error('Error creating message with facilitator routing:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get facilitator ID for tenant message routing\n   */\n  private async getFacilitatorForTenantMessage(tenantId: string, intendedReceiverId: string): Promise<string | null> {\n    try {\n      // Find the property where tenant is assigned and has a facilitator\n      const tenantProperty = await this.db\n        .select({\n          propertyId: properties.id,\n          facilitatorId: properties.facilitatorId,\n          landlordId: properties.landlordId,\n        })\n        .from(tenantInvitations)\n        .leftJoin(properties, eq(properties.id, tenantInvitations.propertyId))\n        .where(and(\n          eq(tenantInvitations.tenantId, tenantId),\n          eq(tenantInvitations.status, 'accepted')\n        ))\n        .limit(1);\n\n      if (tenantProperty.length > 0) {\n        const property = tenantProperty[0];\n        \n        // If intended receiver is landlord and property has facilitator, route to facilitator\n        if (property.landlordId === intendedReceiverId && property.facilitatorId) {\n          return property.facilitatorId;\n        }\n      }\n\n      return null;\n    } catch (error) {\n      console.error('Error getting facilitator for tenant message:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Create maintenance request with facilitator routing\n   */\n  async createMaintenanceRequestWithRouting(\n    tenantId: string, \n    createMaintenanceRequestDto: CreateMaintenanceRequestDto\n  ): Promise<MaintenanceRequest> {\n    try {\n      // Get tenant's property and check for facilitator\n      const tenantProperty = await this.db\n        .select({\n          propertyId: properties.id,\n          landlordId: properties.landlordId,\n          facilitatorId: properties.facilitatorId,\n        })\n        .from(tenantInvitations)\n        .leftJoin(properties, eq(properties.id, tenantInvitations.propertyId))\n        .where(and(\n          eq(tenantInvitations.tenantId, tenantId),\n          eq(tenantInvitations.status, 'accepted')\n        ))\n        .limit(1);\n\n      if (!tenantProperty.length) {\n        throw new NotFoundException('No active property found for tenant');\n      }\n\n      const { propertyId, landlordId, facilitatorId } = tenantProperty[0];\n\n      // Assign to facilitator if available, otherwise to landlord\n      const assignedTo = facilitatorId || landlordId;\n\n      const requestData: NewMaintenanceRequest = {\n        tenantId,\n        landlordId,\n        propertyId,\n        title: createMaintenanceRequestDto.title,\n        description: createMaintenanceRequestDto.description,\n        priority: createMaintenanceRequestDto.priority || 'medium',\n        images: createMaintenanceRequestDto.images || [],\n        assignedTo, // This will be facilitator if available\n      };\n\n      const [request] = await this.db.insert(maintenanceRequests).values(requestData).returning();\n\n      console.log(`Maintenance request created and assigned to ${facilitatorId ? 'facilitator' : 'landlord'}: ${assignedTo}`);\n      \n      // Send notification to assigned person\n      try {\n        const [tenant] = await this.db\n          .select({ firstName: users.firstName, lastName: users.lastName })\n          .from(users)\n          .where(eq(users.id, tenantId));\n\n        const tenantName = tenant ? `${tenant.firstName} ${tenant.lastName}` : 'A tenant';\n        const priorityEmoji = requestData.priority === 'urgent' ? 'ðŸš¨ ' : requestData.priority === 'high' ? 'âš ï¸ ' : '';\n\n        await this.notificationsService.sendNotification(\n          assignedTo,\n          `${priorityEmoji}New Maintenance Request`,\n          `${tenantName} reported: ${requestData.title}`,\n          {\n            type: 'maintenance',\n            id: request.id,\n            screen: 'MaintenanceDetail',\n            priority: requestData.priority,\n          },\n          NotificationType.MAINTENANCE\n        );\n      } catch (error) {\n        console.error('Error sending maintenance notification:', error);\n        // Don't fail the request if notification fails\n      }\n      \n      return request;\n    } catch (error) {\n      console.error('Error creating maintenance request with routing:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get conversations for facilitator (includes tenant-landlord conversations for their properties)\n   */\n  async getFacilitatorConversations(facilitatorId: string) {\n    try {\n      // Get all properties assigned to this facilitator\n      const facilitatorProperties = await this.db\n        .select({ id: properties.id })\n        .from(properties)\n        .where(eq(properties.facilitatorId, facilitatorId));\n\n      const propertyIds = facilitatorProperties.map(p => p.id);\n\n      if (propertyIds.length === 0) {\n        return [];\n      }\n\n      // Get all tenants for these properties\n      const propertyTenants = await this.db\n        .select({\n          tenantId: tenantInvitations.tenantId,\n          propertyId: tenantInvitations.propertyId,\n          landlordId: tenantInvitations.landlordId,\n        })\n        .from(tenantInvitations)\n        .where(and(\n          eq(tenantInvitations.status, 'accepted'),\n          or(...propertyIds.map(id => eq(tenantInvitations.propertyId, id)))\n        ));\n\n      // Get messages where facilitator is involved OR messages between tenants and landlords of their properties\n      const relevantMessages = await this.db\n        .select({\n          id: messages.id,\n          senderId: messages.senderId,\n          receiverId: messages.receiverId,\n          content: messages.content,\n          createdAt: messages.createdAt,\n        })\n        .from(messages)\n        .where(\n          or(\n            // Messages to/from facilitator\n            eq(messages.senderId, facilitatorId),\n            eq(messages.receiverId, facilitatorId),\n            // Messages between tenants and landlords for facilitator's properties\n            ...propertyTenants.flatMap(pt => [\n              and(eq(messages.senderId, pt.tenantId), eq(messages.receiverId, pt.landlordId)),\n              and(eq(messages.senderId, pt.landlordId), eq(messages.receiverId, pt.tenantId))\n            ])\n          )\n        )\n        .orderBy(desc(messages.createdAt));\n\n      // Group conversations\n      const conversationsMap = new Map();\n      \n      for (const message of relevantMessages) {\n        let conversationKey: string;\n        let otherUserId: string;\n\n        if (message.senderId === facilitatorId) {\n          otherUserId = message.receiverId;\n          conversationKey = `${facilitatorId}-${message.receiverId}`;\n        } else if (message.receiverId === facilitatorId) {\n          otherUserId = message.senderId;\n          conversationKey = `${message.senderId}-${facilitatorId}`;\n        } else {\n          // Message between tenant and landlord - create a group conversation key\n          const tenant = propertyTenants.find(pt => \n            pt.tenantId === message.senderId || pt.tenantId === message.receiverId\n          );\n          if (tenant) {\n            conversationKey = `property-${tenant.propertyId}-${tenant.tenantId}-${tenant.landlordId}`;\n            otherUserId = message.senderId === tenant.tenantId ? tenant.landlordId : tenant.tenantId;\n          } else {\n            continue;\n          }\n        }\n\n        if (!conversationsMap.has(conversationKey)) {\n          // Get the other user's details\n          const [otherUser] = await this.db\n            .select({\n              firstName: users.firstName,\n              lastName: users.lastName,\n              role: users.role,\n            })\n            .from(users)\n            .where(eq(users.id, otherUserId));\n\n          if (otherUser) {\n            conversationsMap.set(conversationKey, {\n              conversationKey,\n              otherUserId,\n              otherUserName: otherUser.firstName,\n              otherUserLastName: otherUser.lastName,\n              otherUserRole: otherUser.role,\n              lastMessage: message.content,\n              lastMessageTime: message.createdAt,\n              isGroupConversation: conversationKey.startsWith('property-'),\n            });\n          }\n        }\n      }\n\n      return Array.from(conversationsMap.values());\n    } catch (error) {\n      console.error('Error getting facilitator conversations:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Get maintenance requests for facilitator\n   */\n  async getFacilitatorMaintenanceRequests(facilitatorId: string) {\n    try {\n      return this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          priority: maintenanceRequests.priority,\n          status: maintenanceRequests.status,\n          images: maintenanceRequests.images,\n          createdAt: maintenanceRequests.createdAt,\n          updatedAt: maintenanceRequests.updatedAt,\n          tenantName: users.firstName,\n          tenantLastName: users.lastName,\n          propertyName: properties.name,\n          propertyAddress: properties.address,\n        })\n        .from(maintenanceRequests)\n        .leftJoin(users, eq(users.id, maintenanceRequests.tenantId))\n        .leftJoin(properties, eq(properties.id, maintenanceRequests.propertyId))\n        .where(eq(maintenanceRequests.assignedTo, facilitatorId))\n        .orderBy(desc(maintenanceRequests.createdAt));\n    } catch (error) {\n      console.error('Error getting facilitator maintenance requests:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Update maintenance request status (facilitator can update)\n   */\n  async updateMaintenanceRequestStatus(\n    requestId: string, \n    status: string, \n    facilitatorId: string,\n    notes?: string\n  ) {\n    try {\n      // Verify facilitator is assigned to this request\n      const [request] = await this.db\n        .select()\n        .from(maintenanceRequests)\n        .where(eq(maintenanceRequests.id, requestId));\n\n      if (!request) {\n        throw new NotFoundException('Maintenance request not found');\n      }\n\n      if (request.assignedTo !== facilitatorId) {\n        throw new ForbiddenException('You are not assigned to this maintenance request');\n      }\n\n      // Update the request\n      const updateData: any = {\n        status,\n        updatedAt: new Date(),\n      };\n\n      if (status === 'completed') {\n        updateData.completedAt = new Date();\n      }\n\n      const [updatedRequest] = await this.db\n        .update(maintenanceRequests)\n        .set(updateData)\n        .where(eq(maintenanceRequests.id, requestId))\n        .returning();\n\n      // Send notification message to tenant about status update\n      if (notes) {\n        await this.db.insert(messages).values({\n          senderId: facilitatorId,\n          receiverId: request.tenantId,\n          subject: `Maintenance Request Update: ${request.title}`,\n          content: `Your maintenance request status has been updated to \"${status}\". ${notes}`,\n        });\n      }\n\n      // Send push notification to tenant\n      try {\n        const statusEmoji = status === 'completed' ? 'âœ… ' : status === 'in_progress' ? 'ðŸ”§ ' : 'ðŸ“‹ ';\n        const statusText = status.replace('_', ' ').toUpperCase();\n\n        await this.notificationsService.sendNotification(\n          request.tenantId,\n          `${statusEmoji}Maintenance Update`,\n          `Your request \"${request.title}\" is now ${statusText}`,\n          {\n            type: 'maintenance',\n            id: requestId,\n            screen: 'MaintenanceDetail',\n            status,\n          },\n          NotificationType.MAINTENANCE\n        );\n      } catch (error) {\n        console.error('Error sending status update notification:', error);\n      }\n\n      return updatedRequest;\n    } catch (error) {\n      console.error('Error updating maintenance request status:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Update maintenance request priority\n   */\n  async updateMaintenanceRequestPriority(\n    requestId: string, \n    priority: string, \n    userId: string,\n    notes?: string\n  ) {\n    try {\n      // Get the request\n      const [request] = await this.db\n        .select()\n        .from(maintenanceRequests)\n        .where(eq(maintenanceRequests.id, requestId));\n\n      if (!request) {\n        throw new NotFoundException('Maintenance request not found');\n      }\n\n      // Update the priority\n      const [updatedRequest] = await this.db\n        .update(maintenanceRequests)\n        .set({\n          priority,\n          updatedAt: new Date(),\n        })\n        .where(eq(maintenanceRequests.id, requestId))\n        .returning();\n\n      // Send notification to tenant about priority change\n      if (notes) {\n        await this.db.insert(messages).values({\n          senderId: userId,\n          receiverId: request.tenantId,\n          subject: `Maintenance Request Priority Updated: ${request.title}`,\n          content: `The priority of your maintenance request has been updated to \"${priority}\". ${notes}`,\n        });\n      }\n\n      // Send push notification to tenant\n      try {\n        const priorityEmoji = priority === 'urgent' ? 'ðŸš¨ ' : priority === 'high' ? 'âš ï¸ ' : priority === 'medium' ? 'ðŸ“‹ ' : 'âœ… ';\n\n        await this.notificationsService.sendNotification(\n          request.tenantId,\n          `${priorityEmoji}Priority Updated`,\n          `Your request \"${request.title}\" priority changed to ${priority.toUpperCase()}`,\n          {\n            type: 'maintenance',\n            id: requestId,\n            screen: 'MaintenanceDetail',\n            priority,\n          },\n          NotificationType.MAINTENANCE\n        );\n      } catch (error) {\n        console.error('Error sending priority update notification:', error);\n      }\n\n      return updatedRequest;\n    } catch (error) {\n      console.error('Error updating maintenance request priority:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get tenant's property facilitator for direct communication\n   */\n  async getTenantPropertyFacilitator(tenantId: string) {\n    try {\n      const tenantProperty = await this.db\n        .select({\n          facilitatorId: properties.facilitatorId,\n          facilitatorFirstName: users.firstName,\n          facilitatorLastName: users.lastName,\n          facilitatorEmail: users.email,\n          propertyName: properties.name,\n        })\n        .from(tenantInvitations)\n        .leftJoin(properties, eq(properties.id, tenantInvitations.propertyId))\n        .leftJoin(users, eq(users.id, properties.facilitatorId))\n        .where(and(\n          eq(tenantInvitations.tenantId, tenantId),\n          eq(tenantInvitations.status, 'accepted')\n        ))\n        .limit(1);\n\n      if (!tenantProperty.length || !tenantProperty[0].facilitatorId) {\n        return null;\n      }\n\n      const facilitator = tenantProperty[0];\n      return {\n        id: facilitator.facilitatorId,\n        firstName: facilitator.facilitatorFirstName,\n        lastName: facilitator.facilitatorLastName,\n        email: facilitator.facilitatorEmail,\n        propertyName: facilitator.propertyName,\n      };\n    } catch (error) {\n      console.error('Error getting tenant property facilitator:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Add comment to maintenance request\n   */\n  async addMaintenanceComment(\n    requestId: string,\n    userId: string,\n    comment: string\n  ) {\n    try {\n      // Get the request to find tenant and assigned person\n      const [request] = await this.db\n        .select()\n        .from(maintenanceRequests)\n        .where(eq(maintenanceRequests.id, requestId));\n\n      if (!request) {\n        throw new NotFoundException('Maintenance request not found');\n      }\n\n      // Get user info\n      const [user] = await this.db\n        .select()\n        .from(users)\n        .where(eq(users.id, userId));\n\n      if (!user) {\n        throw new NotFoundException('User not found');\n      }\n\n      // Determine receiver based on who is commenting\n      let receiverId: string;\n      if (userId === request.tenantId) {\n        // Tenant commenting - send to assigned person (facilitator or landlord)\n        receiverId = request.assignedTo;\n      } else {\n        // Landlord/facilitator commenting - send to tenant\n        receiverId = request.tenantId;\n      }\n\n      // Create message as comment\n      await this.db.insert(messages).values({\n        senderId: userId,\n        receiverId,\n        subject: `Comment on: ${request.title}`,\n        content: comment,\n      });\n\n      // Send push notification\n      try {\n        await this.notificationsService.sendNotification(\n          receiverId,\n          `ðŸ’¬ New Comment`,\n          `${user.firstName} ${user.lastName}: ${comment.substring(0, 100)}${comment.length > 100 ? '...' : ''}`,\n          {\n            type: 'maintenance',\n            id: requestId,\n            screen: 'MaintenanceDetail',\n          },\n          NotificationType.MAINTENANCE\n        );\n      } catch (error) {\n        console.error('Error sending comment notification:', error);\n      }\n\n      return {\n        success: true,\n        message: 'Comment added successfully',\n        comment: {\n          userId,\n          userName: `${user.firstName} ${user.lastName}`,\n          comment,\n          createdAt: new Date(),\n        },\n      };\n    } catch (error) {\n      console.error('Error adding maintenance comment:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get maintenance request with full details including comments\n   */\n  async getMaintenanceRequestById(requestId: string, userId: string) {\n    try {\n      const [request] = await this.db\n        .select({\n          id: maintenanceRequests.id,\n          title: maintenanceRequests.title,\n          description: maintenanceRequests.description,\n          priority: maintenanceRequests.priority,\n          status: maintenanceRequests.status,\n          images: maintenanceRequests.images,\n          createdAt: maintenanceRequests.createdAt,\n          updatedAt: maintenanceRequests.updatedAt,\n          completedAt: maintenanceRequests.completedAt,\n          tenantId: maintenanceRequests.tenantId,\n          landlordId: maintenanceRequests.landlordId,\n          assignedTo: maintenanceRequests.assignedTo,\n          propertyId: maintenanceRequests.propertyId,\n          tenantFirstName: users.firstName,\n          tenantLastName: users.lastName,\n          propertyName: properties.name,\n          propertyAddress: properties.address,\n        })\n        .from(maintenanceRequests)\n        .leftJoin(users, eq(users.id, maintenanceRequests.tenantId))\n        .leftJoin(properties, eq(properties.id, maintenanceRequests.propertyId))\n        .where(eq(maintenanceRequests.id, requestId));\n\n      if (!request) {\n        throw new NotFoundException('Maintenance request not found');\n      }\n\n      // Get property facilitator details (only show if property has facilitator)\n      let assignedToDetails: { name: string; role: any } | null = null;\n      const [propertyDetails] = await this.db\n        .select({\n          facilitatorId: properties.facilitatorId,\n        })\n        .from(properties)\n        .where(eq(properties.id, request.propertyId));\n\n      // Only set assignedToDetails if property has a facilitator\n      if (propertyDetails?.facilitatorId) {\n        const [facilitator] = await this.db\n          .select({\n            firstName: users.firstName,\n            lastName: users.lastName,\n            role: users.role,\n          })\n          .from(users)\n          .where(eq(users.id, propertyDetails.facilitatorId));\n\n        if (facilitator) {\n          assignedToDetails = {\n            name: `${facilitator.firstName} ${facilitator.lastName}`,\n            role: facilitator.role,\n          };\n        }\n      }\n\n      // Get comments (messages related to this maintenance request)\n      // Comments are messages with subject containing the request title\n      const relatedMessages = await this.db\n        .select({\n          id: messages.id,\n          content: messages.content,\n          createdAt: messages.createdAt,\n          senderId: messages.senderId,\n          senderFirstName: users.firstName,\n          senderLastName: users.lastName,\n        })\n        .from(messages)\n        .leftJoin(users, eq(users.id, messages.senderId))\n        .where(\n          or(\n            and(\n              eq(messages.senderId, request.tenantId),\n              eq(messages.receiverId, request.assignedTo)\n            ),\n            and(\n              eq(messages.senderId, request.assignedTo),\n              eq(messages.receiverId, request.tenantId)\n            )\n          )\n        )\n        .orderBy(asc(messages.createdAt));\n\n      const comments = relatedMessages\n        .filter(msg => msg.content && msg.content.trim().length > 0)\n        .map(msg => ({\n          id: msg.id,\n          comment: msg.content,\n          author: `${msg.senderFirstName} ${msg.senderLastName}`,\n          authorName: `${msg.senderFirstName} ${msg.senderLastName}`,\n          userName: `${msg.senderFirstName} ${msg.senderLastName}`,\n          createdAt: msg.createdAt,\n        }));\n\n      return {\n        ...request,\n        tenant: {\n          firstName: request.tenantFirstName,\n          lastName: request.tenantLastName,\n        },\n        property: {\n          name: request.propertyName,\n          address: request.propertyAddress,\n        },\n        assignedToDetails,\n        comments,\n      };\n    } catch (error) {\n      console.error('Error getting maintenance request by ID:', error);\n      throw error;\n    }\n  }\n}\n\n\n\n"],"names":["EnhancedMessagesService","createWithFacilitatorRouting","senderId","createMessageDto","sender","db","select","from","users","where","eq","id","NotFoundException","finalReceiverId","receiverId","role","facilitatorId","getFacilitatorForTenantMessage","console","log","receiver","messageData","subject","content","message","insert","messages","values","returning","error","tenantId","intendedReceiverId","tenantProperty","propertyId","properties","landlordId","tenantInvitations","leftJoin","and","status","limit","length","property","createMaintenanceRequestWithRouting","createMaintenanceRequestDto","assignedTo","requestData","title","description","priority","images","request","maintenanceRequests","tenant","firstName","lastName","tenantName","priorityEmoji","notificationsService","sendNotification","type","screen","NotificationType","MAINTENANCE","getFacilitatorConversations","facilitatorProperties","propertyIds","map","p","propertyTenants","or","relevantMessages","createdAt","flatMap","pt","orderBy","desc","conversationsMap","Map","conversationKey","otherUserId","find","has","otherUser","set","otherUserName","otherUserLastName","otherUserRole","lastMessage","lastMessageTime","isGroupConversation","startsWith","Array","getFacilitatorMaintenanceRequests","updatedAt","tenantLastName","propertyName","name","propertyAddress","address","updateMaintenanceRequestStatus","requestId","notes","ForbiddenException","updateData","Date","completedAt","updatedRequest","update","statusEmoji","statusText","replace","toUpperCase","updateMaintenanceRequestPriority","userId","getTenantPropertyFacilitator","facilitatorFirstName","facilitatorLastName","facilitatorEmail","email","facilitator","addMaintenanceComment","comment","user","substring","success","userName","getMaintenanceRequestById","tenantFirstName","assignedToDetails","propertyDetails","relatedMessages","senderFirstName","senderLastName","asc","comments","filter","msg","trim","author","authorName"],"mappings":"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"}