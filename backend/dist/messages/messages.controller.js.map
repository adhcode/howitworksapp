{"version":3,"sources":["../../src/messages/messages.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Body,\n  Patch,\n  Param,\n  UseGuards,\n  Request,\n  Query,\n  Put,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { RolesGuard } from '../auth/guards/roles.guard';\nimport { Roles } from '../auth/decorators/roles.decorator';\nimport { UserRole } from '../auth/dto/auth.dto';\nimport { MessagesService } from './messages.service';\nimport { EnhancedMessagesService } from './enhanced-messages.service';\nimport { CreateMessageDto, UpdateMessageDto } from './dto/message.dto';\nimport { PaginationDto } from '../common/dto/pagination.dto';\n\n@ApiTags('Messages')\n@Controller('messages')\n@UseGuards(JwtAuthGuard, RolesGuard)\n@ApiBearerAuth('JWT-auth')\nexport class MessagesController {\n  constructor(\n    private readonly messagesService: MessagesService,\n    private readonly enhancedMessagesService: EnhancedMessagesService\n  ) {}\n\n  @Post()\n  @ApiOperation({ summary: 'Send a message (with facilitator routing for tenants)' })\n  @ApiResponse({ status: 201, description: 'Message sent successfully' })\n  async create(@Request() req, @Body() createMessageDto: CreateMessageDto) {\n    // Use enhanced service for facilitator routing\n    return this.enhancedMessagesService.createWithFacilitatorRouting(req.user.id, createMessageDto);\n  }\n\n  @Get('conversations')\n  @ApiOperation({ summary: 'Get user conversations' })\n  @ApiResponse({ status: 200, description: 'Conversations retrieved successfully' })\n  async getConversations(@Request() req) {\n    return this.messagesService.getConversations(req.user.id);\n  }\n\n  @Get('conversation/:otherUserId')\n  @ApiOperation({ summary: 'Get messages in a conversation' })\n  @ApiResponse({ status: 200, description: 'Messages retrieved successfully' })\n  async getConversation(\n    @Request() req,\n    @Param('otherUserId') otherUserId: string,\n    @Query() paginationDto: PaginationDto,\n  ) {\n    return this.messagesService.getConversation(req.user.id, otherUserId, paginationDto);\n  }\n\n  @Patch(':id/read')\n  @ApiOperation({ summary: 'Mark message as read' })\n  @ApiResponse({ status: 200, description: 'Message marked as read' })\n  async markAsRead(@Request() req, @Param('id') id: string) {\n    return this.messagesService.markAsRead(id, req.user.id);\n  }\n\n  @Get('unread-count')\n  @ApiOperation({ summary: 'Get unread message count' })\n  @ApiResponse({ status: 200, description: 'Unread count retrieved successfully' })\n  async getUnreadCount(@Request() req) {\n    return this.messagesService.getUnreadCount(req.user.id);\n  }\n\n  // Facilitator-specific endpoints\n  @Get('facilitator/conversations')\n  @Roles(UserRole.FACILITATOR)\n  @ApiOperation({ summary: 'Get facilitator conversations (includes tenant-landlord conversations)' })\n  @ApiResponse({ status: 200, description: 'Facilitator conversations retrieved successfully' })\n  async getFacilitatorConversations(@Request() req) {\n    return this.enhancedMessagesService.getFacilitatorConversations(req.user.id);\n  }\n\n  @Get('tenant/facilitator')\n  @Roles(UserRole.TENANT)\n  @ApiOperation({ summary: 'Get tenant property facilitator contact' })\n  @ApiResponse({ status: 200, description: 'Facilitator contact retrieved successfully' })\n  async getTenantPropertyFacilitator(@Request() req) {\n    const facilitator = await this.enhancedMessagesService.getTenantPropertyFacilitator(req.user.id);\n    return {\n      success: true,\n      data: facilitator,\n    };\n  }\n} "],"names":["MessagesController","create","req","createMessageDto","enhancedMessagesService","createWithFacilitatorRouting","user","id","getConversations","messagesService","getConversation","otherUserId","paginationDto","markAsRead","getUnreadCount","getFacilitatorConversations","getTenantPropertyFacilitator","facilitator","success","data","summary","status","description","FACILITATOR","TENANT"],"mappings":";;;;+BA0BaA;;;eAAAA;;;wBAfN;yBAC2D;8BACrC;4BACF;gCACL;yBACG;iCACO;yCACQ;4BACW;+BACrB;;;;;;;;;;;;;;;AAMvB,IAAA,AAAMA,qBAAN,MAAMA;IAMX,MAGMC,OAAO,AAAWC,GAAG,EAAE,AAAQC,gBAAkC,EAAE;QACvE,+CAA+C;QAC/C,OAAO,IAAI,CAACC,uBAAuB,CAACC,4BAA4B,CAACH,IAAII,IAAI,CAACC,EAAE,EAAEJ;IAChF;IAEA,MAGMK,iBAAiB,AAAWN,GAAG,EAAE;QACrC,OAAO,IAAI,CAACO,eAAe,CAACD,gBAAgB,CAACN,IAAII,IAAI,CAACC,EAAE;IAC1D;IAEA,MAGMG,gBACJ,AAAWR,GAAG,EACd,AAAsBS,WAAmB,EACzC,AAASC,aAA4B,EACrC;QACA,OAAO,IAAI,CAACH,eAAe,CAACC,eAAe,CAACR,IAAII,IAAI,CAACC,EAAE,EAAEI,aAAaC;IACxE;IAEA,MAGMC,WAAW,AAAWX,GAAG,EAAE,AAAaK,EAAU,EAAE;QACxD,OAAO,IAAI,CAACE,eAAe,CAACI,UAAU,CAACN,IAAIL,IAAII,IAAI,CAACC,EAAE;IACxD;IAEA,MAGMO,eAAe,AAAWZ,GAAG,EAAE;QACnC,OAAO,IAAI,CAACO,eAAe,CAACK,cAAc,CAACZ,IAAII,IAAI,CAACC,EAAE;IACxD;IAEA,iCAAiC;IACjC,MAIMQ,4BAA4B,AAAWb,GAAG,EAAE;QAChD,OAAO,IAAI,CAACE,uBAAuB,CAACW,2BAA2B,CAACb,IAAII,IAAI,CAACC,EAAE;IAC7E;IAEA,MAIMS,6BAA6B,AAAWd,GAAG,EAAE;QACjD,MAAMe,cAAc,MAAM,IAAI,CAACb,uBAAuB,CAACY,4BAA4B,CAACd,IAAII,IAAI,CAACC,EAAE;QAC/F,OAAO;YACLW,SAAS;YACTC,MAAMF;QACR;IACF;IAhEA,YACE,AAAiBR,eAAgC,EACjD,AAAiBL,uBAAgD,CACjE;aAFiBK,kBAAAA;aACAL,0BAAAA;IAChB;AA8DL;;;;QA3DkBgB,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;QAOzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;QAMzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;;;QAUzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;QAMzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;iDAOzBC;;QACAH,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;iDAMzBE;;QACAJ,SAAS;;;QACVC,QAAQ;QAAKC,aAAa"}