{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import { NestFactory } from '@nestjs/core';\nimport { FastifyAdapter, NestFastifyApplication } from '@nestjs/platform-fastify';\nimport { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';\nimport { ConfigService } from '@nestjs/config';\nimport { Logger, ValidationPipe } from '@nestjs/common';\nimport * as crypto from 'crypto';\nimport { AppModule } from './app.module';\nimport { GlobalExceptionFilter } from './common/filters/global-exception.filter';\nimport { ResponseInterceptor } from './common/interceptors/response.interceptor';\nimport { LoggingInterceptor } from './common/interceptors/logging.interceptor';\n\n// Polyfill crypto for Node.js 18+ compatibility with @nestjs/schedule\nif (typeof global.crypto === 'undefined') {\n  (global as any).crypto = crypto;\n}\n\nasync function bootstrap() {\n  const logger = new Logger('Bootstrap');\n\n  // Create Fastify app\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter({\n      logger: process.env.NODE_ENV === 'development',\n    }),\n  );\n\n  const configService = app.get(ConfigService);\n  const port = configService.get<number>('PORT') || 3000;\n  const nodeEnv = configService.get<string>('NODE_ENV') || 'development';\n\n  // Security middleware\n  await app.register(require('@fastify/helmet'), {\n    contentSecurityPolicy: {\n      directives: {\n        defaultSrc: [`'self'`],\n        styleSrc: [`'self'`, `'unsafe-inline'`],\n        scriptSrc: [`'self'`],\n        objectSrc: [`'none'`],\n        upgradeInsecureRequests: [],\n      },\n    },\n  });\n\n  // Compression\n  await app.register(require('@fastify/compress'), {\n    encodings: ['gzip', 'deflate'],\n  });\n\n  // File upload support\n  await app.register(require('@fastify/multipart'), {\n    limits: {\n      fileSize: 5 * 1024 * 1024, // 5MB\n    },\n  });\n\n  // Static file serving for uploads\n  const uploadsPath = require('path').join(__dirname, '..', 'uploads');\n\n  // Create uploads directory if it doesn't exist\n  const fs = require('fs');\n  if (!fs.existsSync(uploadsPath)) {\n    fs.mkdirSync(uploadsPath, { recursive: true });\n  }\n\n  await app.register(require('@fastify/static'), {\n    root: uploadsPath,\n    prefix: '/uploads/',\n  });\n\n  // CORS\n  app.enableCors({\n    origin: nodeEnv === 'production'\n      ? [\n        'capacitor://localhost',\n        'ionic://localhost',\n        'http://localhost',\n        'http://localhost:3000',\n        'http://localhost:3001', // Admin dashboard local\n        'http://localhost:8081', // Mobile app\n        'http://localhost:8100',\n        'https://howitworksapp.vercel.app', // Admin dashboard production (Vercel)\n        'https://app.howitworks.com.ng', // Admin dashboard custom domain\n      ]\n      : true,\n    credentials: true,\n    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\n    allowedHeaders: ['Content-Type', 'Authorization'],\n  });\n\n  // Global validation pipe\n  app.useGlobalPipes(\n    new ValidationPipe({\n      whitelist: true,\n      forbidNonWhitelisted: false, // Temporarily disabled for testing\n      transform: true,\n      disableErrorMessages: nodeEnv === 'production',\n    }),\n  );\n\n  // Global filters\n  app.useGlobalFilters(new GlobalExceptionFilter());\n\n  // Global interceptors\n  app.useGlobalInterceptors(\n    new LoggingInterceptor(),\n    new ResponseInterceptor(),\n  );\n\n  // Swagger documentation (only in development)\n  if (nodeEnv === 'development') {\n    const config = new DocumentBuilder()\n      .setTitle('Homezy API')\n      .setDescription('Property management platform API')\n      .setVersion('1.0')\n      .addBearerAuth(\n        {\n          type: 'http',\n          scheme: 'bearer',\n          bearerFormat: 'JWT',\n          name: 'JWT',\n          description: 'Enter JWT token',\n          in: 'header',\n        },\n        'JWT-auth',\n      )\n      .build();\n\n    const document = SwaggerModule.createDocument(app, config);\n    SwaggerModule.setup('api/docs', app, document, {\n      swaggerOptions: {\n        persistAuthorization: true,\n      },\n    });\n\n    logger.log(`üìö Swagger documentation available at http://localhost:${port}/api/docs`);\n  }\n\n  // Graceful shutdown\n  process.on('SIGTERM', async () => {\n    logger.log('SIGTERM received, shutting down gracefully');\n    await app.close();\n    process.exit(0);\n  });\n\n  process.on('SIGINT', async () => {\n    logger.log('SIGINT received, shutting down gracefully');\n    await app.close();\n    process.exit(0);\n  });\n\n  await app.listen(port, '0.0.0.0');\n\n  logger.log(`üöÄ Application is running on: http://localhost:${port}`);\n  logger.log(`üåç Environment: ${nodeEnv}`);\n  logger.log(`üìä Health check: http://localhost:${port}/health`);\n}\n\nbootstrap().catch((error) => {\n  console.error('‚ùå Error starting server:', error);\n  process.exit(1);\n});\n"],"names":["global","crypto","bootstrap","logger","Logger","app","NestFactory","create","AppModule","FastifyAdapter","process","env","NODE_ENV","configService","get","ConfigService","port","nodeEnv","register","require","contentSecurityPolicy","directives","defaultSrc","styleSrc","scriptSrc","objectSrc","upgradeInsecureRequests","encodings","limits","fileSize","uploadsPath","join","__dirname","fs","existsSync","mkdirSync","recursive","root","prefix","enableCors","origin","credentials","methods","allowedHeaders","useGlobalPipes","ValidationPipe","whitelist","forbidNonWhitelisted","transform","disableErrorMessages","useGlobalFilters","GlobalExceptionFilter","useGlobalInterceptors","LoggingInterceptor","ResponseInterceptor","config","DocumentBuilder","setTitle","setDescription","setVersion","addBearerAuth","type","scheme","bearerFormat","name","description","in","build","document","SwaggerModule","createDocument","setup","swaggerOptions","persistAuthorization","log","on","close","exit","listen","catch","error","console"],"mappings":"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"}