{"version":3,"sources":["../../../src/core/payments/payments.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Get,\n  Body,\n  Param,\n  Query,\n  UseGuards,\n  Request,\n  HttpStatus,\n  HttpException,\n  ParseUUIDPipe,\n  Delete,\n  Logger,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBearerAuth,\n  ApiParam,\n  ApiQuery,\n} from '@nestjs/swagger';\nimport { PaymentProcessorService } from './payment-processor.service';\nimport { PaystackService } from './paystack.service';\nimport { ContractsService } from '../contracts/contracts.service';\nimport { EscrowService } from '../escrow/escrow.service';\nimport { JwtAuthGuard } from '../../auth/guards/jwt-auth.guard';\nimport { RolesGuard } from '../../auth/guards/roles.guard';\nimport { Roles } from '../../auth/decorators/roles.decorator';\n\nenum UserRole {\n  ADMIN = 'admin',\n  LANDLORD = 'landlord',\n  TENANT = 'tenant',\n  FACILITATOR = 'facilitator',\n}\n\n/**\n * PAYMENTS CONTROLLER\n * \n * Complete Paystack-integrated payment management:\n * 1. Tenant payments (one-time & recurring)\n * 2. Landlord payouts/transfers\n * 3. Bank account management\n * 4. Payment history\n */\n@ApiTags('payments')\n@Controller('payments')\n@UseGuards(JwtAuthGuard, RolesGuard)\n@ApiBearerAuth()\nexport class PaymentsController {\n  private readonly logger = new Logger(PaymentsController.name);\n\n  constructor(\n    private readonly paymentProcessor: PaymentProcessorService,\n    private readonly paystackService: PaystackService,\n    private readonly contractsService: ContractsService,\n    private readonly escrowService: EscrowService,\n  ) {}\n\n  // ==========================================\n  // TENANT PAYMENT ENDPOINTS\n  // ==========================================\n\n  /**\n   * INITIALIZE PAYMENT\n   * \n   * Step 1: Initialize payment with Paystack.\n   * Returns authorization URL for tenant to complete payment.\n   */\n  @Post('initialize')\n  @Roles(UserRole.TENANT, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Initialize rent payment',\n    description: 'Initialize payment with Paystack. Returns authorization URL for payment.',\n  })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment initialized' })\n  @ApiResponse({ status: HttpStatus.BAD_REQUEST, description: 'Invalid request' })\n  async initializePayment(\n    @Body() dto: { contractId: string; email: string },\n    @Request() req: any\n  ) {\n    try {\n      // Get contract to verify tenant\n      const contract = await this.contractsService.getContractById(dto.contractId);\n\n      // Verify tenant owns this contract (unless admin)\n      if (req.user.role !== UserRole.ADMIN && contract.tenantId !== req.user.id) {\n        throw new HttpException(\n          'You can only make payments for your own contracts',\n          HttpStatus.FORBIDDEN\n        );\n      }\n\n      // Initialize payment\n      const result = await this.paymentProcessor.initializePayment(\n        dto.contractId,\n        dto.email,\n      );\n\n      return result;\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to initialize payment',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * INITIALIZE PAYSTACK PAYMENT (GENERIC)\n   * \n   * Initialize a generic Paystack payment (not tied to a contract).\n   * Used for one-time payments, top-ups, etc.\n   * Creates a payment record immediately with status='pending'\n   */\n  @Post('paystack/initialize')\n  @Roles(UserRole.TENANT, UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Initialize Paystack payment',\n    description: 'Initialize a generic payment with Paystack. Returns authorization URL.',\n  })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment initialized' })\n  @ApiResponse({ status: HttpStatus.BAD_REQUEST, description: 'Invalid request' })\n  async initializePaystackPayment(\n    @Body() dto: { \n      email: string; \n      amount: number; \n      currency?: string;\n      description?: string;\n      metadata?: any;\n    },\n    @Request() req: any\n  ) {\n    try {\n      this.logger.log(`üîÑ Initializing Paystack payment for ${dto.email}: ‚Ç¶${dto.amount}`);\n\n      // Check for existing pending payment for this tenant\n      const existingPending = await this.paymentProcessor.checkPendingPayment(req.user.id);\n      if (existingPending) {\n        this.logger.warn(`‚ö†Ô∏è User ${req.user.id} already has a pending payment`);\n        throw new HttpException(\n          'You already have a pending payment. Please complete or cancel it first.',\n          HttpStatus.CONFLICT\n        );\n      }\n\n      // Initialize payment with Paystack\n      // Note: Amount should be in Naira, PaystackService will convert to kobo\n      const result = await this.paystackService.initializeTransaction({\n        email: dto.email,\n        amount: dto.amount, // Send in Naira, service converts to kobo\n        currency: dto.currency || 'NGN',\n        metadata: {\n          ...dto.metadata,\n          userId: req.user.id,\n          userRole: req.user.role,\n          description: dto.description,\n        },\n      });\n\n      if (!result.status) {\n        throw new HttpException(\n          result.message || 'Failed to initialize payment',\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      // Create payment record in database with status='pending'\n      await this.paymentProcessor.createPendingPaymentRecord({\n        tenantId: req.user.id,\n        amount: dto.amount,\n        paystackReference: result.data?.reference || '',\n        description: dto.description,\n        metadata: dto.metadata,\n      });\n\n      this.logger.log(`‚úÖ Payment initialized and recorded: ${result.data?.reference}`);\n\n      return {\n        success: true,\n        authorization_url: result.data?.authorization_url,\n        access_code: result.data?.access_code,\n        reference: result.data?.reference,\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Payment initialization failed: ${error.message}`);\n      throw new HttpException(\n        error.message || 'Failed to initialize payment',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * VERIFY PAYMENT\n   * \n   * Verify payment status after Paystack redirect.\n   * Mobile app can call this to check if payment was successful.\n   */\n  @Get('verify/:reference')\n  @Roles(UserRole.TENANT, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Verify payment status' })\n  @ApiParam({ name: 'reference', description: 'Paystack payment reference' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment status' })\n  async verifyPayment(\n    @Param('reference') reference: string,\n  ) {\n    try {\n      const verification = await this.paystackService.verifyTransaction(reference);\n      \n      if (!verification.status) {\n        throw new HttpException(verification.message || 'Verification failed', HttpStatus.BAD_REQUEST);\n      }\n\n      return {\n        success: true,\n        data: {\n          reference: verification.data?.reference,\n          status: verification.data?.status,\n          amount: verification.data?.amount,\n          paid_at: verification.data?.paid_at,\n          message: verification.data?.gateway_response,\n        },\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to verify payment',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * VERIFY PAYSTACK PAYMENT (POST)\n   * \n   * Verify payment status via POST request.\n   * Updates payment record in database based on Paystack status.\n   */\n  @Post('paystack/verify')\n  @Roles(UserRole.TENANT, UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Verify Paystack payment' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment verified' })\n  async verifyPaystackPayment(\n    @Body() dto: { reference: string },\n  ) {\n    try {\n      this.logger.log(`üîç Verifying payment: ${dto.reference}`);\n\n      const verification = await this.paystackService.verifyTransaction(dto.reference);\n      \n      if (!verification.status) {\n        this.logger.error(`‚ùå Verification failed: ${verification.message}`);\n        throw new HttpException(verification.message || 'Verification failed', HttpStatus.BAD_REQUEST);\n      }\n\n      const paystackStatus = verification.data?.status || 'unknown';\n      this.logger.log(`‚úÖ Payment verified with Paystack: ${paystackStatus}`);\n      this.logger.log(`üí∞ Raw amount from Paystack: ${verification.data?.amount}`);\n      \n      // Paystack returns amount in kobo, so we need to pass it as-is\n      // The payment processor will validate it\n      await this.paymentProcessor.updatePaymentStatus(\n        dto.reference,\n        paystackStatus,\n        verification.data\n      );\n\n      return {\n        status: true,\n        data: {\n          reference: verification.data?.reference,\n          status: paystackStatus,\n          amount: verification.data?.amount ? verification.data.amount / 100 : 0, // Convert from kobo\n          paid_at: verification.data?.paid_at,\n          message: verification.data?.gateway_response,\n        },\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Verification error: ${error.message}`);\n      throw new HttpException(\n        error.message || 'Failed to verify payment',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * COMPLETE PAYMENT\n   * \n   * Verify and process payment through business logic.\n   * This updates the contract, creates payment records, and handles payouts.\n   * Call this after payment is successful to complete the transaction.\n   */\n  @Post('complete/:reference')\n  @Roles(UserRole.TENANT, UserRole.ADMIN)\n  @ApiOperation({ \n    summary: 'Complete payment processing',\n    description: 'Verify payment with Paystack and process through business logic (update contract, create records, etc.)'\n  })\n  @ApiParam({ name: 'reference', description: 'Paystack payment reference' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment completed' })\n  async completePayment(\n    @Param('reference') reference: string,\n  ) {\n    try {\n      const result = await this.paymentProcessor.completePayment(reference);\n      \n      return {\n        success: true,\n        message: 'Payment completed successfully',\n        data: result,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to complete payment',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * ENABLE RECURRING PAYMENTS\n   * \n   * Tenant opts in to recurring payments using their saved card.\n   * Card is saved automatically after first successful payment.\n   */\n  @Post('recurring/enable')\n  @Roles(UserRole.TENANT)\n  @ApiOperation({\n    summary: 'Enable recurring payments',\n    description: 'Enable automatic monthly payments using saved card',\n  })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Recurring payments enabled' })\n  async enableRecurringPayments(\n    @Body() dto: { contractId: string },\n    @Request() req: any\n  ) {\n    try {\n      // TODO: Update contract to enable recurring payments\n      // For now, just verify tenant has saved card\n\n      return {\n        success: true,\n        message: 'Recurring payments enabled. Your card will be charged automatically on the 1st of each month.',\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to enable recurring payments',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * CHARGE RECURRING PAYMENT\n   * \n   * Manually trigger recurring payment (usually called by cron job).\n   */\n  @Post('recurring/charge')\n  @Roles(UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Charge recurring payment',\n    description: 'Charge saved card for rent payment (admin only)',\n  })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment charged' })\n  async chargeRecurringPayment(\n    @Body() dto: { contractId: string; tenantId: string },\n  ) {\n    try {\n      const result = await this.paymentProcessor.chargeRecurringPayment(\n        dto.contractId,\n        dto.tenantId,\n      );\n\n      return {\n        success: true,\n        message: 'Recurring payment processed successfully',\n        data: result,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to charge recurring payment',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET PAYMENT HISTORY\n   * \n   * Retrieve payment history for a tenant.\n   */\n  @Get('history')\n  @Roles(UserRole.TENANT, UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get payment history' })\n  @ApiQuery({ name: 'tenantId', required: false })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment history retrieved' })\n  async getPaymentHistory(\n    @Query('tenantId') tenantId: string,\n    @Request() req: any\n  ) {\n    try {\n      // Tenants can only view their own history\n      if (req.user.role === UserRole.TENANT && tenantId !== req.user.id) {\n        throw new HttpException('Access denied', HttpStatus.FORBIDDEN);\n      }\n\n      const payments = await this.paymentProcessor.getPaymentHistory(\n        tenantId || req.user.id\n      );\n\n      return {\n        success: true,\n        data: payments,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch payment history',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET UPCOMING PAYMENTS\n   * \n   * Get list of upcoming rent payments for a tenant.\n   */\n  @Get('upcoming')\n  @Roles(UserRole.TENANT, UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get upcoming payments' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Upcoming payments retrieved' })\n  async getUpcomingPayments(@Request() req: any) {\n    try {\n      const payments = await this.paymentProcessor.getUpcomingPayments(req.user.id);\n\n      return {\n        success: true,\n        data: payments,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch upcoming payments',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  // ==========================================\n  // LANDLORD PAYOUT ENDPOINTS\n  // ==========================================\n\n  /**\n   * SETUP BANK ACCOUNT\n   * \n   * Landlord sets up bank account for receiving payouts.\n   */\n  @Post('landlord/setup-bank')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Setup landlord bank account',\n    description: 'Setup bank account for receiving rent payouts',\n  })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Bank account set up' })\n  async setupBankAccount(\n    @Body() dto: { account_number: string; bank_code: string },\n    @Request() req: any\n  ) {\n    try {\n      const result = await this.paymentProcessor.setupLandlordBankAccount(\n        req.user.id,\n        dto\n      );\n\n      return result;\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to setup bank account',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET BANK ACCOUNTS\n   * \n   * Get landlord's saved bank accounts.\n   */\n  @Get('landlord/bank-accounts')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Get saved bank accounts',\n    description: 'Retrieve landlord\\'s saved bank accounts',\n  })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Bank accounts retrieved' })\n  async getBankAccounts(@Request() req: any) {\n    try {\n      const accounts = await this.paymentProcessor.getLandlordBankAccounts(req.user.id);\n\n      return {\n        success: true,\n        data: accounts,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch bank accounts',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * REQUEST PAYOUT\n   * \n   * Landlord requests payout to their bank account.\n   */\n  @Post('landlord/request-payout')\n  @Roles(UserRole.LANDLORD)\n  @ApiOperation({\n    summary: 'Request payout',\n    description: 'Request transfer of available balance to bank account',\n  })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payout initiated' })\n  async requestPayout(\n    @Body() dto: { amount: number; reason?: string },\n    @Request() req: any\n  ) {\n    try {\n      // TODO: Verify landlord has sufficient balance\n      // For now, just initiate payout\n\n      const result = await this.paymentProcessor.processLandlordPayout(\n        req.user.id,\n        dto.amount,\n        dto.reason || 'Rent payout'\n      );\n\n      return result;\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to process payout',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET ESCROW BALANCE\n   * \n   * Get landlord's escrow balance (for yearly payouts).\n   */\n  @Get('landlord/escrow')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get escrow balance' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Escrow balance retrieved' })\n  async getEscrowBalance(@Request() req: any) {\n    try {\n      const balances = await this.escrowService.getEscrowBalances(req.user.id);\n\n      // Calculate total unreleased\n      const total = balances\n        .filter(b => !b.isReleased)\n        .reduce((sum, b) => sum + parseFloat(b.totalEscrowed), 0);\n\n      return {\n        success: true,\n        data: {\n          balances,\n          unreleasedTotal: total,\n        },\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch escrow balance',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET AVAILABLE BALANCE\n   * \n   * Get landlord's available balance for payout.\n   */\n  @Get('landlord/balance')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get available balance' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Balance retrieved' })\n  async getAvailableBalance(@Request() req: any) {\n    try {\n      // TODO: Calculate available balance from payments\n      // For now, return mock data\n\n      return {\n        success: true,\n        data: {\n          available: 0,\n          pending: 0,\n          currency: 'NGN',\n        },\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch balance',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  // ==========================================\n  // UTILITY ENDPOINTS\n  // ==========================================\n\n  /**\n   * GET BANKS LIST\n   * \n   * Get list of Nigerian banks for landlord account setup.\n   */\n  @Get('banks')\n  @Roles(UserRole.LANDLORD, UserRole.TENANT, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get list of banks' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Banks list retrieved' })\n  async getBanks() {\n    try {\n      const result = await this.paystackService.listBanks('nigeria');\n\n      if (!result.status) {\n        throw new HttpException(\n          result.message || 'Failed to fetch banks from Paystack',\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      if (!result.data || result.data.length === 0) {\n        throw new HttpException(\n          'No banks returned from Paystack',\n          HttpStatus.NOT_FOUND\n        );\n      }\n\n      return {\n        success: true,\n        data: result.data,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch banks',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * RESOLVE ACCOUNT NUMBER\n   * \n   * Verify bank account details before saving.\n   */\n  @Post('resolve-account')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Resolve bank account number' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Account resolved' })\n  async resolveAccount(\n    @Body() dto: { account_number: string; bank_code: string }\n  ) {\n    try {\n      this.logger.log(`üîç Resolving account: ${dto.account_number} at bank: ${dto.bank_code}`);\n      \n      const result = await this.paystackService.resolveAccountNumber(dto);\n\n      if (!result.status) {\n        this.logger.error(`‚ùå Account resolution failed: ${result.message}`);\n        throw new HttpException(\n          result.message || 'Invalid account number',\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      this.logger.log(`‚úÖ Account resolved successfully: ${result.data?.account_name}`);\n\n      return {\n        success: true,\n        data: result.data,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to resolve account',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * DELETE SAVED CARD\n   * \n   * Remove tenant's saved card (disable recurring payments).\n   */\n  @Delete('saved-card')\n  @Roles(UserRole.TENANT)\n  @ApiOperation({ summary: 'Delete saved card' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Card removed' })\n  async deleteSavedCard(@Request() req: any) {\n    try {\n      // TODO: Remove saved card from user record\n      // For now, just return success\n\n      return {\n        success: true,\n        message: 'Saved card removed successfully',\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to remove card',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  // ==========================================\n  // LANDLORD WALLET ENDPOINTS\n  // ==========================================\n\n  /**\n   * GET WALLET BALANCE\n   * \n   * Get landlord's current wallet balance.\n   */\n  @Get('wallet/balance')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get wallet balance' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Balance retrieved' })\n  async getWalletBalance(@Request() req: any) {\n    try {\n      const balance = await this.paymentProcessor.getWalletBalance(req.user.id);\n\n      return {\n        success: true,\n        data: balance,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch wallet balance',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET WALLET TRANSACTIONS\n   * \n   * Get landlord's wallet transaction history.\n   */\n  @Get('wallet/transactions')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get wallet transactions' })\n  @ApiQuery({ name: 'limit', required: false })\n  @ApiQuery({ name: 'offset', required: false })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Transactions retrieved' })\n  async getWalletTransactions(\n    @Request() req: any,\n    @Query('limit') limit?: string,\n    @Query('offset') offset?: string,\n  ) {\n    try {\n      const transactions = await this.paymentProcessor.getWalletTransactions(\n        req.user.id,\n        {\n          limit: limit ? parseInt(limit) : 50,\n          offset: offset ? parseInt(offset) : 0,\n        }\n      );\n\n      return {\n        success: true,\n        data: transactions,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch transactions',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET LANDLORD PAYMENT STATS\n   * \n   * Get comprehensive payment statistics for landlord dashboard.\n   */\n  @Get('landlord/stats')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({ summary: 'Get landlord payment statistics' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment stats retrieved' })\n  async getLandlordPaymentStats(@Request() req: any) {\n    try {\n      const stats = await this.paymentProcessor.getLandlordPaymentStats(req.user.id);\n\n      return {\n        success: true,\n        data: stats,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch payment stats',\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * REQUEST WITHDRAWAL\n   * \n   * Landlord requests to withdraw funds to their bank account.\n   */\n  @Post('wallet/withdraw')\n  @Roles(UserRole.LANDLORD)\n  @ApiOperation({ summary: 'Request withdrawal' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Withdrawal initiated' })\n  async requestWithdrawal(\n    @Body() dto: { amount: number; reason?: string },\n    @Request() req: any\n  ) {\n    try {\n      const result = await this.paymentProcessor.processWithdrawal(\n        req.user.id,\n        dto.amount,\n        dto.reason\n      );\n\n      return {\n        success: true,\n        message: 'Withdrawal request processed successfully',\n        data: result,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to process withdrawal',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n}\n"],"names":["PaymentsController","UserRole","initializePayment","dto","req","contract","contractsService","getContractById","contractId","user","role","tenantId","id","HttpException","HttpStatus","FORBIDDEN","result","paymentProcessor","email","error","message","status","BAD_REQUEST","initializePaystackPayment","logger","log","amount","existingPending","checkPendingPayment","warn","CONFLICT","paystackService","initializeTransaction","currency","metadata","userId","userRole","description","createPendingPaymentRecord","paystackReference","data","reference","success","authorization_url","access_code","verifyPayment","verification","verifyTransaction","paid_at","gateway_response","verifyPaystackPayment","paystackStatus","updatePaymentStatus","completePayment","enableRecurringPayments","chargeRecurringPayment","getPaymentHistory","payments","getUpcomingPayments","setupBankAccount","setupLandlordBankAccount","getBankAccounts","accounts","getLandlordBankAccounts","requestPayout","processLandlordPayout","reason","getEscrowBalance","balances","escrowService","getEscrowBalances","total","filter","b","isReleased","reduce","sum","parseFloat","totalEscrowed","unreleasedTotal","getAvailableBalance","available","pending","getBanks","listBanks","length","NOT_FOUND","resolveAccount","account_number","bank_code","resolveAccountNumber","account_name","deleteSavedCard","getWalletBalance","balance","getWalletTransactions","limit","offset","transactions","parseInt","getLandlordPaymentStats","stats","requestWithdrawal","processWithdrawal","Logger","name","summary","OK","required"],"mappings":"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"}