{"version":3,"sources":["../../../src/core/payments/paystack.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport axios, { AxiosInstance } from 'axios';\n\n/**\n * PAYSTACK SERVICE\n * \n * Complete Paystack integration for:\n * 1. Tenant payments (one-time & recurring)\n * 2. Landlord cashouts/transfers\n * 3. Card management for recurring payments\n * 4. Webhook verification\n */\n@Injectable()\nexport class PaystackService {\n  private readonly logger = new Logger(PaystackService.name);\n  private readonly baseUrl = 'https://api.paystack.co';\n  private readonly axiosInstance: AxiosInstance;\n  private readonly secretKey: string | undefined;\n\n  constructor(private configService: ConfigService) {\n    this.secretKey = this.configService.get<string>('PAYSTACK_SECRET_KEY');\n    \n    if (!this.secretKey) {\n      this.logger.warn('‚ö†Ô∏è PAYSTACK_SECRET_KEY not configured');\n    }\n\n    this.axiosInstance = axios.create({\n      baseURL: this.baseUrl,\n      headers: {\n        Authorization: `Bearer ${this.secretKey}`,\n        'Content-Type': 'application/json',\n      },\n      timeout: 30000,\n    });\n  }\n\n  // ==========================================\n  // TENANT PAYMENT METHODS\n  // ==========================================\n\n  /**\n   * Initialize one-time payment\n   */\n  async initializeTransaction(data: {\n    email: string;\n    amount: number;\n    currency?: string;\n    reference?: string;\n    callback_url?: string;\n    metadata?: any;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      authorization_url: string;\n      access_code: string;\n      reference: string;\n    };\n  }> {\n    try {\n      this.logger.log(`üí≥ Initializing payment: ${data.email} - ‚Ç¶${data.amount}`);\n      \n      const amountInKobo = Math.round(data.amount * 100);\n      this.logger.log(`üí∞ Sending to Paystack: ${amountInKobo} kobo (‚Ç¶${data.amount})`);\n\n      const payload = {\n        email: data.email,\n        amount: amountInKobo, // Convert to kobo\n        currency: data.currency || 'NGN',\n        reference: data.reference || this.generateReference(),\n        callback_url: data.callback_url || this.configService.get('PAYSTACK_CALLBACK_URL'),\n        metadata: data.metadata,\n      };\n\n      this.logger.log(`üì§ Payload to Paystack: ${JSON.stringify(payload)}`);\n\n      const response = await this.axiosInstance.post('/transaction/initialize', payload);\n\n      this.logger.log(`‚úÖ Payment initialized: ${response.data.data.reference}`);\n      this.logger.log(`üì• Paystack response amount: ${response.data.data.amount}`);\n\n      return {\n        status: true,\n        data: {\n          authorization_url: response.data.data.authorization_url,\n          access_code: response.data.data.access_code,\n          reference: response.data.data.reference,\n        },\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Payment initialization failed: ${error.message}`);\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  /**\n   * Verify transaction status\n   */\n  async verifyTransaction(reference: string): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      id: number;\n      status: string;\n      reference: string;\n      amount: number;\n      gateway_response: string;\n      paid_at: string;\n      created_at: string;\n      channel: string;\n      currency: string;\n      customer: any;\n      authorization: any;\n      metadata: any;\n    };\n  }> {\n    try {\n      this.logger.log(`üîç Verifying transaction: ${reference}`);\n\n      const response = await this.axiosInstance.get(`/transaction/verify/${reference}`);\n      const data = response.data.data;\n\n      this.logger.log(`‚úÖ Transaction verified: ${reference} - ${data.status}`);\n\n      return {\n        status: true,\n        data: {\n          id: data.id,\n          status: data.status,\n          reference: data.reference,\n          amount: data.amount / 100, // Convert from kobo\n          gateway_response: data.gateway_response,\n          paid_at: data.paid_at,\n          created_at: data.created_at,\n          channel: data.channel,\n          currency: data.currency,\n          customer: data.customer,\n          authorization: data.authorization, // Card details for recurring\n          metadata: data.metadata,\n        },\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Verification failed: ${error.message}`);\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  // ==========================================\n  // RECURRING PAYMENT METHODS (SAVED CARDS)\n  // ==========================================\n\n  /**\n   * Charge saved card (for recurring payments)\n   */\n  async chargeAuthorization(data: {\n    email: string;\n    amount: number;\n    authorization_code: string;\n    reference?: string;\n    metadata?: any;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      reference: string;\n      status: string;\n      amount: number;\n    };\n  }> {\n    try {\n      this.logger.log(`üí≥ Charging saved card: ${data.email} - ‚Ç¶${data.amount}`);\n\n      const response = await this.axiosInstance.post('/transaction/charge_authorization', {\n        email: data.email,\n        amount: Math.round(data.amount * 100),\n        authorization_code: data.authorization_code,\n        reference: data.reference || this.generateReference(),\n        metadata: data.metadata,\n      });\n\n      this.logger.log(`‚úÖ Card charged: ${response.data.data.reference}`);\n\n      return {\n        status: true,\n        data: {\n          reference: response.data.data.reference,\n          status: response.data.data.status,\n          amount: response.data.data.amount / 100,\n        },\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Card charge failed: ${error.message}`);\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  /**\n   * Check if authorization is reusable\n   */\n  async checkAuthorization(data: {\n    email: string;\n    authorization_code: string;\n    amount: number;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      reusable: boolean;\n      account_name: string;\n      bank: string;\n    };\n  }> {\n    try {\n      const response = await this.axiosInstance.post('/transaction/check_authorization', {\n        email: data.email,\n        authorization_code: data.authorization_code,\n        amount: Math.round(data.amount * 100),\n      });\n\n      return {\n        status: true,\n        data: response.data.data,\n      };\n    } catch (error) {\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  // ==========================================\n  // LANDLORD PAYOUT/TRANSFER METHODS\n  // ==========================================\n\n  /**\n   * Create transfer recipient (landlord bank account)\n   */\n  async createTransferRecipient(data: {\n    type: 'nuban' | 'mobile_money' | 'basa';\n    name: string;\n    account_number: string;\n    bank_code: string;\n    currency?: string;\n    metadata?: any;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      recipient_code: string;\n      type: string;\n      name: string;\n      details: any;\n    };\n  }> {\n    try {\n      this.logger.log(`üè¶ Creating transfer recipient: ${data.name}`);\n\n      const response = await this.axiosInstance.post('/transferrecipient', {\n        type: data.type,\n        name: data.name,\n        account_number: data.account_number,\n        bank_code: data.bank_code,\n        currency: data.currency || 'NGN',\n        metadata: data.metadata,\n      });\n\n      this.logger.log(`‚úÖ Recipient created: ${response.data.data.recipient_code}`);\n\n      return {\n        status: true,\n        data: {\n          recipient_code: response.data.data.recipient_code,\n          type: response.data.data.type,\n          name: response.data.data.name,\n          details: response.data.data.details,\n        },\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Recipient creation failed: ${error.message}`);\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  /**\n   * Initiate transfer to landlord\n   */\n  async initiateTransfer(data: {\n    amount: number;\n    recipient: string; // recipient_code\n    reason?: string;\n    reference?: string;\n    currency?: string;\n    metadata?: any;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      transfer_code: string;\n      reference: string;\n      amount: number;\n      status: string;\n    };\n  }> {\n    try {\n      this.logger.log(`üí∏ Initiating transfer: ‚Ç¶${data.amount} to ${data.recipient}`);\n\n      const response = await this.axiosInstance.post('/transfer', {\n        source: 'balance',\n        amount: Math.round(data.amount * 100),\n        recipient: data.recipient,\n        reason: data.reason || 'Rent payout',\n        reference: data.reference || this.generateReference('transfer'),\n        currency: data.currency || 'NGN',\n        metadata: data.metadata,\n      });\n\n      this.logger.log(`‚úÖ Transfer initiated: ${response.data.data.transfer_code}`);\n\n      return {\n        status: true,\n        data: {\n          transfer_code: response.data.data.transfer_code,\n          reference: response.data.data.reference,\n          amount: response.data.data.amount / 100,\n          status: response.data.data.status,\n        },\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Transfer failed: ${error.message}`);\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  /**\n   * Verify transfer status\n   */\n  async verifyTransfer(reference: string): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      reference: string;\n      status: string;\n      amount: number;\n      recipient: any;\n    };\n  }> {\n    try {\n      const response = await this.axiosInstance.get(`/transfer/verify/${reference}`);\n      const data = response.data.data;\n\n      return {\n        status: true,\n        data: {\n          reference: data.reference,\n          status: data.status,\n          amount: data.amount / 100,\n          recipient: data.recipient,\n        },\n      };\n    } catch (error) {\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  /**\n   * Finalize transfer (for OTP-enabled transfers)\n   */\n  async finalizeTransfer(data: {\n    transfer_code: string;\n    otp: string;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n  }> {\n    try {\n      await this.axiosInstance.post('/transfer/finalize_transfer', {\n        transfer_code: data.transfer_code,\n        otp: data.otp,\n      });\n\n      return { status: true };\n    } catch (error) {\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  // ==========================================\n  // BANK & CUSTOMER METHODS\n  // ==========================================\n\n  /**\n   * Get list of banks\n   */\n  async listBanks(country: string = 'nigeria'): Promise<{\n    status: boolean;\n    data?: Array<{\n      id: number;\n      name: string;\n      code: string;\n      active: boolean;\n    }>;\n    message?: string;\n  }> {\n    try {\n      this.logger.log(`üè¶ Fetching banks list from Paystack (country: ${country})`);\n      \n      const response = await this.axiosInstance.get('/bank', {\n        params: { country, perPage: 100 },\n      });\n\n      this.logger.log(`‚úÖ Paystack returned ${response.data.data?.length || 0} banks`);\n\n      return {\n        status: true,\n        data: response.data.data,\n      };\n    } catch (error: any) {\n      this.logger.error(`‚ùå Paystack banks API error: ${error.message}`);\n      if (error.response) {\n        this.logger.error(`   Status: ${error.response.status}`);\n        this.logger.error(`   Data: ${JSON.stringify(error.response.data)}`);\n      }\n      return { \n        status: false,\n        message: error.message || 'Failed to fetch banks from Paystack'\n      };\n    }\n  }\n\n  /**\n   * Resolve account number to get account name\n   */\n  async resolveAccountNumber(data: {\n    account_number: string;\n    bank_code: string;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      account_number: string;\n      account_name: string;\n      bank_id: number;\n    };\n  }> {\n    try {\n      this.logger.log(`üîç Resolving account: ${data.account_number} at bank: ${data.bank_code}`);\n      \n      const response = await this.axiosInstance.get('/bank/resolve', {\n        params: {\n          account_number: data.account_number,\n          bank_code: data.bank_code,\n        },\n      });\n\n      this.logger.log(`‚úÖ Account resolved: ${response.data.data?.account_name}`);\n\n      return {\n        status: true,\n        data: response.data.data,\n      };\n    } catch (error: any) {\n      this.logger.error(`‚ùå Account resolution error: ${error.message}`);\n      if (error.response) {\n        this.logger.error(`   Status: ${error.response.status}`);\n        this.logger.error(`   Data: ${JSON.stringify(error.response.data)}`);\n      }\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  /**\n   * Create Paystack customer\n   */\n  async createCustomer(data: {\n    email: string;\n    first_name: string;\n    last_name: string;\n    phone?: string;\n    metadata?: any;\n  }): Promise<{\n    status: boolean;\n    message?: string;\n    data?: {\n      customer_code: string;\n      email: string;\n      id: number;\n    };\n  }> {\n    try {\n      const response = await this.axiosInstance.post('/customer', data);\n\n      return {\n        status: true,\n        data: {\n          customer_code: response.data.data.customer_code,\n          email: response.data.data.email,\n          id: response.data.data.id,\n        },\n      };\n    } catch (error) {\n      return {\n        status: false,\n        message: error.response?.data?.message || error.message,\n      };\n    }\n  }\n\n  // ==========================================\n  // WEBHOOK & UTILITY METHODS\n  // ==========================================\n\n  /**\n   * Verify webhook signature\n   */\n  verifyWebhookSignature(signature: string, body: string): boolean {\n    const crypto = require('crypto');\n    const webhookSecret = this.configService.get<string>('PAYSTACK_WEBHOOK_SECRET');\n    \n    if (!webhookSecret) {\n      this.logger.error('‚ùå PAYSTACK_WEBHOOK_SECRET not configured');\n      return false;\n    }\n\n    const hash = crypto\n      .createHmac('sha512', webhookSecret)\n      .update(body)\n      .digest('hex');\n\n    return hash === signature;\n  }\n\n  /**\n   * Generate unique reference\n   */\n  generateReference(prefix: string = 'rent'): string {\n    const timestamp = Date.now();\n    const random = Math.random().toString(36).substring(2, 15);\n    return `homezy_${prefix}_${timestamp}_${random}`;\n  }\n\n  /**\n   * Get balance\n   */\n  async getBalance(): Promise<{\n    status: boolean;\n    data?: Array<{\n      currency: string;\n      balance: number;\n    }>;\n  }> {\n    try {\n      const response = await this.axiosInstance.get('/balance');\n      \n      return {\n        status: true,\n        data: response.data.data.map((item: any) => ({\n          currency: item.currency,\n          balance: item.balance / 100,\n        })),\n      };\n    } catch (error) {\n      return { status: false };\n    }\n  }\n}\n\n"],"names":["PaystackService","initializeTransaction","data","logger","log","email","amount","amountInKobo","Math","round","payload","currency","reference","generateReference","callback_url","configService","get","metadata","JSON","stringify","response","axiosInstance","post","status","authorization_url","access_code","error","message","verifyTransaction","id","gateway_response","paid_at","created_at","channel","customer","authorization","chargeAuthorization","authorization_code","checkAuthorization","createTransferRecipient","name","type","account_number","bank_code","recipient_code","details","initiateTransfer","recipient","source","reason","transfer_code","verifyTransfer","finalizeTransfer","otp","listBanks","country","params","perPage","length","resolveAccountNumber","account_name","createCustomer","customer_code","verifyWebhookSignature","signature","body","crypto","require","webhookSecret","hash","createHmac","update","digest","prefix","timestamp","Date","now","random","toString","substring","getBalance","map","item","balance","Logger","baseUrl","secretKey","warn","axios","create","baseURL","headers","Authorization","timeout"],"mappings":"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"}