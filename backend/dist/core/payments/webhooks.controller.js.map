{"version":3,"sources":["../../../src/core/payments/webhooks.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Body,\n  Headers,\n  HttpStatus,\n  HttpException,\n  Logger,\n  Get,\n  Param,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiExcludeEndpoint, ApiParam } from '@nestjs/swagger';\nimport { PaystackService } from './paystack.service';\nimport { PaymentProcessorService } from './payment-processor.service';\n\n/**\n * WEBHOOKS CONTROLLER\n * \n * Handles Paystack webhooks for:\n * 1. Payment confirmations (charge.success)\n * 2. Payment failures (charge.failed)\n * 3. Transfer completions (transfer.success)\n * 4. Transfer failures (transfer.failed)\n */\n@ApiTags('webhooks')\n@Controller('webhooks')\nexport class WebhooksController {\n  private readonly logger = new Logger(WebhooksController.name);\n\n  constructor(\n    private readonly paystackService: PaystackService,\n    private readonly paymentProcessor: PaymentProcessorService,\n  ) {}\n\n  /**\n   * PAYSTACK WEBHOOK HANDLER\n   * \n   * Receives and processes webhooks from Paystack.\n   * MUST verify signature for security.\n   */\n  @Post('paystack')\n  @ApiExcludeEndpoint() // Hide from Swagger (internal endpoint)\n  @ApiOperation({ summary: 'Paystack webhook handler' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Webhook processed' })\n  async handlePaystackWebhook(\n    @Headers('x-paystack-signature') signature: string,\n    @Body() body: any,\n  ) {\n    this.logger.log('üì® Received Paystack webhook');\n\n    // Verify webhook signature (CRITICAL for security)\n    const rawBody = JSON.stringify(body);\n    const isValid = this.paystackService.verifyWebhookSignature(signature, rawBody);\n\n    if (!isValid) {\n      this.logger.error('‚ùå Invalid webhook signature - possible fraud attempt!');\n      throw new HttpException('Invalid signature', HttpStatus.UNAUTHORIZED);\n    }\n\n    this.logger.log('‚úÖ Webhook signature verified');\n\n    // Handle different event types\n    const event = body.event;\n    const data = body.data;\n\n    try {\n      switch (event) {\n        case 'charge.success':\n          this.logger.log(`üí∞ Payment successful: ${data.reference}`);\n          \n          // Process payment asynchronously (don't block webhook response)\n          this.processPaymentAsync(data.reference);\n          \n          break;\n\n        case 'charge.failed':\n          this.logger.warn(`‚ö†Ô∏è Payment failed: ${data.reference}`);\n          // TODO: Update payment record, notify tenant\n          break;\n\n        case 'transfer.success':\n          this.logger.log(`üí∏ Transfer successful: ${data.reference}`);\n          // TODO: Update landlord payout record\n          break;\n\n        case 'transfer.failed':\n        case 'transfer.reversed':\n          this.logger.error(`‚ùå Transfer failed/reversed: ${data.reference}`);\n          // TODO: Update landlord payout record, notify admin\n          break;\n\n        default:\n          this.logger.log(`‚ÑπÔ∏è Unhandled event type: ${event}`);\n      }\n\n      // Return 200 OK quickly (Paystack expects fast response)\n      return { status: 'success', message: 'Webhook received' };\n    } catch (error) {\n      this.logger.error(`‚ùå Webhook processing error: ${error.message}`);\n      // Still return 200 to prevent Paystack retries\n      return { status: 'error', message: error.message };\n    }\n  }\n\n  /**\n   * PAYMENT CALLBACK (for mobile redirect)\n   * \n   * GET endpoint for payment confirmation redirect from Paystack.\n   * Mobile app can use this or just verify with backend directly.\n   */\n  @Get('payment/callback')\n  @ApiOperation({ summary: 'Payment callback redirect from Paystack' })\n  @ApiResponse({ status: HttpStatus.OK, description: 'Payment status' })\n  async paymentCallback(\n    @Param('reference') reference: string,\n  ) {\n    try {\n      const verification = await this.paystackService.verifyTransaction(reference);\n      \n      return {\n        success: verification.status && verification.data?.status === 'success',\n        reference: reference,\n        status: verification.data?.status,\n        message: verification.data?.gateway_response || 'Payment processed',\n      };\n    } catch (error) {\n      return {\n        success: false,\n        message: error.message,\n      };\n    }\n  }\n\n  /**\n   * Process payment asynchronously (non-blocking)\n   */\n  private async processPaymentAsync(reference: string) {\n    try {\n      await this.paymentProcessor.completePayment(reference);\n      this.logger.log(`‚úÖ Payment processed successfully: ${reference}`);\n    } catch (error) {\n      this.logger.error(`‚ùå Failed to process payment ${reference}: ${error.message}`);\n      // TODO: Queue for retry or manual review\n      // Could use Bull Queue or similar for retry logic\n    }\n  }\n}\n\n\n\n"],"names":["WebhooksController","handlePaystackWebhook","signature","body","logger","log","rawBody","JSON","stringify","isValid","paystackService","verifyWebhookSignature","error","HttpException","HttpStatus","UNAUTHORIZED","event","data","reference","processPaymentAsync","warn","status","message","paymentCallback","verification","verifyTransaction","success","gateway_response","paymentProcessor","completePayment","Logger","name","summary","OK","description"],"mappings":"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"}