{"version":3,"sources":["../../../src/core/wallet/wallet.service.ts"],"sourcesContent":["import { Injectable, Inject, Logger, BadRequestException, NotFoundException } from '@nestjs/common';\nimport { PostgresJsDatabase } from 'drizzle-orm/postgres-js';\nimport { eq, and, desc, sql } from 'drizzle-orm';\nimport { DATABASE_CONNECTION } from '../../database/database.module';\nimport * as schema from '../../database/schema';\nimport { \n  landlordWalletBalances, \n  walletTransactions,\n  NewLandlordWalletBalance,\n  NewWalletTransaction,\n} from '../../database/schema/wallet';\n\n/**\n * WALLET SERVICE\n * \n * Manages landlord wallet balances and transactions.\n * Handles credits, debits, and withdrawal processing.\n */\n@Injectable()\nexport class WalletService {\n  private readonly logger = new Logger(WalletService.name);\n\n  constructor(\n    @Inject(DATABASE_CONNECTION)\n    private readonly db: PostgresJsDatabase<typeof schema>,\n  ) {}\n\n  /**\n   * GET OR CREATE WALLET BALANCE\n   * \n   * Gets existing wallet or creates new one for landlord.\n   */\n  async getOrCreateWallet(landlordId: string) {\n    // Try to get existing wallet\n    const [existing] = await this.db\n      .select()\n      .from(landlordWalletBalances)\n      .where(eq(landlordWalletBalances.landlordId, landlordId))\n      .limit(1);\n\n    if (existing) {\n      return existing;\n    }\n\n    // Create new wallet\n    const newWallet: NewLandlordWalletBalance = {\n      landlordId,\n      availableBalance: '0.00',\n      pendingBalance: '0.00',\n      totalEarned: '0.00',\n      totalWithdrawn: '0.00',\n      currency: 'NGN',\n    };\n\n    const [created] = await this.db\n      .insert(landlordWalletBalances)\n      .values(newWallet)\n      .returning();\n\n    this.logger.log(`âœ… Created new wallet for landlord ${landlordId}`);\n    return created;\n  }\n\n  /**\n   * CREDIT WALLET\n   * \n   * Adds money to landlord's available balance.\n   * Used when tenant makes a payment.\n   */\n  async credit(\n    landlordId: string,\n    amount: number,\n    metadata: {\n      type: string;\n      contractId?: string;\n      paymentId?: string;\n      reference?: string;\n      description?: string;\n    }\n  ) {\n    this.logger.log(`ðŸ’° Crediting wallet: ${landlordId} - â‚¦${amount}`);\n\n    // Get or create wallet\n    const wallet = await this.getOrCreateWallet(landlordId);\n\n    const balanceBefore = parseFloat(wallet.availableBalance);\n    const balanceAfter = balanceBefore + amount;\n    const newTotalEarned = parseFloat(wallet.totalEarned) + amount;\n\n    // Create transaction record\n    const transaction: NewWalletTransaction = {\n      landlordId,\n      type: 'credit',\n      amount: amount.toFixed(2),\n      balanceBefore: balanceBefore.toFixed(2),\n      balanceAfter: balanceAfter.toFixed(2),\n      reference: metadata.reference,\n      paymentId: metadata.paymentId,\n      status: 'completed',\n      description: metadata.description || `Credit from ${metadata.type}`,\n      metadata: JSON.stringify(metadata),\n    };\n\n    const [createdTransaction] = await this.db\n      .insert(walletTransactions)\n      .values(transaction)\n      .returning();\n\n    // Update wallet balance\n    await this.db\n      .update(landlordWalletBalances)\n      .set({\n        availableBalance: balanceAfter.toFixed(2),\n        totalEarned: newTotalEarned.toFixed(2),\n        updatedAt: new Date(),\n      })\n      .where(eq(landlordWalletBalances.landlordId, landlordId));\n\n    this.logger.log(`âœ… Wallet credited: ${landlordId} - Balance: â‚¦${balanceAfter}`);\n\n    return createdTransaction;\n  }\n\n  /**\n   * DEBIT WALLET\n   * \n   * Removes money from landlord's available balance.\n   * Used for withdrawals or refunds.\n   */\n  async debit(\n    landlordId: string,\n    amount: number,\n    metadata: {\n      type: string;\n      reference?: string;\n      description?: string;\n    }\n  ) {\n    this.logger.log(`ðŸ’¸ Debiting wallet: ${landlordId} - â‚¦${amount}`);\n\n    // Get wallet\n    const wallet = await this.getOrCreateWallet(landlordId);\n\n    const balanceBefore = parseFloat(wallet.availableBalance);\n\n    // Check sufficient balance\n    if (balanceBefore < amount) {\n      throw new BadRequestException(\n        `Insufficient balance. Available: â‚¦${balanceBefore}, Required: â‚¦${amount}`\n      );\n    }\n\n    const balanceAfter = balanceBefore - amount;\n    const newTotalWithdrawn = parseFloat(wallet.totalWithdrawn) + amount;\n\n    // Create transaction record\n    const transaction: NewWalletTransaction = {\n      landlordId,\n      type: metadata.type === 'withdrawal' ? 'withdrawal' : 'debit',\n      amount: amount.toFixed(2),\n      balanceBefore: balanceBefore.toFixed(2),\n      balanceAfter: balanceAfter.toFixed(2),\n      reference: metadata.reference,\n      status: 'completed',\n      description: metadata.description || `Debit for ${metadata.type}`,\n      metadata: JSON.stringify(metadata),\n    };\n\n    const [createdTransaction] = await this.db\n      .insert(walletTransactions)\n      .values(transaction)\n      .returning();\n\n    // Update wallet balance\n    await this.db\n      .update(landlordWalletBalances)\n      .set({\n        availableBalance: balanceAfter.toFixed(2),\n        totalWithdrawn: newTotalWithdrawn.toFixed(2),\n        updatedAt: new Date(),\n      })\n      .where(eq(landlordWalletBalances.landlordId, landlordId));\n\n    this.logger.log(`âœ… Wallet debited: ${landlordId} - Balance: â‚¦${balanceAfter}`);\n\n    return createdTransaction;\n  }\n\n  /**\n   * GET WALLET BALANCE\n   * \n   * Returns current wallet balance for landlord.\n   */\n  async getBalance(landlordId: string) {\n    const wallet = await this.getOrCreateWallet(landlordId);\n\n    return {\n      availableBalance: parseFloat(wallet.availableBalance),\n      pendingBalance: parseFloat(wallet.pendingBalance),\n      totalEarned: parseFloat(wallet.totalEarned),\n      totalWithdrawn: parseFloat(wallet.totalWithdrawn),\n      currency: wallet.currency,\n    };\n  }\n\n  /**\n   * GET TRANSACTION HISTORY\n   * \n   * Returns wallet transaction history for landlord.\n   */\n  async getTransactions(\n    landlordId: string,\n    options?: {\n      limit?: number;\n      offset?: number;\n      type?: string;\n    }\n  ) {\n    const limit = options?.limit || 50;\n    const offset = options?.offset || 0;\n\n    let query = this.db\n      .select()\n      .from(walletTransactions)\n      .where(eq(walletTransactions.landlordId, landlordId))\n      .orderBy(desc(walletTransactions.createdAt))\n      .limit(limit)\n      .offset(offset);\n\n    const transactions = await query;\n\n    return transactions.map(t => ({\n      ...t,\n      amount: parseFloat(t.amount),\n      balanceBefore: parseFloat(t.balanceBefore),\n      balanceAfter: parseFloat(t.balanceAfter),\n      metadata: t.metadata ? JSON.parse(t.metadata) : null,\n    }));\n  }\n\n  /**\n   * GET TRANSACTION BY ID\n   * \n   * Returns specific transaction details.\n   */\n  async getTransaction(transactionId: string, landlordId: string) {\n    const [transaction] = await this.db\n      .select()\n      .from(walletTransactions)\n      .where(\n        and(\n          eq(walletTransactions.id, transactionId),\n          eq(walletTransactions.landlordId, landlordId)\n        )\n      )\n      .limit(1);\n\n    if (!transaction) {\n      throw new NotFoundException('Transaction not found');\n    }\n\n    return {\n      ...transaction,\n      amount: parseFloat(transaction.amount),\n      balanceBefore: parseFloat(transaction.balanceBefore),\n      balanceAfter: parseFloat(transaction.balanceAfter),\n      metadata: transaction.metadata ? JSON.parse(transaction.metadata) : null,\n    };\n  }\n}\n"],"names":["WalletService","getOrCreateWallet","landlordId","existing","db","select","from","landlordWalletBalances","where","eq","limit","newWallet","availableBalance","pendingBalance","totalEarned","totalWithdrawn","currency","created","insert","values","returning","logger","log","credit","amount","metadata","wallet","balanceBefore","parseFloat","balanceAfter","newTotalEarned","transaction","type","toFixed","reference","paymentId","status","description","JSON","stringify","createdTransaction","walletTransactions","update","set","updatedAt","Date","debit","BadRequestException","newTotalWithdrawn","getBalance","getTransactions","options","offset","query","orderBy","desc","createdAt","transactions","map","t","parse","getTransaction","transactionId","and","id","NotFoundException","Logger","name"],"mappings":";;;;+BAmBaA;;;eAAAA;;;wBAnBsE;4BAChD;4BACA;gCACC;wBAO7B;;;;;;;;;;;;;;;AASA,IAAA,AAAMA,gBAAN,MAAMA;IAQX;;;;GAIC,GACD,MAAMC,kBAAkBC,UAAkB,EAAE;QAC1C,6BAA6B;QAC7B,MAAM,CAACC,SAAS,GAAG,MAAM,IAAI,CAACC,EAAE,CAC7BC,MAAM,GACNC,IAAI,CAACC,8BAAsB,EAC3BC,KAAK,CAACC,IAAAA,cAAE,EAACF,8BAAsB,CAACL,UAAU,EAAEA,aAC5CQ,KAAK,CAAC;QAET,IAAIP,UAAU;YACZ,OAAOA;QACT;QAEA,oBAAoB;QACpB,MAAMQ,YAAsC;YAC1CT;YACAU,kBAAkB;YAClBC,gBAAgB;YAChBC,aAAa;YACbC,gBAAgB;YAChBC,UAAU;QACZ;QAEA,MAAM,CAACC,QAAQ,GAAG,MAAM,IAAI,CAACb,EAAE,CAC5Bc,MAAM,CAACX,8BAAsB,EAC7BY,MAAM,CAACR,WACPS,SAAS;QAEZ,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC,CAAC,kCAAkC,EAAEpB,YAAY;QACjE,OAAOe;IACT;IAEA;;;;;GAKC,GACD,MAAMM,OACJrB,UAAkB,EAClBsB,MAAc,EACdC,QAMC,EACD;QACA,IAAI,CAACJ,MAAM,CAACC,GAAG,CAAC,CAAC,qBAAqB,EAAEpB,WAAW,IAAI,EAAEsB,QAAQ;QAEjE,uBAAuB;QACvB,MAAME,SAAS,MAAM,IAAI,CAACzB,iBAAiB,CAACC;QAE5C,MAAMyB,gBAAgBC,WAAWF,OAAOd,gBAAgB;QACxD,MAAMiB,eAAeF,gBAAgBH;QACrC,MAAMM,iBAAiBF,WAAWF,OAAOZ,WAAW,IAAIU;QAExD,4BAA4B;QAC5B,MAAMO,cAAoC;YACxC7B;YACA8B,MAAM;YACNR,QAAQA,OAAOS,OAAO,CAAC;YACvBN,eAAeA,cAAcM,OAAO,CAAC;YACrCJ,cAAcA,aAAaI,OAAO,CAAC;YACnCC,WAAWT,SAASS,SAAS;YAC7BC,WAAWV,SAASU,SAAS;YAC7BC,QAAQ;YACRC,aAAaZ,SAASY,WAAW,IAAI,CAAC,YAAY,EAAEZ,SAASO,IAAI,EAAE;YACnEP,UAAUa,KAAKC,SAAS,CAACd;QAC3B;QAEA,MAAM,CAACe,mBAAmB,GAAG,MAAM,IAAI,CAACpC,EAAE,CACvCc,MAAM,CAACuB,0BAAkB,EACzBtB,MAAM,CAACY,aACPX,SAAS;QAEZ,wBAAwB;QACxB,MAAM,IAAI,CAAChB,EAAE,CACVsC,MAAM,CAACnC,8BAAsB,EAC7BoC,GAAG,CAAC;YACH/B,kBAAkBiB,aAAaI,OAAO,CAAC;YACvCnB,aAAagB,eAAeG,OAAO,CAAC;YACpCW,WAAW,IAAIC;QACjB,GACCrC,KAAK,CAACC,IAAAA,cAAE,EAACF,8BAAsB,CAACL,UAAU,EAAEA;QAE/C,IAAI,CAACmB,MAAM,CAACC,GAAG,CAAC,CAAC,mBAAmB,EAAEpB,WAAW,aAAa,EAAE2B,cAAc;QAE9E,OAAOW;IACT;IAEA;;;;;GAKC,GACD,MAAMM,MACJ5C,UAAkB,EAClBsB,MAAc,EACdC,QAIC,EACD;QACA,IAAI,CAACJ,MAAM,CAACC,GAAG,CAAC,CAAC,oBAAoB,EAAEpB,WAAW,IAAI,EAAEsB,QAAQ;QAEhE,aAAa;QACb,MAAME,SAAS,MAAM,IAAI,CAACzB,iBAAiB,CAACC;QAE5C,MAAMyB,gBAAgBC,WAAWF,OAAOd,gBAAgB;QAExD,2BAA2B;QAC3B,IAAIe,gBAAgBH,QAAQ;YAC1B,MAAM,IAAIuB,2BAAmB,CAC3B,CAAC,kCAAkC,EAAEpB,cAAc,aAAa,EAAEH,QAAQ;QAE9E;QAEA,MAAMK,eAAeF,gBAAgBH;QACrC,MAAMwB,oBAAoBpB,WAAWF,OAAOX,cAAc,IAAIS;QAE9D,4BAA4B;QAC5B,MAAMO,cAAoC;YACxC7B;YACA8B,MAAMP,SAASO,IAAI,KAAK,eAAe,eAAe;YACtDR,QAAQA,OAAOS,OAAO,CAAC;YACvBN,eAAeA,cAAcM,OAAO,CAAC;YACrCJ,cAAcA,aAAaI,OAAO,CAAC;YACnCC,WAAWT,SAASS,SAAS;YAC7BE,QAAQ;YACRC,aAAaZ,SAASY,WAAW,IAAI,CAAC,UAAU,EAAEZ,SAASO,IAAI,EAAE;YACjEP,UAAUa,KAAKC,SAAS,CAACd;QAC3B;QAEA,MAAM,CAACe,mBAAmB,GAAG,MAAM,IAAI,CAACpC,EAAE,CACvCc,MAAM,CAACuB,0BAAkB,EACzBtB,MAAM,CAACY,aACPX,SAAS;QAEZ,wBAAwB;QACxB,MAAM,IAAI,CAAChB,EAAE,CACVsC,MAAM,CAACnC,8BAAsB,EAC7BoC,GAAG,CAAC;YACH/B,kBAAkBiB,aAAaI,OAAO,CAAC;YACvClB,gBAAgBiC,kBAAkBf,OAAO,CAAC;YAC1CW,WAAW,IAAIC;QACjB,GACCrC,KAAK,CAACC,IAAAA,cAAE,EAACF,8BAAsB,CAACL,UAAU,EAAEA;QAE/C,IAAI,CAACmB,MAAM,CAACC,GAAG,CAAC,CAAC,kBAAkB,EAAEpB,WAAW,aAAa,EAAE2B,cAAc;QAE7E,OAAOW;IACT;IAEA;;;;GAIC,GACD,MAAMS,WAAW/C,UAAkB,EAAE;QACnC,MAAMwB,SAAS,MAAM,IAAI,CAACzB,iBAAiB,CAACC;QAE5C,OAAO;YACLU,kBAAkBgB,WAAWF,OAAOd,gBAAgB;YACpDC,gBAAgBe,WAAWF,OAAOb,cAAc;YAChDC,aAAac,WAAWF,OAAOZ,WAAW;YAC1CC,gBAAgBa,WAAWF,OAAOX,cAAc;YAChDC,UAAUU,OAAOV,QAAQ;QAC3B;IACF;IAEA;;;;GAIC,GACD,MAAMkC,gBACJhD,UAAkB,EAClBiD,OAIC,EACD;QACA,MAAMzC,QAAQyC,SAASzC,SAAS;QAChC,MAAM0C,SAASD,SAASC,UAAU;QAElC,IAAIC,QAAQ,IAAI,CAACjD,EAAE,CAChBC,MAAM,GACNC,IAAI,CAACmC,0BAAkB,EACvBjC,KAAK,CAACC,IAAAA,cAAE,EAACgC,0BAAkB,CAACvC,UAAU,EAAEA,aACxCoD,OAAO,CAACC,IAAAA,gBAAI,EAACd,0BAAkB,CAACe,SAAS,GACzC9C,KAAK,CAACA,OACN0C,MAAM,CAACA;QAEV,MAAMK,eAAe,MAAMJ;QAE3B,OAAOI,aAAaC,GAAG,CAACC,CAAAA,IAAM,CAAA;gBAC5B,GAAGA,CAAC;gBACJnC,QAAQI,WAAW+B,EAAEnC,MAAM;gBAC3BG,eAAeC,WAAW+B,EAAEhC,aAAa;gBACzCE,cAAcD,WAAW+B,EAAE9B,YAAY;gBACvCJ,UAAUkC,EAAElC,QAAQ,GAAGa,KAAKsB,KAAK,CAACD,EAAElC,QAAQ,IAAI;YAClD,CAAA;IACF;IAEA;;;;GAIC,GACD,MAAMoC,eAAeC,aAAqB,EAAE5D,UAAkB,EAAE;QAC9D,MAAM,CAAC6B,YAAY,GAAG,MAAM,IAAI,CAAC3B,EAAE,CAChCC,MAAM,GACNC,IAAI,CAACmC,0BAAkB,EACvBjC,KAAK,CACJuD,IAAAA,eAAG,EACDtD,IAAAA,cAAE,EAACgC,0BAAkB,CAACuB,EAAE,EAAEF,gBAC1BrD,IAAAA,cAAE,EAACgC,0BAAkB,CAACvC,UAAU,EAAEA,cAGrCQ,KAAK,CAAC;QAET,IAAI,CAACqB,aAAa;YAChB,MAAM,IAAIkC,yBAAiB,CAAC;QAC9B;QAEA,OAAO;YACL,GAAGlC,WAAW;YACdP,QAAQI,WAAWG,YAAYP,MAAM;YACrCG,eAAeC,WAAWG,YAAYJ,aAAa;YACnDE,cAAcD,WAAWG,YAAYF,YAAY;YACjDJ,UAAUM,YAAYN,QAAQ,GAAGa,KAAKsB,KAAK,CAAC7B,YAAYN,QAAQ,IAAI;QACtE;IACF;IAtPA,YACE,AACiBrB,EAAqC,CACtD;aADiBA,KAAAA;aAJFiB,SAAS,IAAI6C,cAAM,CAAClE,cAAcmE,IAAI;IAKpD;AAoPL"}