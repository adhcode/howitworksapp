{"version":3,"sources":["../../../src/core/contracts/contracts.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Get,\n  Put,\n  Delete,\n  Body,\n  Param,\n  Query,\n  UseGuards,\n  Request,\n  HttpStatus,\n  HttpException,\n  ParseUUIDPipe,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBearerAuth,\n  ApiParam,\n} from '@nestjs/swagger';\nimport { ContractsService } from './contracts.service';\nimport { JwtAuthGuard } from '../../auth/guards/jwt-auth.guard';\nimport { RolesGuard } from '../../auth/guards/roles.guard';\nimport { Roles } from '../../auth/decorators/roles.decorator';\nimport {\n  CreateNewTenantContractDto,\n  CreateExistingTenantContractDto,\n  UpdateContractDto,\n  ContractQueryDto,\n  ContractResponseDto,\n} from './dto/create-contract.dto';\n\nenum UserRole {\n  ADMIN = 'admin',\n  LANDLORD = 'landlord',\n  TENANT = 'tenant',\n  FACILITATOR = 'facilitator',\n}\n\n/**\n * CONTRACTS CONTROLLER\n * \n * RESTful API endpoints for contract management.\n * \n * Endpoints:\n * - POST /contracts/new - Create contract for new tenant\n * - POST /contracts/existing - Create contract for existing tenant\n * - GET /contracts - Query contracts\n * - GET /contracts/:id - Get specific contract\n * - PUT /contracts/:id - Update contract\n * - DELETE /contracts/:id - Terminate contract\n */\n@ApiTags('contracts')\n@Controller('contracts')\n@UseGuards(JwtAuthGuard, RolesGuard)\n@ApiBearerAuth()\nexport class ContractsController {\n  constructor(private readonly contractsService: ContractsService) {}\n\n  /**\n   * CREATE CONTRACT FOR NEW TENANT\n   * \n   * Endpoint: POST /contracts/new\n   * \n   * Creates a fresh lease contract for a tenant just moving in.\n   * Payment starts on lease start date.\n   * \n   * Access: Landlords and Admins only\n   */\n  @Post('new')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Create contract for new tenant',\n    description: 'Creates a rental contract for a tenant starting a fresh lease. Payment starts on move-in date.',\n  })\n  @ApiResponse({\n    status: HttpStatus.CREATED,\n    description: 'Contract created successfully',\n    type: ContractResponseDto,\n  })\n  @ApiResponse({\n    status: HttpStatus.BAD_REQUEST,\n    description: 'Invalid data or duplicate contract',\n  })\n  @ApiResponse({\n    status: HttpStatus.FORBIDDEN,\n    description: 'Only landlords and admins can create contracts',\n  })\n  async createNewTenantContract(\n    @Body() dto: CreateNewTenantContractDto,\n    @Request() req: any\n  ) {\n    try {\n      // Verify landlord ID matches authenticated user (unless admin)\n      if (req.user.role !== UserRole.ADMIN && dto.landlordId !== req.user.id) {\n        throw new HttpException(\n          'You can only create contracts for your own properties',\n          HttpStatus.FORBIDDEN\n        );\n      }\n\n      const contract = await this.contractsService.createNewTenantContract(dto);\n\n      return {\n        success: true,\n        message: 'Contract created successfully for new tenant',\n        data: contract,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to create contract',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * CREATE CONTRACT FOR EXISTING TENANT\n   * \n   * Endpoint: POST /contracts/existing\n   * \n   * Creates a contract for a tenant who already has an active lease elsewhere.\n   * System calculates when they should start paying based on:\n   * - Monthly payout: 3 months before current lease expires\n   * - Yearly payout: 6 months before current lease expires\n   * \n   * Access: Landlords and Admins only\n   */\n  @Post('existing')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Create contract for existing tenant',\n    description: 'Creates a contract for tenant with active lease elsewhere. Payment transition calculated automatically.',\n  })\n  @ApiResponse({\n    status: HttpStatus.CREATED,\n    description: 'Contract created successfully',\n    type: ContractResponseDto,\n  })\n  @ApiResponse({\n    status: HttpStatus.BAD_REQUEST,\n    description: 'Invalid data or duplicate contract',\n  })\n  @ApiResponse({\n    status: HttpStatus.FORBIDDEN,\n    description: 'Only landlords and admins can create contracts',\n  })\n  async createExistingTenantContract(\n    @Body() dto: CreateExistingTenantContractDto,\n    @Request() req: any\n  ) {\n    try {\n      // Verify landlord ID matches authenticated user (unless admin)\n      if (req.user.role !== UserRole.ADMIN && dto.landlordId !== req.user.id) {\n        throw new HttpException(\n          'You can only create contracts for your own properties',\n          HttpStatus.FORBIDDEN\n        );\n      }\n\n      const contract = await this.contractsService.createExistingTenantContract(dto);\n\n      return {\n        success: true,\n        message: 'Contract created successfully for existing tenant',\n        data: contract,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to create contract',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET CONTRACTS\n   * \n   * Endpoint: GET /contracts?tenantId=xxx&landlordId=xxx&status=active\n   * \n   * Query contracts with filters.\n   * Users can only see their own contracts (unless admin).\n   * \n   * Access: All authenticated users\n   */\n  @Get()\n  @Roles(UserRole.ADMIN, UserRole.LANDLORD, UserRole.TENANT, UserRole.FACILITATOR)\n  @ApiOperation({\n    summary: 'Query contracts',\n    description: 'Get contracts with optional filters. Users see only their own contracts.',\n  })\n  @ApiResponse({\n    status: HttpStatus.OK,\n    description: 'Contracts retrieved successfully',\n    type: [ContractResponseDto],\n  })\n  async getContracts(\n    @Query() query: ContractQueryDto,\n    @Request() req: any\n  ) {\n    try {\n      // Enforce access control based on role\n      if (req.user.role === UserRole.TENANT) {\n        query.tenantId = req.user.id; // Tenants can only see their own contracts\n      } else if (req.user.role === UserRole.LANDLORD) {\n        query.landlordId = req.user.id; // Landlords can only see their properties' contracts\n      }\n      // Admins can see all contracts (no restriction)\n\n      const contracts = await this.contractsService.getContracts(query);\n\n      return {\n        success: true,\n        data: contracts,\n        count: contracts.length,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch contracts',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * GET CONTRACT BY ID\n   * \n   * Endpoint: GET /contracts/:id\n   * \n   * Get specific contract details.\n   * Users can only access their own contracts (unless admin).\n   * \n   * Access: All authenticated users\n   */\n  @Get(':id')\n  @Roles(UserRole.ADMIN, UserRole.LANDLORD, UserRole.TENANT, UserRole.FACILITATOR)\n  @ApiOperation({\n    summary: 'Get contract by ID',\n    description: 'Retrieve specific contract details',\n  })\n  @ApiParam({ name: 'id', description: 'Contract ID' })\n  @ApiResponse({\n    status: HttpStatus.OK,\n    description: 'Contract retrieved successfully',\n    type: ContractResponseDto,\n  })\n  @ApiResponse({\n    status: HttpStatus.NOT_FOUND,\n    description: 'Contract not found',\n  })\n  @ApiResponse({\n    status: HttpStatus.FORBIDDEN,\n    description: 'Access denied',\n  })\n  async getContractById(\n    @Param('id', ParseUUIDPipe) id: string,\n    @Request() req: any\n  ) {\n    try {\n      const contract = await this.contractsService.getContractById(id);\n\n      // Check access permissions\n      const hasAccess =\n        req.user.role === UserRole.ADMIN ||\n        contract.tenantId === req.user.id ||\n        contract.landlordId === req.user.id;\n\n      if (!hasAccess) {\n        throw new HttpException(\n          'You do not have permission to view this contract',\n          HttpStatus.FORBIDDEN\n        );\n      }\n\n      return {\n        success: true,\n        data: contract,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to fetch contract',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * UPDATE CONTRACT\n   * \n   * Endpoint: PUT /contracts/:id\n   * \n   * Update contract details (rent amount, end date, payout type).\n   * \n   * Access: Landlords (own properties) and Admins only\n   */\n  @Put(':id')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Update contract',\n    description: 'Update contract details like rent amount, end date, or payout type',\n  })\n  @ApiParam({ name: 'id', description: 'Contract ID' })\n  @ApiResponse({\n    status: HttpStatus.OK,\n    description: 'Contract updated successfully',\n    type: ContractResponseDto,\n  })\n  @ApiResponse({\n    status: HttpStatus.NOT_FOUND,\n    description: 'Contract not found',\n  })\n  @ApiResponse({\n    status: HttpStatus.FORBIDDEN,\n    description: 'Access denied',\n  })\n  async updateContract(\n    @Param('id', ParseUUIDPipe) id: string,\n    @Body() dto: UpdateContractDto,\n    @Request() req: any\n  ) {\n    try {\n      const contract = await this.contractsService.getContractById(id);\n\n      // Check access permissions\n      if (req.user.role !== UserRole.ADMIN && contract.landlordId !== req.user.id) {\n        throw new HttpException(\n          'You can only update contracts for your own properties',\n          HttpStatus.FORBIDDEN\n        );\n      }\n\n      const updated = await this.contractsService.updateContract(id, dto);\n\n      return {\n        success: true,\n        message: 'Contract updated successfully',\n        data: updated,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to update contract',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * TERMINATE CONTRACT\n   * \n   * Endpoint: DELETE /contracts/:id\n   * \n   * Terminate a contract early.\n   * Sets status to 'terminated'.\n   * \n   * Access: Landlords (own properties) and Admins only\n   */\n  @Delete(':id')\n  @Roles(UserRole.LANDLORD, UserRole.ADMIN)\n  @ApiOperation({\n    summary: 'Terminate contract',\n    description: 'Terminate a contract early',\n  })\n  @ApiParam({ name: 'id', description: 'Contract ID' })\n  @ApiResponse({\n    status: HttpStatus.OK,\n    description: 'Contract terminated successfully',\n  })\n  @ApiResponse({\n    status: HttpStatus.NOT_FOUND,\n    description: 'Contract not found',\n  })\n  @ApiResponse({\n    status: HttpStatus.FORBIDDEN,\n    description: 'Access denied',\n  })\n  async terminateContract(\n    @Param('id', ParseUUIDPipe) id: string,\n    @Request() req: any\n  ) {\n    try {\n      const contract = await this.contractsService.getContractById(id);\n\n      // Check access permissions\n      if (req.user.role !== UserRole.ADMIN && contract.landlordId !== req.user.id) {\n        throw new HttpException(\n          'You can only terminate contracts for your own properties',\n          HttpStatus.FORBIDDEN\n        );\n      }\n\n      const terminated = await this.contractsService.terminateContract(id);\n\n      return {\n        success: true,\n        message: 'Contract terminated successfully',\n        data: terminated,\n      };\n    } catch (error) {\n      throw new HttpException(\n        error.message || 'Failed to terminate contract',\n        error.status || HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n}\n\n\n\n"],"names":["ContractsController","UserRole","createNewTenantContract","dto","req","user","role","landlordId","id","HttpException","HttpStatus","FORBIDDEN","contract","contractsService","success","message","data","error","status","BAD_REQUEST","createExistingTenantContract","getContracts","query","tenantId","contracts","count","length","getContractById","hasAccess","updateContract","updated","terminateContract","terminated","summary","description","CREATED","type","ContractResponseDto","OK","name","NOT_FOUND"],"mappings":"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"}