{"version":3,"sources":["../../../src/core/escrow/escrow.service.ts"],"sourcesContent":["import { Injectable, Inject, Logger } from '@nestjs/common';\nimport { Cron, CronExpression } from '@nestjs/schedule';\nimport { PostgresJsDatabase } from 'drizzle-orm/postgres-js';\nimport { eq, and, lte, sql } from 'drizzle-orm';\nimport { DATABASE_CONNECTION } from '../../database/database.module';\nimport * as schema from '../../database/schema';\nimport { \n  landlordEscrowBalances,\n  tenantRentContracts,\n} from '../../database/schema/tenant-rent-contracts';\nimport { BUSINESS_RULES } from '../../shared/constants/business-rules.constant';\nimport { startOfDay, addDays, isBefore } from '../../shared/utils/date.utils';\n\n/**\n * ESCROW MANAGEMENT SERVICE\n * \n * Manages escrow accounts for landlords with yearly payout preferences.\n * \n * Flow:\n * 1. Tenant pays rent monthly\n * 2. Money accumulates in escrow\n * 3. After 12 months OR when contract expires, money is released to landlord\n * 4. Cron job runs daily to check for escrow ready to release\n * \n * Key responsibilities:\n * 1. Check escrow balances ready for release\n * 2. Release escrow to landlord wallet\n * 3. Track escrow accumulation and release history\n * 4. Handle contract expiry triggers\n */\n@Injectable()\nexport class EscrowService {\n  private readonly logger = new Logger(EscrowService.name);\n\n  constructor(\n    @Inject(DATABASE_CONNECTION)\n    private readonly db: PostgresJsDatabase<typeof schema>,\n  ) {}\n\n  /**\n   * DAILY CRON JOB: CHECK AND RELEASE ESCROW\n   * \n   * Runs daily at 2:00 AM to check for escrow balances ready to release.\n   * \n   * Release conditions:\n   * 1. 12 months have accumulated, OR\n   * 2. Contract has expired (+ grace period)\n   * \n   * Steps:\n   * 1. Find all unreleased escrow balances\n   * 2. Check if ready for release\n   * 3. Release to landlord wallet\n   * 4. Mark as released\n   * 5. Send notification to landlord\n   */\n  @Cron('0 2 * * *')\n  async checkAndReleaseEscrow(): Promise<void> {\n    this.logger.log('üè¶ Starting escrow release check...');\n\n    try {\n      const today = startOfDay(new Date());\n\n      // Get all unreleased escrow balances\n      const unreleasedEscrow = await this.db\n        .select()\n        .from(landlordEscrowBalances)\n        .where(eq(landlordEscrowBalances.isReleased, false));\n\n      this.logger.log(`Found ${unreleasedEscrow.length} unreleased escrow accounts`);\n\n      let releasedCount = 0;\n\n      for (const escrow of unreleasedEscrow) {\n        // Check if ready for release\n        const readyForRelease = await this.isReadyForRelease(escrow, today);\n\n        if (readyForRelease) {\n          await this.releaseEscrow(escrow.id);\n          releasedCount++;\n        }\n      }\n\n      this.logger.log(`‚úÖ Escrow release check completed. Released: ${releasedCount}`);\n    } catch (error) {\n      this.logger.error(`‚ùå Error during escrow release check: ${error.message}`, error.stack);\n    }\n  }\n\n  /**\n   * CHECK IF ESCROW IS READY FOR RELEASE\n   * \n   * Release conditions:\n   * 1. Has accumulated for 12+ months, OR\n   * 2. Related contract has expired (with grace period)\n   * \n   * @param escrow - Escrow balance record\n   * @param today - Current date\n   * @returns True if ready to release\n   */\n  private async isReadyForRelease(\n    escrow: typeof landlordEscrowBalances.$inferSelect,\n    today: Date\n  ): Promise<boolean> {\n    // Condition 1: 12 months accumulated\n    if (escrow.monthsAccumulated >= BUSINESS_RULES.ESCROW.AUTO_RELEASE_MONTHS) {\n      this.logger.log(`Escrow ${escrow.id}: Ready (12 months accumulated)`);\n      return true;\n    }\n\n    // Condition 2: Contract expired\n    if (BUSINESS_RULES.ESCROW.RELEASE_ON_CONTRACT_EXPIRY) {\n      const [contract] = await this.db\n        .select()\n        .from(tenantRentContracts)\n        .where(eq(tenantRentContracts.id, escrow.contractId))\n        .limit(1);\n\n      if (contract) {\n        const contractExpiry = new Date(contract.expiryDate);\n        const releaseDate = addDays(contractExpiry, BUSINESS_RULES.ESCROW.GRACE_DAYS_AFTER_EXPIRY);\n\n        if (isBefore(releaseDate, today) || releaseDate.getTime() === today.getTime()) {\n          this.logger.log(`Escrow ${escrow.id}: Ready (contract expired + grace period)`);\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * RELEASE ESCROW TO LANDLORD\n   * \n   * Transfers accumulated escrow balance to landlord's wallet.\n   * \n   * TODO: Integrate with wallet system\n   * For now, logs the transaction.\n   * \n   * @param escrowId - Escrow balance ID\n   */\n  async releaseEscrow(escrowId: string): Promise<void> {\n    const [escrow] = await this.db\n      .select()\n      .from(landlordEscrowBalances)\n      .where(eq(landlordEscrowBalances.id, escrowId))\n      .limit(1);\n\n    if (!escrow || escrow.isReleased) {\n      this.logger.warn(`Escrow ${escrowId} not found or already released`);\n      return;\n    }\n\n    const amount = parseFloat(escrow.totalEscrowed);\n\n    this.logger.log(`üí∞ Releasing escrow ${escrowId}: $${amount} to landlord ${escrow.landlordId}`);\n\n    try {\n      // TODO: Integrate with wallet system\n      // await this.walletService.credit(escrow.landlordId, amount, {\n      //   type: 'escrow_release',\n      //   escrowId,\n      //   contractId: escrow.contractId,\n      //   monthsAccumulated: escrow.monthsAccumulated,\n      // });\n\n      // Mark as released\n      await this.db\n        .update(landlordEscrowBalances)\n        .set({\n          isReleased: true,\n          releasedAt: new Date(),\n          releasedAmount: amount.toFixed(2),\n          updatedAt: new Date(),\n        })\n        .where(eq(landlordEscrowBalances.id, escrowId));\n\n      this.logger.log(`‚úÖ Escrow released successfully: ${escrowId}`);\n\n      // TODO: Send notification to landlord\n      // await this.notificationService.sendEscrowReleaseNotification(\n      //   escrow.landlordId,\n      //   amount,\n      //   escrow.monthsAccumulated\n      // );\n    } catch (error) {\n      this.logger.error(`‚ùå Failed to release escrow ${escrowId}: ${error.message}`, error.stack);\n      throw error;\n    }\n  }\n\n  /**\n   * GET ESCROW BALANCE FOR LANDLORD\n   * \n   * Returns all escrow balances (released and unreleased) for a landlord.\n   * \n   * @param landlordId - Landlord ID\n   * @returns Escrow balances\n   */\n  async getEscrowBalances(landlordId: string): Promise<any[]> {\n    return this.db\n      .select()\n      .from(landlordEscrowBalances)\n      .where(eq(landlordEscrowBalances.landlordId, landlordId))\n      .orderBy(sql`${landlordEscrowBalances.createdAt} DESC`);\n  }\n\n  /**\n   * GET UNRELEASED ESCROW TOTAL FOR LANDLORD\n   * \n   * Calculates total amount in escrow (not yet released).\n   * \n   * @param landlordId - Landlord ID\n   * @returns Total unreleased amount\n   */\n  async getUnreleasedTotal(landlordId: string): Promise<number> {\n    const unreleased = await this.db\n      .select()\n      .from(landlordEscrowBalances)\n      .where(\n        and(\n          eq(landlordEscrowBalances.landlordId, landlordId),\n          eq(landlordEscrowBalances.isReleased, false)\n        )\n      );\n\n    return unreleased.reduce((total, escrow) => {\n      return total + parseFloat(escrow.totalEscrowed);\n    }, 0);\n  }\n\n  /**\n   * GET ESCROW DETAILS BY CONTRACT\n   * \n   * Returns escrow details for a specific contract.\n   * \n   * @param contractId - Contract ID\n   * @returns Escrow balance or null\n   */\n  async getEscrowByContract(contractId: string): Promise<any | null> {\n    const [escrow] = await this.db\n      .select()\n      .from(landlordEscrowBalances)\n      .where(\n        and(\n          eq(landlordEscrowBalances.contractId, contractId),\n          eq(landlordEscrowBalances.isReleased, false)\n        )\n      )\n      .limit(1);\n\n    return escrow || null;\n  }\n}\n\n"],"names":["EscrowService","checkAndReleaseEscrow","logger","log","today","startOfDay","Date","unreleasedEscrow","db","select","from","landlordEscrowBalances","where","eq","isReleased","length","releasedCount","escrow","readyForRelease","isReadyForRelease","releaseEscrow","id","error","message","stack","monthsAccumulated","BUSINESS_RULES","ESCROW","AUTO_RELEASE_MONTHS","RELEASE_ON_CONTRACT_EXPIRY","contract","tenantRentContracts","contractId","limit","contractExpiry","expiryDate","releaseDate","addDays","GRACE_DAYS_AFTER_EXPIRY","isBefore","getTime","escrowId","warn","amount","parseFloat","totalEscrowed","landlordId","update","set","releasedAt","releasedAmount","toFixed","updatedAt","getEscrowBalances","orderBy","sql","createdAt","getUnreleasedTotal","unreleased","and","reduce","total","getEscrowByContract","Logger","name"],"mappings":"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"}