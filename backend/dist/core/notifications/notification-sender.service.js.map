{"version":3,"sources":["../../../src/core/notifications/notification-sender.service.ts"],"sourcesContent":["import { Injectable, Logger, Inject, forwardRef } from '@nestjs/common';\nimport { EmailService } from '../../email/email.service';\nimport { BUSINESS_RULES } from '../../shared/constants/business-rules.constant';\nimport { NotificationsService } from '../../notifications/notifications.service';\nimport {\n  SendNotificationPayload,\n  PushNotificationResult,\n  EmailNotificationResult,\n  SMSNotificationResult,\n  NotificationType,\n} from './dto/notification.dto';\n\n/**\n * NOTIFICATION SENDER SERVICE\n * \n * Handles sending notifications through multiple channels:\n * 1. Push notifications (Expo) - Primary channel\n * 2. Email - Secondary channel\n * 3. SMS - Critical alerts only (overdue payments)\n * \n * Key responsibilities:\n * 1. Send push notifications to mobile app\n * 2. Send email notifications\n * 3. Send SMS for critical alerts\n * 4. Handle notification failures and retries\n * 5. Track delivery status\n */\n@Injectable()\nexport class NotificationSenderService {\n  private readonly logger = new Logger(NotificationSenderService.name);\n\n  constructor(\n    private readonly emailService: EmailService,\n    @Inject(forwardRef(() => NotificationsService))\n    private readonly notificationsService: NotificationsService,\n  ) {}\n\n  /**\n   * SEND MULTI-CHANNEL NOTIFICATION\n   * \n   * Sends notification through all enabled channels based on business rules.\n   * \n   * Channel priority:\n   * 1. Push (if user has push token)\n   * 2. Email (always)\n   * 3. SMS (overdue only)\n   * \n   * @param payload - Notification details\n   * @param userEmail - User's email\n   * @param userPhone - User's phone (optional, for SMS)\n   * @param pushToken - User's Expo push token (optional, for push notifications)\n   */\n  async sendMultiChannelNotification(\n    payload: SendNotificationPayload,\n    userEmail: string,\n    userPhone?: string,\n    pushToken?: string\n  ): Promise<void> {\n    this.logger.log(`üì¨ Sending ${payload.type} notification to user ${payload.userId}`);\n\n    const results = {\n      push: null as PushNotificationResult | null,\n      email: null as EmailNotificationResult | null,\n      sms: null as SMSNotificationResult | null,\n    };\n\n    // 1. Push Notification (if enabled and user has token)\n    if (BUSINESS_RULES.NOTIFICATION_CHANNELS.PUSH.enabled && pushToken) {\n      results.push = await this.sendPushNotification(pushToken, payload);\n      \n      if (results.push.success) {\n        this.logger.log(`‚úÖ Push notification sent`);\n      } else {\n        this.logger.warn(`‚ö†Ô∏è Push notification failed: ${results.push.error}`);\n      }\n    }\n\n    // 2. Email Notification (always send)\n    if (BUSINESS_RULES.NOTIFICATION_CHANNELS.EMAIL.enabled) {\n      // Extract first name from payload data if available\n      const firstName = payload.data?.firstName || 'User';\n      results.email = await this.sendEmailNotification(userEmail, payload, firstName);\n      \n      if (results.email.success) {\n        this.logger.log(`‚úÖ Email notification sent`);\n      } else {\n        this.logger.warn(`‚ö†Ô∏è Email notification failed: ${results.email.error}`);\n      }\n    }\n\n    // 3. SMS Notification (overdue only)\n    const isOverdueNotification = payload.type === NotificationType.PAYMENT_OVERDUE;\n    \n    if (\n      BUSINESS_RULES.NOTIFICATION_CHANNELS.SMS.enabled &&\n      BUSINESS_RULES.NOTIFICATION_CHANNELS.SMS.overdueOnly &&\n      isOverdueNotification &&\n      userPhone\n    ) {\n      results.sms = await this.sendSMSNotification(userPhone, payload);\n      \n      if (results.sms.success) {\n        this.logger.log(`‚úÖ SMS notification sent`);\n      } else {\n        this.logger.warn(`‚ö†Ô∏è SMS notification failed: ${results.sms.error}`);\n      }\n    }\n\n    // Log summary\n    const successCount = Object.values(results).filter(r => r?.success).length;\n    const attemptCount = Object.values(results).filter(r => r !== null).length;\n    \n    this.logger.log(`üìä Notification summary: ${successCount}/${attemptCount} channels succeeded`);\n  }\n\n  /**\n   * SEND PUSH NOTIFICATION\n   * \n   * Sends push notification via Expo Push Notification service.\n   * \n   * @param pushToken - Expo push token\n   * @param payload - Notification payload\n   * @returns Result with receipt ID or error\n   */\n  async sendPushNotification(\n    pushToken: string,\n    payload: SendNotificationPayload\n  ): Promise<PushNotificationResult> {\n    try {\n      this.logger.log(`üì± Sending push notification to token: ${pushToken.substring(0, 20)}...`);\n\n      // Use the integrated NotificationsService for Expo push notifications\n      await this.notificationsService.sendPushNotificationToToken(\n        pushToken,\n        payload.title,\n        payload.message,\n        payload.data\n      );\n      \n      const receiptId = `push_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n      \n      this.logger.log(`üì± Push notification sent. Receipt: ${receiptId}`);\n      \n      return {\n        success: true,\n        receiptId,\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Push notification failed: ${error.message}`, error.stack);\n      \n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * SEND EMAIL NOTIFICATION\n   * \n   * Sends email notification via email service.\n   * \n   * @param email - User's email address\n   * @param payload - Notification payload\n   * @param firstName - User's first name\n   * @returns Result with message ID or error\n   */\n  async sendEmailNotification(\n    email: string,\n    payload: SendNotificationPayload,\n    firstName: string = 'User'\n  ): Promise<EmailNotificationResult> {\n    try {\n      this.logger.log(`üìß Sending email to: ${email}`);\n\n      // Use payment reminder email method for payment notifications\n      await this.emailService.sendPaymentReminderEmail(\n        email,\n        firstName,\n        payload.title,\n        payload.message,\n        payload.data?.amount,\n        payload.data?.dueDate\n      );\n\n      this.logger.log(`üìß Email sent successfully to ${email}`);\n\n      return {\n        success: true,\n        messageId: `email_${Date.now()}`,\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå Email notification failed: ${error.message}`, error.stack);\n\n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * SEND SMS NOTIFICATION\n   * \n   * Sends SMS notification for critical alerts (overdue payments).\n   * \n   * @param phone - User's phone number\n   * @param payload - Notification payload\n   * @returns Result with message ID or error\n   */\n  async sendSMSNotification(\n    phone: string,\n    payload: SendNotificationPayload\n  ): Promise<SMSNotificationResult> {\n    try {\n      this.logger.log(`üì± Sending SMS to: ${phone}`);\n\n      // TODO: Integrate with SMS provider (Twilio, AWS SNS, etc.)\n      // const client = new Twilio(accountSid, authToken);\n      // const message = await client.messages.create({\n      //   body: `${payload.title}\\n\\n${payload.message}`,\n      //   to: phone,\n      //   from: process.env.TWILIO_PHONE_NUMBER,\n      // });\n      //\n      // return {\n      //   success: true,\n      //   messageId: message.sid,\n      // };\n\n      // Mock implementation for development\n      const mockMessageId = `sms_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n      \n      this.logger.log(`üì± [MOCK] SMS sent. Message ID: ${mockMessageId}`);\n      this.logger.log(`   To: ${phone}`);\n      this.logger.log(`   Content: ${payload.title}\\n   ${payload.message}`);\n\n      return {\n        success: true,\n        messageId: mockMessageId,\n      };\n    } catch (error) {\n      this.logger.error(`‚ùå SMS notification failed: ${error.message}`, error.stack);\n\n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * FORMAT EMAIL HTML\n   * \n   * Creates formatted HTML email body.\n   * \n   * @param payload - Notification payload\n   * @returns HTML string\n   */\n  private formatEmailHTML(payload: SendNotificationPayload): string {\n    let urgencyColor = '#3498db'; // Blue for info\n    \n    if (payload.type === NotificationType.PAYMENT_OVERDUE) {\n      urgencyColor = '#e74c3c'; // Red for overdue\n    } else if (payload.type === NotificationType.PAYMENT_REMINDER) {\n      urgencyColor = '#f39c12'; // Orange for reminder\n    } else if (payload.type === NotificationType.PAYMENT_SUCCESS) {\n      urgencyColor = '#27ae60'; // Green for success\n    }\n\n    return `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <style>\n            body {\n              font-family: Arial, sans-serif;\n              line-height: 1.6;\n              color: #333;\n            }\n            .container {\n              max-width: 600px;\n              margin: 0 auto;\n              padding: 20px;\n            }\n            .header {\n              background-color: ${urgencyColor};\n              color: white;\n              padding: 20px;\n              text-align: center;\n              border-radius: 5px 5px 0 0;\n            }\n            .content {\n              background-color: #f9f9f9;\n              padding: 30px;\n              border-radius: 0 0 5px 5px;\n            }\n            .footer {\n              margin-top: 20px;\n              padding-top: 20px;\n              border-top: 1px solid #ddd;\n              font-size: 12px;\n              color: #666;\n              text-align: center;\n            }\n            .button {\n              display: inline-block;\n              padding: 12px 24px;\n              background-color: ${urgencyColor};\n              color: white;\n              text-decoration: none;\n              border-radius: 5px;\n              margin-top: 15px;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h2>${payload.title}</h2>\n            </div>\n            <div class=\"content\">\n              <p>${payload.message}</p>\n              ${payload.data?.amount ? `<p><strong>Amount: $${payload.data.amount}</strong></p>` : ''}\n              ${payload.data?.dueDate ? `<p><strong>Due Date: ${new Date(payload.data.dueDate).toLocaleDateString()}</strong></p>` : ''}\n              <a href=\"${process.env.MOBILE_APP_DEEP_LINK || '#'}\" class=\"button\">Open Property HomeCare App</a>\n            </div>\n            <div class=\"footer\">\n              <p>This is an automated message from Property HomeCare</p>\n              <p>¬© ${new Date().getFullYear()} Property HomeCare. All rights reserved.</p>\n            </div>\n          </div>\n        </body>\n      </html>\n    `;\n  }\n\n  /**\n   * SEND PAYMENT REMINDER\n   * \n   * Convenience method for sending payment reminders.\n   * \n   * @param userId - Tenant user ID\n   * @param userEmail - Tenant email\n   * @param amount - Payment amount\n   * @param dueDate - Payment due date\n   * @param daysUntilDue - Days until payment is due\n   * @param userPhone - Tenant phone (optional)\n   * @param pushToken - Expo push token (optional)\n   */\n  async sendPaymentReminder(\n    userId: string,\n    userEmail: string,\n    amount: number,\n    dueDate: Date,\n    daysUntilDue: number,\n    userPhone?: string,\n    pushToken?: string\n  ): Promise<void> {\n    let type: NotificationType;\n    let title: string;\n    let message: string;\n\n    if (daysUntilDue < 0) {\n      // Overdue\n      const daysOverdue = Math.abs(daysUntilDue);\n      type = NotificationType.PAYMENT_OVERDUE;\n      title = `Rent Payment Overdue - ${daysOverdue} Day${daysOverdue > 1 ? 's' : ''}`;\n      message = `Your rent payment of $${amount} was due ${daysOverdue} day${daysOverdue > 1 ? 's' : ''} ago. Please make payment immediately to avoid penalties.`;\n    } else if (daysUntilDue === 0) {\n      // Due today\n      type = NotificationType.PAYMENT_REMINDER;\n      title = 'Rent Payment Due Today';\n      message = `Your rent payment of $${amount} is due today. Please make payment before the end of the day.`;\n    } else {\n      // Upcoming\n      type = NotificationType.PAYMENT_REMINDER;\n      title = `Rent Payment Reminder - Due in ${daysUntilDue} Day${daysUntilDue > 1 ? 's' : ''}`;\n      message = `Friendly reminder: Your rent payment of $${amount} is due in ${daysUntilDue} day${daysUntilDue > 1 ? 's' : ''}.`;\n    }\n\n    const payload: SendNotificationPayload = {\n      userId,\n      title,\n      message,\n      type,\n      data: {\n        amount,\n        dueDate: dueDate.toISOString(),\n        daysUntilDue,\n      },\n    };\n\n    await this.sendMultiChannelNotification(payload, userEmail, userPhone, pushToken);\n  }\n}\n\n"],"names":["NotificationSenderService","sendMultiChannelNotification","payload","userEmail","userPhone","pushToken","logger","log","type","userId","results","push","email","sms","BUSINESS_RULES","NOTIFICATION_CHANNELS","PUSH","enabled","sendPushNotification","success","warn","error","EMAIL","firstName","data","sendEmailNotification","isOverdueNotification","NotificationType","PAYMENT_OVERDUE","SMS","overdueOnly","sendSMSNotification","successCount","Object","values","filter","r","length","attemptCount","substring","notificationsService","sendPushNotificationToToken","title","message","receiptId","Date","now","Math","random","toString","stack","emailService","sendPaymentReminderEmail","amount","dueDate","messageId","phone","mockMessageId","formatEmailHTML","urgencyColor","PAYMENT_REMINDER","PAYMENT_SUCCESS","toLocaleDateString","process","env","MOBILE_APP_DEEP_LINK","getFullYear","sendPaymentReminder","daysUntilDue","daysOverdue","abs","toISOString","Logger","name","NotificationsService"],"mappings":"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"}