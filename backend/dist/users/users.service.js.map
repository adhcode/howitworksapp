{"version":3,"sources":["../../src/users/users.service.ts"],"sourcesContent":["import { Injectable, Inject, NotFoundException } from '@nestjs/common';\nimport { eq } from 'drizzle-orm';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { users, NewUser, User } from '../database/schema';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    @Inject(DATABASE_CONNECTION) private readonly db: any,\n  ) {}\n\n  async create(userData: NewUser): Promise<User> {\n    const [user] = await this.db.insert(users).values(userData).returning();\n    return user;\n  }\n\n  async findById(id: string): Promise<User | null> {\n    const [user] = await this.db.select().from(users).where(eq(users.id, id));\n    return user || null;\n  }\n\n  async findByEmail(email: string): Promise<User | null> {\n    const [user] = await this.db.select().from(users).where(eq(users.email, email));\n    return user || null;\n  }\n\n  async findAll(): Promise<User[]> {\n    return this.db.select().from(users);\n  }\n\n  async findTenants(): Promise<User[]> {\n    return this.db.select().from(users).where(eq(users.role, 'tenant'));\n  }\n\n  async findLandlords(): Promise<User[]> {\n    return this.db.select().from(users).where(eq(users.role, 'landlord'));\n  }\n\n  async update(id: string, userData: Partial<User>): Promise<User> {\n    const [updatedUser] = await this.db\n      .update(users)\n      .set({ ...userData, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      throw new NotFoundException('User not found');\n    }\n\n    return updatedUser;\n  }\n\n  async findByEmailVerificationToken(token: string): Promise<User | null> {\n    const [user] = await this.db\n      .select()\n      .from(users)\n      .where(eq(users.emailVerificationToken, token));\n    return user || null;\n  }\n\n  async verifyEmail(id: string): Promise<User> {\n    const [updatedUser] = await this.db\n      .update(users)\n      .set({ \n        isEmailVerified: true, \n        emailVerificationToken: null,\n        emailVerificationCode: null,\n        emailVerificationCodeExpires: null,\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      throw new NotFoundException('User not found');\n    }\n\n    return updatedUser;\n  }\n\n  async updateEmailVerificationToken(id: string, token: string): Promise<User> {\n    const [updatedUser] = await this.db\n      .update(users)\n      .set({ \n        emailVerificationToken: token,\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      throw new NotFoundException('User not found');\n    }\n\n    return updatedUser;\n  }\n\n  async updateEmailVerificationCode(id: string, code: string, expiresAt: Date): Promise<User> {\n    const [updatedUser] = await this.db\n      .update(users)\n      .set({ \n        emailVerificationCode: code,\n        emailVerificationCodeExpires: expiresAt,\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      throw new NotFoundException('User not found');\n    }\n\n    return updatedUser;\n  }\n\n  async updateLastLogin(id: string): Promise<void> {\n    await this.db\n      .update(users)\n      .set({ \n        lastLoginAt: new Date(),\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id));\n  }\n\n  async delete(id: string): Promise<void> {\n    const result = await this.db.delete(users).where(eq(users.id, id));\n    if (result.rowCount === 0) {\n      throw new NotFoundException('User not found');\n    }\n  }\n\n  async findByPasswordResetToken(token: string): Promise<User | null> {\n    const [user] = await this.db\n      .select()\n      .from(users)\n      .where(eq(users.passwordResetToken, token));\n    return user || null;\n  }\n\n  async updatePasswordResetToken(id: string, token: string, expiresAt: Date): Promise<User> {\n    const [updatedUser] = await this.db\n      .update(users)\n      .set({ \n        passwordResetToken: token,\n        passwordResetExpires: expiresAt,\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      throw new NotFoundException('User not found');\n    }\n\n    return updatedUser;\n  }\n\n  async clearPasswordResetToken(id: string): Promise<User> {\n    const [updatedUser] = await this.db\n      .update(users)\n      .set({ \n        passwordResetToken: null,\n        passwordResetExpires: null,\n        passwordResetCode: null,\n        passwordResetCodeExpires: null,\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      throw new NotFoundException('User not found');\n    }\n\n    return updatedUser;\n  }\n\n  async updatePasswordResetCode(id: string, code: string, expiresAt: Date): Promise<User> {\n    const [updatedUser] = await this.db\n      .update(users)\n      .set({ \n        passwordResetCode: code,\n        passwordResetCodeExpires: expiresAt,\n        updatedAt: new Date() \n      })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      throw new NotFoundException('User not found');\n    }\n\n    return updatedUser;\n  }\n\n  async findByPasswordResetCode(email: string, code: string): Promise<User | null> {\n    const [user] = await this.db\n      .select()\n      .from(users)\n      .where(eq(users.email, email));\n    \n    if (!user || user.passwordResetCode !== code) {\n      return null;\n    }\n    \n    return user;\n  }\n}"],"names":["UsersService","create","userData","user","db","insert","users","values","returning","findById","id","select","from","where","eq","findByEmail","email","findAll","findTenants","role","findLandlords","update","updatedUser","set","updatedAt","Date","NotFoundException","findByEmailVerificationToken","token","emailVerificationToken","verifyEmail","isEmailVerified","emailVerificationCode","emailVerificationCodeExpires","updateEmailVerificationToken","updateEmailVerificationCode","code","expiresAt","updateLastLogin","lastLoginAt","delete","result","rowCount","findByPasswordResetToken","passwordResetToken","updatePasswordResetToken","passwordResetExpires","clearPasswordResetToken","passwordResetCode","passwordResetCodeExpires","updatePasswordResetCode","findByPasswordResetCode"],"mappings":"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"}