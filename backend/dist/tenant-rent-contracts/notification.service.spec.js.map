{"version":3,"sources":["../../src/tenant-rent-contracts/notification.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { Logger } from '@nestjs/common';\nimport { NotificationService } from './notification.service';\nimport { EmailService } from '../email/email.service';\nimport { DATABASE_CONNECTION } from '../database/database.module';\n\n// Mock Expo SDK\nconst mockExpo = {\n  sendPushNotificationsAsync: jest.fn(),\n  chunkPushNotifications: jest.fn(),\n  isExpoPushToken: jest.fn(),\n};\n\njest.mock('expo-server-sdk', () => {\n  return {\n    Expo: jest.fn().mockImplementation(() => mockExpo),\n  };\n});\n\ndescribe('NotificationService', () => {\n  let service: NotificationService;\n  let emailService: jest.Mocked<EmailService>;\n  let mockDb: any;\n  let loggerSpy: jest.SpyInstance;\n\n  const mockContract = {\n    id: 'contract-123',\n    tenantId: 'tenant-123',\n    landlordId: 'landlord-123',\n    monthlyAmount: '2500.00',\n    nextPaymentDue: new Date('2024-02-01T00:00:00.000Z'),\n    expiryDate: new Date('2025-12-31T23:59:59.000Z'),\n  };\n\n  const mockTenant = {\n    id: 'tenant-123',\n    firstName: 'John',\n    lastName: 'Doe',\n    email: 'john.doe@example.com',\n    phoneNumber: '+1234567890',\n    expoPushToken: 'ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]',\n  };\n\n  beforeEach(async () => {\n    const mockEmailService = {\n      sendPaymentReminder: jest.fn(),\n      sendPaymentConfirmation: jest.fn(),\n      sendEscrowReleaseNotification: jest.fn(),\n    };\n\n    mockDb = {\n      select: jest.fn().mockReturnThis(),\n      from: jest.fn().mockReturnThis(),\n      where: jest.fn().mockReturnThis(),\n      insert: jest.fn().mockReturnThis(),\n      values: jest.fn().mockReturnThis(),\n      update: jest.fn().mockReturnThis(),\n      set: jest.fn().mockReturnThis(),\n      leftJoin: jest.fn().mockReturnThis(),\n      orderBy: jest.fn().mockReturnThis(),\n      limit: jest.fn().mockReturnThis(),\n    };\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        NotificationService,\n        { provide: EmailService, useValue: mockEmailService },\n        { provide: DATABASE_CONNECTION, useValue: mockDb },\n      ],\n    }).compile();\n\n    service = module.get<NotificationService>(NotificationService);\n    emailService = module.get(EmailService);\n\n    // Mock logger to avoid console output during tests\n    loggerSpy = jest.spyOn(Logger.prototype, 'log').mockImplementation();\n    jest.spyOn(Logger.prototype, 'error').mockImplementation();\n    jest.spyOn(Logger.prototype, 'warn').mockImplementation();\n    jest.spyOn(Logger.prototype, 'debug').mockImplementation();\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('schedulePaymentReminder', () => {\n    it('should schedule a payment reminder notification', async () => {\n      const scheduledFor = new Date('2024-01-29T09:00:00.000Z');\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n      \n      mockDb.insert.mockReturnValue(mockDb);\n      mockDb.values.mockResolvedValue({ success: true });\n\n      await service.schedulePaymentReminder(mockContract.id, scheduledFor, 'reminder');\n\n      expect(mockDb.insert).toHaveBeenCalled();\n      expect(mockDb.values).toHaveBeenCalledWith(\n        expect.objectContaining({\n          contractId: mockContract.id,\n          tenantId: mockContract.tenantId,\n          notificationType: 'reminder',\n          scheduledFor,\n          status: 'pending',\n        })\n      );\n    });\n\n    it('should handle different notification types', async () => {\n      const scheduledFor = new Date('2024-01-29T09:00:00.000Z');\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n      \n      mockDb.insert.mockReturnValue(mockDb);\n      mockDb.values.mockResolvedValue({ success: true });\n\n      // Test overdue notification\n      await service.schedulePaymentReminder(mockContract.id, scheduledFor, 'overdue');\n\n      expect(mockDb.values).toHaveBeenCalledWith(\n        expect.objectContaining({\n          notificationType: 'overdue',\n          title: expect.stringContaining('Overdue'),\n        })\n      );\n    });\n\n    it('should handle tenant not found', async () => {\n      const scheduledFor = new Date('2024-01-29T09:00:00.000Z');\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([]); // No tenant found\n\n      await expect(\n        service.schedulePaymentReminder(mockContract.id, scheduledFor, 'reminder')\n      ).rejects.toThrow('Tenant not found for contract: contract-123');\n    });\n\n    it('should generate appropriate notification content', async () => {\n      const scheduledFor = new Date('2024-01-29T09:00:00.000Z');\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n      \n      mockDb.insert.mockReturnValue(mockDb);\n      mockDb.values.mockResolvedValue({ success: true });\n\n      await service.schedulePaymentReminder(mockContract.id, scheduledFor, 'reminder');\n\n      expect(mockDb.values).toHaveBeenCalledWith(\n        expect.objectContaining({\n          title: 'Rent Payment Reminder',\n          message: expect.stringContaining('John'),\n          message: expect.stringContaining('2500'),\n        })\n      );\n    });\n  });\n\n  describe('sendImmediateNotification', () => {\n    beforeEach(() => {\n      mockExpo.isExpoPushToken.mockReturnValue(true);\n      mockExpo.chunkPushNotifications.mockReturnValue([\n        [{ to: mockTenant.expoPushToken, title: 'Test', body: 'Test message' }]\n      ]);\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'ok', id: 'notification-id-123' }\n      ]);\n    });\n\n    it('should send immediate push notification', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n\n      const result = await service.sendImmediateNotification(\n        mockContract.tenantId,\n        'Payment Successful',\n        'Your rent payment has been processed successfully.',\n        { contractId: mockContract.id }\n      );\n\n      expect(result.success).toBe(true);\n      expect(result.method).toBe('push');\n      expect(mockExpo.sendPushNotificationsAsync).toHaveBeenCalled();\n    });\n\n    it('should fallback to email if push token is invalid', async () => {\n      const tenantWithoutPushToken = { ...mockTenant, expoPushToken: null };\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([tenantWithoutPushToken]);\n\n      emailService.sendPaymentReminder.mockResolvedValue();\n\n      const result = await service.sendImmediateNotification(\n        mockContract.tenantId,\n        'Payment Successful',\n        'Your rent payment has been processed successfully.',\n        { contractId: mockContract.id }\n      );\n\n      expect(result.success).toBe(true);\n      expect(result.method).toBe('email');\n      expect(emailService.sendPaymentReminder).toHaveBeenCalled();\n    });\n\n    it('should handle push notification failures', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'error', message: 'DeviceNotRegistered' }\n      ]);\n\n      emailService.sendPaymentReminder.mockResolvedValue();\n\n      const result = await service.sendImmediateNotification(\n        mockContract.tenantId,\n        'Payment Successful',\n        'Your rent payment has been processed successfully.'\n      );\n\n      expect(result.success).toBe(true);\n      expect(result.method).toBe('email');\n      expect(emailService.sendPaymentReminder).toHaveBeenCalled();\n    });\n\n    it('should handle tenant not found', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([]);\n\n      await expect(\n        service.sendImmediateNotification(\n          'nonexistent-tenant',\n          'Test',\n          'Test message'\n        )\n      ).rejects.toThrow('Tenant not found: nonexistent-tenant');\n    });\n  });\n\n  describe('processPendingNotifications', () => {\n    const mockPendingNotifications = [\n      {\n        id: 'notification-1',\n        contractId: mockContract.id,\n        tenantId: mockContract.tenantId,\n        notificationType: 'reminder',\n        scheduledFor: new Date('2024-01-29T09:00:00.000Z'),\n        title: 'Rent Payment Reminder',\n        message: 'Your rent payment is due soon.',\n        status: 'pending',\n        tenant: mockTenant,\n      },\n      {\n        id: 'notification-2',\n        contractId: mockContract.id,\n        tenantId: mockContract.tenantId,\n        notificationType: 'overdue',\n        scheduledFor: new Date('2024-01-28T09:00:00.000Z'),\n        title: 'Rent Payment Overdue',\n        message: 'Your rent payment is overdue.',\n        status: 'pending',\n        tenant: mockTenant,\n      },\n    ];\n\n    beforeEach(() => {\n      mockExpo.isExpoPushToken.mockReturnValue(true);\n      mockExpo.chunkPushNotifications.mockReturnValue([\n        mockPendingNotifications.map(n => ({\n          to: mockTenant.expoPushToken,\n          title: n.title,\n          body: n.message,\n        }))\n      ]);\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'ok', id: 'receipt-1' },\n        { status: 'ok', id: 'receipt-2' },\n      ]);\n    });\n\n    it('should process pending notifications successfully', async () => {\n      const now = new Date('2024-01-29T10:00:00.000Z');\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.leftJoin.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue(mockPendingNotifications);\n\n      mockDb.update.mockReturnValue(mockDb);\n      mockDb.set.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue({ success: true });\n\n      const result = await service.processPendingNotifications(now);\n\n      expect(result.processed).toBe(2);\n      expect(result.successful).toBe(2);\n      expect(result.failed).toBe(0);\n      expect(mockExpo.sendPushNotificationsAsync).toHaveBeenCalled();\n    });\n\n    it('should handle mixed success and failure results', async () => {\n      const now = new Date('2024-01-29T10:00:00.000Z');\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.leftJoin.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue(mockPendingNotifications);\n\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'ok', id: 'receipt-1' },\n        { status: 'error', message: 'DeviceNotRegistered' },\n      ]);\n\n      mockDb.update.mockReturnValue(mockDb);\n      mockDb.set.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue({ success: true });\n\n      const result = await service.processPendingNotifications(now);\n\n      expect(result.processed).toBe(2);\n      expect(result.successful).toBe(1);\n      expect(result.failed).toBe(1);\n    });\n\n    it('should handle notifications without push tokens', async () => {\n      const now = new Date('2024-01-29T10:00:00.000Z');\n      const notificationsWithoutTokens = mockPendingNotifications.map(n => ({\n        ...n,\n        tenant: { ...mockTenant, expoPushToken: null },\n      }));\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.leftJoin.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue(notificationsWithoutTokens);\n\n      emailService.sendPaymentReminder.mockResolvedValue();\n\n      mockDb.update.mockReturnValue(mockDb);\n      mockDb.set.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue({ success: true });\n\n      const result = await service.processPendingNotifications(now);\n\n      expect(result.processed).toBe(2);\n      expect(result.successful).toBe(2);\n      expect(emailService.sendPaymentReminder).toHaveBeenCalledTimes(2);\n    });\n\n    it('should skip notifications not yet due', async () => {\n      const now = new Date('2024-01-28T08:00:00.000Z'); // Before scheduled time\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.leftJoin.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue([]);\n\n      const result = await service.processPendingNotifications(now);\n\n      expect(result.processed).toBe(0);\n      expect(result.successful).toBe(0);\n      expect(result.failed).toBe(0);\n    });\n  });\n\n  describe('sendPaymentConfirmation', () => {\n    const mockPaymentData = {\n      contractId: mockContract.id,\n      amount: 2500,\n      paymentMethod: 'card',\n      reference: 'payment-ref-123',\n      nextPaymentDue: new Date('2024-03-01T00:00:00.000Z'),\n    };\n\n    it('should send payment confirmation notification', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n\n      mockExpo.isExpoPushToken.mockReturnValue(true);\n      mockExpo.chunkPushNotifications.mockReturnValue([\n        [{ to: mockTenant.expoPushToken, title: 'Payment Confirmed', body: 'Payment processed' }]\n      ]);\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'ok', id: 'confirmation-receipt' }\n      ]);\n\n      const result = await service.sendPaymentConfirmation(mockContract.tenantId, mockPaymentData);\n\n      expect(result.success).toBe(true);\n      expect(result.method).toBe('push');\n      expect(mockExpo.sendPushNotificationsAsync).toHaveBeenCalled();\n    });\n\n    it('should include payment details in confirmation', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n\n      mockExpo.isExpoPushToken.mockReturnValue(true);\n      mockExpo.chunkPushNotifications.mockImplementation((notifications) => {\n        expect(notifications[0].body).toContain('2500');\n        expect(notifications[0].body).toContain('March 1, 2024');\n        return [notifications];\n      });\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'ok', id: 'confirmation-receipt' }\n      ]);\n\n      await service.sendPaymentConfirmation(mockContract.tenantId, mockPaymentData);\n\n      expect(mockExpo.chunkPushNotifications).toHaveBeenCalled();\n    });\n  });\n\n  describe('sendEscrowReleaseNotification', () => {\n    const mockEscrowData = {\n      landlordId: mockContract.landlordId,\n      releasedAmount: 15000,\n      contractId: mockContract.id,\n      releaseDate: new Date('2024-12-31T23:59:59.000Z'),\n    };\n\n    it('should send escrow release notification to landlord', async () => {\n      const mockLandlord = {\n        id: mockContract.landlordId,\n        firstName: 'Jane',\n        lastName: 'Smith',\n        email: 'jane.smith@example.com',\n        expoPushToken: 'ExponentPushToken[yyyyyyyyyyyyyyyyyyyyyy]',\n      };\n\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockLandlord]);\n\n      mockExpo.isExpoPushToken.mockReturnValue(true);\n      mockExpo.chunkPushNotifications.mockReturnValue([\n        [{ to: mockLandlord.expoPushToken, title: 'Escrow Released', body: 'Funds released' }]\n      ]);\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'ok', id: 'escrow-receipt' }\n      ]);\n\n      const result = await service.sendEscrowReleaseNotification(mockEscrowData);\n\n      expect(result.success).toBe(true);\n      expect(result.method).toBe('push');\n      expect(mockExpo.sendPushNotificationsAsync).toHaveBeenCalled();\n    });\n\n    it('should include escrow details in notification', async () => {\n      const mockLandlord = {\n        id: mockContract.landlordId,\n        firstName: 'Jane',\n        lastName: 'Smith',\n        email: 'jane.smith@example.com',\n        expoPushToken: 'ExponentPushToken[yyyyyyyyyyyyyyyyyyyyyy]',\n      };\n\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockLandlord]);\n\n      mockExpo.isExpoPushToken.mockReturnValue(true);\n      mockExpo.chunkPushNotifications.mockImplementation((notifications) => {\n        expect(notifications[0].body).toContain('15000');\n        expect(notifications[0].body).toContain('Jane');\n        return [notifications];\n      });\n      mockExpo.sendPushNotificationsAsync.mockResolvedValue([\n        { status: 'ok', id: 'escrow-receipt' }\n      ]);\n\n      await service.sendEscrowReleaseNotification(mockEscrowData);\n\n      expect(mockExpo.chunkPushNotifications).toHaveBeenCalled();\n    });\n  });\n\n  describe('getNotificationHistory', () => {\n    const mockNotificationHistory = [\n      {\n        id: 'notification-1',\n        contractId: mockContract.id,\n        tenantId: mockContract.tenantId,\n        notificationType: 'reminder',\n        title: 'Rent Payment Reminder',\n        status: 'sent',\n        sentAt: new Date('2024-01-29T09:00:00.000Z'),\n      },\n      {\n        id: 'notification-2',\n        contractId: mockContract.id,\n        tenantId: mockContract.tenantId,\n        notificationType: 'success',\n        title: 'Payment Confirmed',\n        status: 'sent',\n        sentAt: new Date('2024-01-30T10:00:00.000Z'),\n      },\n    ];\n\n    it('should get notification history for contract', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue(mockNotificationHistory);\n\n      const result = await service.getNotificationHistory(mockContract.id);\n\n      expect(result).toEqual(mockNotificationHistory);\n      expect(mockDb.where).toHaveBeenCalledWith(\n        expect.objectContaining({\n          contractId: mockContract.id,\n        })\n      );\n    });\n\n    it('should filter by notification type', async () => {\n      const reminderNotifications = [mockNotificationHistory[0]];\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue(reminderNotifications);\n\n      const result = await service.getNotificationHistory(mockContract.id, 'reminder');\n\n      expect(result).toEqual(reminderNotifications);\n    });\n\n    it('should handle empty history', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue([]);\n\n      const result = await service.getNotificationHistory('nonexistent-contract');\n\n      expect(result).toEqual([]);\n    });\n  });\n\n  describe('updateNotificationPreferences', () => {\n    const mockPreferences = {\n      enablePushNotifications: true,\n      enableEmailNotifications: false,\n      reminderDaysBefore: 3,\n      overdueReminderFrequency: 'daily',\n    };\n\n    it('should update user notification preferences', async () => {\n      mockDb.update.mockReturnValue(mockDb);\n      mockDb.set.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue({ success: true });\n\n      await service.updateNotificationPreferences(mockTenant.id, mockPreferences);\n\n      expect(mockDb.update).toHaveBeenCalled();\n      expect(mockDb.set).toHaveBeenCalledWith(\n        expect.objectContaining({\n          notificationPreferences: JSON.stringify(mockPreferences),\n        })\n      );\n    });\n\n    it('should handle preference update errors', async () => {\n      mockDb.update.mockReturnValue(mockDb);\n      mockDb.set.mockReturnValue(mockDb);\n      mockDb.where.mockRejectedValue(new Error('Update failed'));\n\n      await expect(\n        service.updateNotificationPreferences(mockTenant.id, mockPreferences)\n      ).rejects.toThrow('Update failed');\n    });\n  });\n\n  describe('error handling and edge cases', () => {\n    it('should handle Expo service unavailable', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([mockTenant]);\n\n      mockExpo.sendPushNotificationsAsync.mockRejectedValue(\n        new Error('Expo service unavailable')\n      );\n\n      emailService.sendPaymentReminder.mockResolvedValue();\n\n      const result = await service.sendImmediateNotification(\n        mockContract.tenantId,\n        'Test',\n        'Test message'\n      );\n\n      expect(result.success).toBe(true);\n      expect(result.method).toBe('email');\n      expect(emailService.sendPaymentReminder).toHaveBeenCalled();\n    });\n\n    it('should handle invalid push tokens gracefully', async () => {\n      const tenantWithInvalidToken = {\n        ...mockTenant,\n        expoPushToken: 'invalid-token-format',\n      };\n\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([tenantWithInvalidToken]);\n\n      mockExpo.isExpoPushToken.mockReturnValue(false);\n      emailService.sendPaymentReminder.mockResolvedValue();\n\n      const result = await service.sendImmediateNotification(\n        mockContract.tenantId,\n        'Test',\n        'Test message'\n      );\n\n      expect(result.success).toBe(true);\n      expect(result.method).toBe('email');\n    });\n\n    it('should handle database connection errors', async () => {\n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockRejectedValue(new Error('Database connection failed'));\n\n      await expect(\n        service.sendImmediateNotification(mockContract.tenantId, 'Test', 'Test message')\n      ).rejects.toThrow('Database connection failed');\n    });\n\n    it('should handle email service failures', async () => {\n      const tenantWithoutPushToken = { ...mockTenant, expoPushToken: null };\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue([tenantWithoutPushToken]);\n\n      emailService.sendPaymentReminder.mockRejectedValue(\n        new Error('Email service unavailable')\n      );\n\n      await expect(\n        service.sendImmediateNotification(mockContract.tenantId, 'Test', 'Test message')\n      ).rejects.toThrow('Email service unavailable');\n    });\n\n    it('should handle large batch notifications', async () => {\n      const now = new Date('2024-01-29T10:00:00.000Z');\n      const largeBatch = Array.from({ length: 1000 }, (_, i) => ({\n        ...mockPendingNotifications[0],\n        id: `notification-${i}`,\n      }));\n      \n      mockDb.select.mockReturnValue(mockDb);\n      mockDb.from.mockReturnValue(mockDb);\n      mockDb.leftJoin.mockReturnValue(mockDb);\n      mockDb.where.mockReturnValue(mockDb);\n      mockDb.orderBy.mockResolvedValue(largeBatch);\n\n      // Mock chunking behavior\n      mockExpo.chunkPushNotifications.mockImplementation((notifications) => {\n        const chunks = [];\n        for (let i = 0; i < notifications.length; i += 100) {\n          chunks.push(notifications.slice(i, i + 100));\n        }\n        return chunks;\n      });\n\n      mockExpo.sendPushNotificationsAsync.mockImplementation((chunk) => {\n        return Promise.resolve(chunk.map(() => ({ status: 'ok', id: 'receipt' })));\n      });\n\n      mockDb.update.mockReturnValue(mockDb);\n      mockDb.set.mockReturnValue(mockDb);\n      mockDb.where.mockResolvedValue({ success: true });\n\n      const result = await service.processPendingNotifications(now);\n\n      expect(result.processed).toBe(1000);\n      expect(result.successful).toBe(1000);\n      expect(mockExpo.sendPushNotificationsAsync).toHaveBeenCalledTimes(10); // 1000/100 chunks\n    });\n  });\n});"],"names":["mockExpo","sendPushNotificationsAsync","jest","fn","chunkPushNotifications","isExpoPushToken","mock","Expo","mockImplementation","describe","service","emailService","mockDb","loggerSpy","mockContract","id","tenantId","landlordId","monthlyAmount","nextPaymentDue","Date","expiryDate","mockTenant","firstName","lastName","email","phoneNumber","expoPushToken","beforeEach","mockEmailService","sendPaymentReminder","sendPaymentConfirmation","sendEscrowReleaseNotification","select","mockReturnThis","from","where","insert","values","update","set","leftJoin","orderBy","limit","module","Test","createTestingModule","providers","NotificationService","provide","EmailService","useValue","DATABASE_CONNECTION","compile","get","spyOn","Logger","prototype","afterEach","clearAllMocks","it","expect","toBeDefined","scheduledFor","mockReturnValue","mockResolvedValue","success","schedulePaymentReminder","toHaveBeenCalled","toHaveBeenCalledWith","objectContaining","contractId","notificationType","status","title","stringContaining","rejects","toThrow","message","to","body","result","sendImmediateNotification","toBe","method","tenantWithoutPushToken","mockPendingNotifications","tenant","map","n","now","processPendingNotifications","processed","successful","failed","notificationsWithoutTokens","toHaveBeenCalledTimes","mockPaymentData","amount","paymentMethod","reference","notifications","toContain","mockEscrowData","releasedAmount","releaseDate","mockLandlord","mockNotificationHistory","sentAt","getNotificationHistory","toEqual","reminderNotifications","mockPreferences","enablePushNotifications","enableEmailNotifications","reminderDaysBefore","overdueReminderFrequency","updateNotificationPreferences","notificationPreferences","JSON","stringify","mockRejectedValue","Error","tenantWithInvalidToken","largeBatch","Array","length","_","i","chunks","push","slice","chunk","Promise","resolve"],"mappings":"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"}