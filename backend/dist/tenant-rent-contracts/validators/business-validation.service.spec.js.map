{"version":3,"sources":["../../../src/tenant-rent-contracts/validators/business-validation.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { BusinessValidationService } from './business-validation.service';\nimport { ContractNotFoundError } from '../exceptions/contract-not-found.exception';\nimport { InvalidTransitionDateError } from '../exceptions/invalid-transition-date.exception';\nimport { EscrowReleaseError } from '../exceptions/escrow-release.exception';\n\ndescribe('BusinessValidationService', () => {\n  let service: BusinessValidationService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [BusinessValidationService],\n    }).compile();\n\n    service = module.get<BusinessValidationService>(BusinessValidationService);\n  });\n\n  describe('validateContractCreation', () => {\n    const baseContext = {\n      tenantId: 'tenant-123',\n      landlordId: 'landlord-123',\n      propertyId: 'property-123',\n      unitId: 'unit-123',\n      monthlyAmount: 25000,\n      expiryDate: new Date('2025-12-31'),\n      isExistingTenant: false,\n    };\n\n    it('should validate valid contract creation', () => {\n      expect(() => service.validateContractCreation(baseContext)).not.toThrow();\n    });\n\n    it('should throw error for past expiry date', () => {\n      const context = {\n        ...baseContext,\n        expiryDate: new Date('2023-01-01'),\n      };\n\n      expect(() => service.validateContractCreation(context))\n        .toThrow(InvalidTransitionDateError);\n    });\n\n    it('should throw error for low rent amount', () => {\n      const context = {\n        ...baseContext,\n        monthlyAmount: 500,\n      };\n\n      expect(() => service.validateContractCreation(context))\n        .toThrow(InvalidTransitionDateError);\n    });\n\n    it('should throw error for high rent amount', () => {\n      const context = {\n        ...baseContext,\n        monthlyAmount: 15000000,\n      };\n\n      expect(() => service.validateContractCreation(context))\n        .toThrow(InvalidTransitionDateError);\n    });\n\n    it('should require original expiry date for existing tenants', () => {\n      const context = {\n        ...baseContext,\n        isExistingTenant: true,\n      };\n\n      expect(() => service.validateContractCreation(context))\n        .toThrow(InvalidTransitionDateError);\n    });\n\n    it('should validate existing tenant with proper dates', () => {\n      const context = {\n        ...baseContext,\n        isExistingTenant: true,\n        originalExpiryDate: new Date('2024-06-30'),\n      };\n\n      expect(() => service.validateContractCreation(context)).not.toThrow();\n    });\n  });\n\n  describe('validatePaymentProcessing', () => {\n    const baseContext = {\n      contractId: 'contract-123',\n      amount: 25000,\n      expectedAmount: 25000,\n      contractStatus: 'active',\n      nextPaymentDue: new Date(),\n    };\n\n    it('should validate valid payment processing', () => {\n      expect(() => service.validatePaymentProcessing(baseContext)).not.toThrow();\n    });\n\n    it('should throw error for inactive contract', () => {\n      const context = {\n        ...baseContext,\n        contractStatus: 'expired',\n      };\n\n      expect(() => service.validatePaymentProcessing(context))\n        .toThrow(InvalidTransitionDateError);\n    });\n\n    it('should throw error for amount mismatch', () => {\n      const context = {\n        ...baseContext,\n        amount: 20000,\n      };\n\n      expect(() => service.validatePaymentProcessing(context))\n        .toThrow(InvalidTransitionDateError);\n    });\n\n    it('should throw error for early payment', () => {\n      const futureDate = new Date();\n      futureDate.setDate(futureDate.getDate() + 10);\n      \n      const context = {\n        ...baseContext,\n        nextPaymentDue: futureDate,\n      };\n\n      expect(() => service.validatePaymentProcessing(context))\n        .toThrow(InvalidTransitionDateError);\n    });\n  });\n\n  describe('validateEscrowRelease', () => {\n    const baseContext = {\n      escrowId: 'escrow-123',\n      landlordId: 'landlord-123',\n      contractId: 'contract-123',\n      totalEscrowed: 300000,\n      isReleased: false,\n      expectedReleaseDate: new Date('2024-01-01'),\n    };\n\n    it('should validate valid escrow release', () => {\n      expect(() => service.validateEscrowRelease(baseContext)).not.toThrow();\n    });\n\n    it('should throw error for already released escrow', () => {\n      const context = {\n        ...baseContext,\n        isReleased: true,\n      };\n\n      expect(() => service.validateEscrowRelease(context))\n        .toThrow(EscrowReleaseError);\n    });\n\n    it('should throw error for future release date', () => {\n      const futureDate = new Date();\n      futureDate.setFullYear(futureDate.getFullYear() + 1);\n      \n      const context = {\n        ...baseContext,\n        expectedReleaseDate: futureDate,\n      };\n\n      expect(() => service.validateEscrowRelease(context))\n        .toThrow(EscrowReleaseError);\n    });\n\n    it('should throw error for zero escrow amount', () => {\n      const context = {\n        ...baseContext,\n        totalEscrowed: 0,\n      };\n\n      expect(() => service.validateEscrowRelease(context))\n        .toThrow(EscrowReleaseError);\n    });\n  });\n\n  describe('validateTransitionDate', () => {\n    it('should calculate correct transition date for monthly payout', () => {\n      const expiryDate = new Date('2024-12-01');\n      const result = service.validateTransitionDate(expiryDate, 'monthly');\n      \n      const expected = new Date('2024-09-01');\n      expect(result.getMonth()).toBe(expected.getMonth());\n      expect(result.getFullYear()).toBe(expected.getFullYear());\n    });\n\n    it('should calculate correct transition date for yearly payout', () => {\n      const expiryDate = new Date('2024-12-01');\n      const result = service.validateTransitionDate(expiryDate, 'yearly');\n      \n      const expected = new Date('2024-06-01');\n      expect(result.getMonth()).toBe(expected.getMonth());\n      expect(result.getFullYear()).toBe(expected.getFullYear());\n    });\n\n    it('should return today if calculated date is in past', () => {\n      const today = new Date();\n      const nearFutureDate = new Date();\n      nearFutureDate.setMonth(today.getMonth() + 2);\n      \n      const result = service.validateTransitionDate(nearFutureDate, 'monthly');\n      \n      expect(result.getDate()).toBe(today.getDate());\n    });\n\n    it('should throw error for very close expiry date', () => {\n      const veryCloseDate = new Date();\n      veryCloseDate.setDate(veryCloseDate.getDate() + 15); // 15 days from now\n      \n      expect(() => service.validateTransitionDate(veryCloseDate, 'yearly'))\n        .toThrow(InvalidTransitionDateError);\n    });\n  });\n});"],"names":["describe","service","beforeEach","module","Test","createTestingModule","providers","BusinessValidationService","compile","get","baseContext","tenantId","landlordId","propertyId","unitId","monthlyAmount","expiryDate","Date","isExistingTenant","it","expect","validateContractCreation","not","toThrow","context","InvalidTransitionDateError","originalExpiryDate","contractId","amount","expectedAmount","contractStatus","nextPaymentDue","validatePaymentProcessing","futureDate","setDate","getDate","escrowId","totalEscrowed","isReleased","expectedReleaseDate","validateEscrowRelease","EscrowReleaseError","setFullYear","getFullYear","result","validateTransitionDate","expected","getMonth","toBe","today","nearFutureDate","setMonth","veryCloseDate"],"mappings":"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"}