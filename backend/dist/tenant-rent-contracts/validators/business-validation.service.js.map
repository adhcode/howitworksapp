{"version":3,"sources":["../../../src/tenant-rent-contracts/validators/business-validation.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { ContractNotFoundError } from '../exceptions/contract-not-found.exception';\nimport { InvalidTransitionDateError } from '../exceptions/invalid-transition-date.exception';\nimport { EscrowReleaseError } from '../exceptions/escrow-release.exception';\n\nexport interface ContractValidationContext {\n  tenantId: string;\n  landlordId: string;\n  propertyId: string;\n  unitId: string;\n  monthlyAmount: number;\n  expiryDate: Date;\n  isExistingTenant: boolean;\n  originalExpiryDate?: Date;\n}\n\nexport interface PaymentValidationContext {\n  contractId: string;\n  amount: number;\n  expectedAmount: number;\n  contractStatus: string;\n  nextPaymentDue: Date;\n}\n\nexport interface EscrowValidationContext {\n  escrowId: string;\n  landlordId: string;\n  contractId: string;\n  totalEscrowed: number;\n  isReleased: boolean;\n  expectedReleaseDate: Date;\n}\n\n@Injectable()\nexport class BusinessValidationService {\n  /**\n   * Validates contract creation business rules\n   */\n  validateContractCreation(context: ContractValidationContext): void {\n    this.validateContractDates(context);\n    this.validateExistingTenantRules(context);\n    this.validateRentAmount(context);\n  }\n\n  /**\n   * Validates payment processing business rules\n   */\n  validatePaymentProcessing(context: PaymentValidationContext): void {\n    this.validateContractExists(context.contractId);\n    this.validateContractStatus(context.contractStatus);\n    this.validatePaymentAmount(context.amount, context.expectedAmount);\n    this.validatePaymentTiming(context.nextPaymentDue);\n  }\n\n  /**\n   * Validates escrow release business rules\n   */\n  validateEscrowRelease(context: EscrowValidationContext): void {\n    this.validateEscrowExists(context.escrowId);\n    this.validateEscrowNotReleased(context.isReleased, context.escrowId);\n    this.validateEscrowReleaseDate(context.expectedReleaseDate, context.escrowId);\n    this.validateEscrowAmount(context.totalEscrowed, context.escrowId);\n  }\n\n  /**\n   * Validates transition date calculation\n   */\n  validateTransitionDate(expiryDate: Date, payoutType: 'monthly' | 'yearly'): Date {\n    const today = new Date();\n    const transitionDate = new Date(expiryDate);\n\n    // Calculate transition start based on payout type\n    if (payoutType === 'monthly') {\n      transitionDate.setMonth(transitionDate.getMonth() - 3);\n    } else {\n      transitionDate.setMonth(transitionDate.getMonth() - 6);\n    }\n\n    // Validate transition date is reasonable\n    if (transitionDate < today) {\n      const monthsFromNow = Math.ceil((expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24 * 30));\n      \n      if (monthsFromNow < 1) {\n        throw new InvalidTransitionDateError(\n          'Contract expiry date is too close to start transition period',\n          { expiryDate, payoutType, monthsFromNow }\n        );\n      }\n      \n      // If calculated date is in the past, start immediately\n      return today;\n    }\n\n    return transitionDate;\n  }\n\n  private validateContractDates(context: ContractValidationContext): void {\n    const today = new Date();\n    const expiryDate = new Date(context.expiryDate);\n\n    // Expiry date must be in the future\n    if (expiryDate <= today) {\n      throw new InvalidTransitionDateError(\n        'Contract expiry date must be in the future',\n        { expiryDate, today }\n      );\n    }\n\n    // For existing tenants, validate original expiry date\n    if (context.isExistingTenant) {\n      if (!context.originalExpiryDate) {\n        throw new InvalidTransitionDateError(\n          'Original expiry date is required for existing tenants'\n        );\n      }\n\n      const originalExpiry = new Date(context.originalExpiryDate);\n      \n      // New expiry must be after original expiry\n      if (expiryDate <= originalExpiry) {\n        throw new InvalidTransitionDateError(\n          'New expiry date must be after original expiry date',\n          { expiryDate, originalExpiryDate: originalExpiry }\n        );\n      }\n\n      // Original expiry should be within reasonable range (not too far in past/future)\n      const sixMonthsAgo = new Date();\n      sixMonthsAgo.setMonth(today.getMonth() - 6);\n      const sixMonthsFromNow = new Date();\n      sixMonthsFromNow.setMonth(today.getMonth() + 6);\n\n      if (originalExpiry < sixMonthsAgo || originalExpiry > sixMonthsFromNow) {\n        throw new InvalidTransitionDateError(\n          'Original expiry date must be within 6 months of today',\n          { originalExpiryDate: originalExpiry, validRange: { from: sixMonthsAgo, to: sixMonthsFromNow } }\n        );\n      }\n    }\n  }\n\n  private validateExistingTenantRules(context: ContractValidationContext): void {\n    if (context.isExistingTenant && !context.originalExpiryDate) {\n      throw new InvalidTransitionDateError(\n        'Original expiry date is required for existing tenants'\n      );\n    }\n\n    if (!context.isExistingTenant && context.originalExpiryDate) {\n      throw new InvalidTransitionDateError(\n        'Original expiry date should not be provided for new tenants'\n      );\n    }\n  }\n\n  private validateRentAmount(context: ContractValidationContext): void {\n    if (context.monthlyAmount < 1000) {\n      throw new InvalidTransitionDateError(\n        'Monthly rent amount is too low',\n        { monthlyAmount: context.monthlyAmount, minimum: 1000 }\n      );\n    }\n\n    if (context.monthlyAmount > 10000000) {\n      throw new InvalidTransitionDateError(\n        'Monthly rent amount is too high',\n        { monthlyAmount: context.monthlyAmount, maximum: 10000000 }\n      );\n    }\n  }\n\n  private validateContractExists(contractId: string): void {\n    if (!contractId) {\n      throw new ContractNotFoundError('Contract ID is required');\n    }\n  }\n\n  private validateContractStatus(status: string): void {\n    if (status !== 'active') {\n      throw new InvalidTransitionDateError(\n        `Cannot process payment for contract with status: ${status}`,\n        { status, allowedStatus: 'active' }\n      );\n    }\n  }\n\n  private validatePaymentAmount(amount: number, expectedAmount: number): void {\n    if (amount !== expectedAmount) {\n      throw new InvalidTransitionDateError(\n        'Payment amount does not match expected monthly rent',\n        { providedAmount: amount, expectedAmount }\n      );\n    }\n  }\n\n  private validatePaymentTiming(nextPaymentDue: Date): void {\n    const today = new Date();\n    const daysDifference = Math.ceil((nextPaymentDue.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n\n    // Allow payments up to 5 days early\n    if (daysDifference > 5) {\n      throw new InvalidTransitionDateError(\n        'Payment is too early. Payments can only be made up to 5 days before due date',\n        { nextPaymentDue, today, daysDifference }\n      );\n    }\n  }\n\n  private validateEscrowExists(escrowId: string): void {\n    if (!escrowId) {\n      throw new EscrowReleaseError('Escrow ID is required');\n    }\n  }\n\n  private validateEscrowNotReleased(isReleased: boolean, escrowId: string): void {\n    if (isReleased) {\n      throw new EscrowReleaseError(\n        'Escrow balance has already been released',\n        escrowId,\n        { isReleased }\n      );\n    }\n  }\n\n  private validateEscrowReleaseDate(expectedReleaseDate: Date, escrowId: string): void {\n    const today = new Date();\n    \n    if (expectedReleaseDate > today) {\n      throw new EscrowReleaseError(\n        'Escrow release date has not been reached yet',\n        escrowId,\n        { expectedReleaseDate, today }\n      );\n    }\n  }\n\n  private validateEscrowAmount(totalEscrowed: number, escrowId: string): void {\n    if (totalEscrowed <= 0) {\n      throw new EscrowReleaseError(\n        'No funds available in escrow for release',\n        escrowId,\n        { totalEscrowed }\n      );\n    }\n  }\n}"],"names":["BusinessValidationService","validateContractCreation","context","validateContractDates","validateExistingTenantRules","validateRentAmount","validatePaymentProcessing","validateContractExists","contractId","validateContractStatus","contractStatus","validatePaymentAmount","amount","expectedAmount","validatePaymentTiming","nextPaymentDue","validateEscrowRelease","validateEscrowExists","escrowId","validateEscrowNotReleased","isReleased","validateEscrowReleaseDate","expectedReleaseDate","validateEscrowAmount","totalEscrowed","validateTransitionDate","expiryDate","payoutType","today","Date","transitionDate","setMonth","getMonth","monthsFromNow","Math","ceil","getTime","InvalidTransitionDateError","isExistingTenant","originalExpiryDate","originalExpiry","sixMonthsAgo","sixMonthsFromNow","validRange","from","to","monthlyAmount","minimum","maximum","ContractNotFoundError","status","allowedStatus","providedAmount","daysDifference","EscrowReleaseError"],"mappings":"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"}