{"version":3,"sources":["../../src/properties/properties.service.ts"],"sourcesContent":["import { Injectable, Inject, NotFoundException, ForbiddenException } from '@nestjs/common';\nimport { eq, and } from 'drizzle-orm';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { properties, units, Property, NewProperty } from '../database/schema';\nimport { CreatePropertyDto, UpdatePropertyDto } from './dto/property.dto';\nimport { PaginationDto } from '../common/dto/pagination.dto';\n\n@Injectable()\nexport class PropertiesService {\n  constructor(\n    @Inject(DATABASE_CONNECTION) private readonly db: any,\n  ) {}\n\n  async create(landlordId: string, createPropertyDto: CreatePropertyDto): Promise<Property> {\n    const propertyData: NewProperty = {\n      ...createPropertyDto,\n      landlordId,\n    };\n\n    const [property] = await this.db.insert(properties).values(propertyData).returning();\n    return property;\n  }\n\n  async findAll(landlordId: string, pagination: PaginationDto): Promise<{ data: Property[]; total: number }> {\n    const { page = 1, limit = 10 } = pagination;\n    const offset = (page - 1) * limit;\n\n    const [data, totalResult] = await Promise.all([\n      this.db\n        .select()\n        .from(properties)\n        .where(eq(properties.landlordId, landlordId))\n        .limit(limit)\n        .offset(offset)\n        .orderBy(properties.createdAt),\n      this.db\n        .select({ count: properties.id })\n        .from(properties)\n        .where(eq(properties.landlordId, landlordId)),\n    ]);\n\n    return {\n      data,\n      total: totalResult.length,\n    };\n  }\n\n  async findOne(id: string, landlordId: string): Promise<Property> {\n    const [property] = await this.db\n      .select()\n      .from(properties)\n      .where(and(eq(properties.id, id), eq(properties.landlordId, landlordId)));\n\n    if (!property) {\n      throw new NotFoundException('Property not found');\n    }\n\n    return property;\n  }\n\n  async findWithUnits(id: string, landlordId: string) {\n    const property = await this.findOne(id, landlordId);\n    \n    const propertyUnits = await this.db\n      .select()\n      .from(units)\n      .where(eq(units.propertyId, id))\n      .orderBy(units.unitNumber);\n\n    return {\n      ...property,\n      units: propertyUnits,\n    };\n  }\n\n  async update(id: string, landlordId: string, updatePropertyDto: UpdatePropertyDto): Promise<Property> {\n    // Verify ownership\n    await this.findOne(id, landlordId);\n\n    const [updatedProperty] = await this.db\n      .update(properties)\n      .set({ ...updatePropertyDto, updatedAt: new Date() })\n      .where(eq(properties.id, id))\n      .returning();\n\n    return updatedProperty;\n  }\n\n  async remove(id: string, landlordId: string): Promise<void> {\n    // Verify ownership\n    await this.findOne(id, landlordId);\n\n    // Delete associated units first\n    await this.db.delete(units).where(eq(units.propertyId, id));\n    \n    // Delete property\n    await this.db.delete(properties).where(eq(properties.id, id));\n  }\n\n  async getStats(landlordId: string) {\n    const [propertiesCount, unitsCount, occupiedUnits] = await Promise.all([\n      this.db\n        .select({ count: properties.id })\n        .from(properties)\n        .where(eq(properties.landlordId, landlordId)),\n      this.db\n        .select({ count: units.id })\n        .from(units)\n        .innerJoin(properties, eq(units.propertyId, properties.id))\n        .where(eq(properties.landlordId, landlordId)),\n      this.db\n        .select({ count: units.id })\n        .from(units)\n        .innerJoin(properties, eq(units.propertyId, properties.id))\n        .where(and(\n          eq(properties.landlordId, landlordId),\n          eq(units.isAvailable, false)\n        )),\n    ]);\n\n    return {\n      totalProperties: propertiesCount.length,\n      totalUnits: unitsCount.length,\n      occupiedUnits: occupiedUnits.length,\n      vacantUnits: unitsCount.length - occupiedUnits.length,\n    };\n  }\n}"],"names":["PropertiesService","create","landlordId","createPropertyDto","propertyData","property","db","insert","properties","values","returning","findAll","pagination","page","limit","offset","data","totalResult","Promise","all","select","from","where","eq","orderBy","createdAt","count","id","total","length","findOne","and","NotFoundException","findWithUnits","propertyUnits","units","propertyId","unitNumber","update","updatePropertyDto","updatedProperty","set","updatedAt","Date","remove","delete","getStats","propertiesCount","unitsCount","occupiedUnits","innerJoin","isAvailable","totalProperties","totalUnits","vacantUnits"],"mappings":"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"}