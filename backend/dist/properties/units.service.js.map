{"version":3,"sources":["../../src/properties/units.service.ts"],"sourcesContent":["import { Injectable, Inject, NotFoundException } from '@nestjs/common';\nimport { eq, and } from 'drizzle-orm';\nimport { DATABASE_CONNECTION } from '../database/database.module';\nimport { units, properties, Unit, NewUnit } from '../database/schema';\nimport { CreateUnitDto, UpdateUnitDto } from './dto/unit.dto';\n\n@Injectable()\nexport class UnitsService {\n  constructor(\n    @Inject(DATABASE_CONNECTION) private readonly db: any,\n  ) {}\n\n  async create(propertyId: string, landlordId: string, createUnitDto: CreateUnitDto): Promise<Unit> {\n    // Debug logging to see what data is received\n    console.log('üîç Backend - CreateUnitDto received:', createUnitDto);\n    console.log('üîç Backend - Rent value:', createUnitDto.rent, 'typeof:', typeof createUnitDto.rent);\n    \n    // Verify property ownership\n    const [property] = await this.db\n      .select()\n      .from(properties)\n      .where(and(eq(properties.id, propertyId), eq(properties.landlordId, landlordId)));\n\n    if (!property) {\n      throw new NotFoundException('Property not found');\n    }\n\n    // Ensure numeric values are properly handled\n    const rentValue = Number(createUnitDto.rent);\n    const bathroomsValue = Number(createUnitDto.bathrooms);\n    const squareFootageValue = createUnitDto.squareFootage ? Number(createUnitDto.squareFootage) : null;\n    const depositValue = createUnitDto.deposit ? Number(createUnitDto.deposit) : null;\n\n    const unitData: NewUnit = {\n      propertyId,\n      unitNumber: createUnitDto.unitNumber,\n      bedrooms: createUnitDto.bedrooms,\n      bathrooms: isNaN(bathroomsValue) ? '1' : bathroomsValue.toString(),\n      squareFootage: squareFootageValue != null && !isNaN(squareFootageValue) ? squareFootageValue.toString() : null,\n      rent: isNaN(rentValue) ? '0' : rentValue.toString(),\n      deposit: depositValue != null && !isNaN(depositValue) ? depositValue.toString() : null,\n      description: createUnitDto.description,\n      images: createUnitDto.images,\n      amenities: createUnitDto.amenities,\n    };\n    \n    console.log('üîç Backend - Unit data to be saved:', unitData);\n\n    const [unit] = await this.db.insert(units).values(unitData).returning();\n    return unit;\n  }\n\n  async findAll(propertyId: string, landlordId: string): Promise<Unit[]> {\n    // Verify property ownership\n    const [property] = await this.db\n      .select()\n      .from(properties)\n      .where(and(eq(properties.id, propertyId), eq(properties.landlordId, landlordId)));\n\n    if (!property) {\n      throw new NotFoundException('Property not found');\n    }\n\n    return this.db\n      .select()\n      .from(units)\n      .where(eq(units.propertyId, propertyId))\n      .orderBy(units.unitNumber);\n  }\n\n  async findOne(id: string, landlordId: string): Promise<Unit> {\n    const [unit] = await this.db\n      .select({\n        id: units.id,\n        propertyId: units.propertyId,\n        unitNumber: units.unitNumber,\n        bedrooms: units.bedrooms,\n        bathrooms: units.bathrooms,\n        squareFootage: units.squareFootage,\n        rent: units.rent,\n        deposit: units.deposit,\n        description: units.description,\n        images: units.images,\n        amenities: units.amenities,\n        isAvailable: units.isAvailable,\n        createdAt: units.createdAt,\n        updatedAt: units.updatedAt,\n      })\n      .from(units)\n      .innerJoin(properties, eq(units.propertyId, properties.id))\n      .where(and(eq(units.id, id), eq(properties.landlordId, landlordId)));\n\n    if (!unit) {\n      throw new NotFoundException('Unit not found');\n    }\n\n    return unit;\n  }\n\n  async update(id: string, landlordId: string, updateUnitDto: UpdateUnitDto): Promise<Unit> {\n    // Verify ownership\n    await this.findOne(id, landlordId);\n\n    const updateData: any = {\n      ...updateUnitDto,\n      updatedAt: new Date(),\n    };\n\n    // Convert number fields to strings for decimal columns\n    if (updateUnitDto.bathrooms !== undefined) {\n      updateData.bathrooms = updateUnitDto.bathrooms.toString();\n    }\n    if (updateUnitDto.squareFootage !== undefined) {\n      updateData.squareFootage = updateUnitDto.squareFootage.toString();\n    }\n    if (updateUnitDto.rent !== undefined) {\n      updateData.rent = updateUnitDto.rent.toString();\n    }\n    if (updateUnitDto.deposit !== undefined) {\n      updateData.deposit = updateUnitDto.deposit.toString();\n    }\n\n    const [updatedUnit] = await this.db\n      .update(units)\n      .set(updateData)\n      .where(eq(units.id, id))\n      .returning();\n\n    return updatedUnit;\n  }\n\n  async remove(id: string, landlordId: string): Promise<void> {\n    // Verify ownership\n    await this.findOne(id, landlordId);\n\n    await this.db.delete(units).where(eq(units.id, id));\n  }\n\n  async getAvailableUnits(propertyId: string, landlordId: string): Promise<Unit[]> {\n    // Verify property ownership\n    const [property] = await this.db\n      .select()\n      .from(properties)\n      .where(and(eq(properties.id, propertyId), eq(properties.landlordId, landlordId)));\n\n    if (!property) {\n      throw new NotFoundException('Property not found');\n    }\n\n    return this.db\n      .select()\n      .from(units)\n      .where(and(eq(units.propertyId, propertyId), eq(units.isAvailable, true)))\n      .orderBy(units.unitNumber);\n  }\n}"],"names":["UnitsService","create","propertyId","landlordId","createUnitDto","console","log","rent","property","db","select","from","properties","where","and","eq","id","NotFoundException","rentValue","Number","bathroomsValue","bathrooms","squareFootageValue","squareFootage","depositValue","deposit","unitData","unitNumber","bedrooms","isNaN","toString","description","images","amenities","unit","insert","units","values","returning","findAll","orderBy","findOne","isAvailable","createdAt","updatedAt","innerJoin","update","updateUnitDto","updateData","Date","undefined","updatedUnit","set","remove","delete","getAvailableUnits"],"mappings":"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"}