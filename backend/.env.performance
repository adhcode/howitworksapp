# Database Performance Configuration for Tenant Rent Contracts
# Copy these settings to your .env file and adjust values based on your environment

# ============================================================================
# CONNECTION POOL CONFIGURATION
# ============================================================================

# Standard connection pool settings
DB_POOL_MAX=30
DB_POOL_MIN=5
DB_IDLE_TIMEOUT=30000
DB_CONNECT_TIMEOUT=10000
DB_ACQUIRE_TIMEOUT=60000

# Tenant contract optimized pool settings (higher throughput)
DB_TENANT_POOL_MAX=40
DB_TENANT_POOL_MIN=8
DB_TENANT_ACQUIRE_TIMEOUT=45000
DB_TENANT_CREATE_TIMEOUT=20000
DB_TENANT_REAP_INTERVAL=500
DB_TENANT_IDLE_TIMEOUT=20000

# ============================================================================
# QUERY PERFORMANCE CONFIGURATION
# ============================================================================

# Query logging and monitoring
DB_QUERY_LOGGING=false
DB_SLOW_QUERY_THRESHOLD=100
DB_METRICS_HISTORY_SIZE=1000
DB_ENABLE_PREPARED_STATEMENTS=true
DB_ENABLE_QUERY_OPTIMIZATION=true

# Performance monitoring
DB_ENABLE_PERFORMANCE_MONITORING=true
DB_MONITORING_INTERVAL=30000
DB_POOL_MONITORING_INTERVAL=30000

# ============================================================================
# ALERT THRESHOLDS
# ============================================================================

# Performance alert thresholds
DB_ALERT_SLOW_QUERY_MS=1000
DB_ALERT_HIGH_UTILIZATION_PERCENT=80
DB_ALERT_MAX_WAITING_CLIENTS=10

# ============================================================================
# POSTGRESQL OPTIMIZATION SETTINGS
# ============================================================================

# Memory settings (adjust based on available system memory)
DB_WORK_MEM=4MB
DB_MAINTENANCE_WORK_MEM=64MB
DB_EFFECTIVE_CACHE_SIZE=1GB

# Query optimization settings
DB_RANDOM_PAGE_COST=1.1
DB_LOG_MIN_DURATION=100
DB_LOG_STATEMENT=none

# Lock and timeout settings
DB_DEADLOCK_TIMEOUT=1s
DB_LOCK_TIMEOUT=30s

# Checkpoint and WAL settings
DB_CHECKPOINT_COMPLETION_TARGET=0.9
DB_WAL_BUFFERS=16MB

# ============================================================================
# TENANT CONTRACT SPECIFIC SETTINGS
# ============================================================================

# Scheduler performance settings
SCHEDULER_BATCH_SIZE=100
SCHEDULER_QUERY_TIMEOUT=30000
SCHEDULER_MAX_CONCURRENT_OPERATIONS=5

# Payment processing settings
PAYMENT_QUERY_CACHE_TTL=300000
PAYMENT_BATCH_SIZE=50
PAYMENT_MAX_RETRY_ATTEMPTS=3

# Escrow processing settings
ESCROW_QUERY_CACHE_TTL=600000
ESCROW_BATCH_SIZE=25
ESCROW_RELEASE_TIMEOUT=60000

# Notification processing settings
NOTIFICATION_BATCH_SIZE=200
NOTIFICATION_QUERY_TIMEOUT=15000
NOTIFICATION_RETRY_INTERVAL=5000

# ============================================================================
# MAINTENANCE AND MONITORING
# ============================================================================

# Maintenance scheduling
DB_MAINTENANCE_ENABLED=true
DB_MAINTENANCE_SCHEDULE=0 2 * * *
DB_AUTO_VACUUM_ENABLED=true
DB_AUTO_ANALYZE_ENABLED=true

# Index maintenance
DB_INDEX_MAINTENANCE_ENABLED=true
DB_INDEX_USAGE_THRESHOLD=100
DB_UNUSED_INDEX_CHECK_INTERVAL=86400000

# Statistics maintenance
DB_STATISTICS_UPDATE_INTERVAL=3600000
DB_STATISTICS_TARGET_DEFAULT=1000
DB_STATISTICS_TARGET_HIGH=2000

# ============================================================================
# DEVELOPMENT VS PRODUCTION SETTINGS
# ============================================================================

# Development settings (NODE_ENV=development)
# - Lower connection pool sizes
# - More verbose logging
# - Shorter cache TTLs
# - More frequent maintenance

# Production settings (NODE_ENV=production)
# - Higher connection pool sizes
# - Minimal logging
# - Longer cache TTLs
# - Less frequent maintenance but more thorough

# ============================================================================
# MONITORING AND ALERTING
# ============================================================================

# Performance monitoring
ENABLE_QUERY_METRICS=true
ENABLE_CONNECTION_METRICS=true
ENABLE_INDEX_USAGE_TRACKING=true

# Alert destinations (configure based on your monitoring setup)
ALERT_WEBHOOK_URL=
ALERT_EMAIL_RECIPIENTS=
ALERT_SLACK_CHANNEL=

# Metric collection intervals
METRICS_COLLECTION_INTERVAL=60000
METRICS_RETENTION_DAYS=30
METRICS_AGGREGATION_INTERVAL=300000

# ============================================================================
# CACHE CONFIGURATION
# ============================================================================

# Query result caching
ENABLE_QUERY_CACHE=true
QUERY_CACHE_TTL=300000
QUERY_CACHE_MAX_SIZE=1000

# Application-level caching
ENABLE_APP_CACHE=true
APP_CACHE_TTL=600000
APP_CACHE_MAX_SIZE=5000

# ============================================================================
# BACKUP AND RECOVERY
# ============================================================================

# Backup settings for performance-critical data
BACKUP_TENANT_CONTRACTS=true
BACKUP_RETENTION_DAYS=90
BACKUP_COMPRESSION=true

# Point-in-time recovery settings
ENABLE_PITR=true
WAL_ARCHIVE_ENABLED=true
WAL_RETENTION_HOURS=168

# ============================================================================
# SECURITY AND COMPLIANCE
# ============================================================================

# Connection security
DB_SSL_ENABLED=true
DB_SSL_REJECT_UNAUTHORIZED=false
DB_CONNECTION_ENCRYPTION=true

# Query security
DB_ENABLE_QUERY_SANITIZATION=true
DB_LOG_SENSITIVE_DATA=false
DB_MASK_PERSONAL_DATA=true

# ============================================================================
# EXAMPLE CONFIGURATIONS BY ENVIRONMENT
# ============================================================================

# Small Development Environment (1-2 developers)
# DB_POOL_MAX=10
# DB_TENANT_POOL_MAX=15
# DB_QUERY_LOGGING=true
# DB_SLOW_QUERY_THRESHOLD=50

# Medium Staging Environment (testing load)
# DB_POOL_MAX=20
# DB_TENANT_POOL_MAX=30
# DB_QUERY_LOGGING=false
# DB_SLOW_QUERY_THRESHOLD=100

# Large Production Environment (high load)
# DB_POOL_MAX=50
# DB_TENANT_POOL_MAX=75
# DB_QUERY_LOGGING=false
# DB_SLOW_QUERY_THRESHOLD=200
# DB_ENABLE_PERFORMANCE_MONITORING=true

# ============================================================================
# NOTES AND RECOMMENDATIONS
# ============================================================================

# 1. Monitor connection pool utilization and adjust DB_POOL_MAX accordingly
# 2. Set DB_SLOW_QUERY_THRESHOLD based on your performance requirements
# 3. Enable query logging only in development or for debugging
# 4. Adjust cache TTLs based on your data update frequency
# 5. Monitor index usage and remove unused indexes periodically
# 6. Set up automated alerts for performance degradation
# 7. Regularly review and update statistics targets
# 8. Consider read replicas for heavy reporting workloads
# 9. Implement connection retry logic with exponential backoff
# 10. Use prepared statements for frequently executed queries